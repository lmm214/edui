<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>运动会照片合成</title>
  <style>
    html, body { margin:0; height:100%;
        overflow:hidden; }
    #ui { 
      position:fixed; 
      top:10px; 
      left:50%; 
      transform: translateX(-50%); 
      display:flex; 
      gap:12px; 
      z-index:10; 
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(45, 44, 44, 0.2);
      border-radius: 12px;
      padding: 8px 20px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1), 0 2px 8px rgba(0,0,0,0.05);
    }
    
    /* 比例选择器容器 */
    .ratio-selector {
      position: relative;
      display: inline-block;
    }
    
    /* 比例下拉菜单 */
    .ratio-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 12px;
      margin-top: 8px;
      overflow: hidden;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      min-width: 120px;
    }
    
    .ratio-dropdown.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    
    .ratio-option {
      padding: 12px 16px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      font: 14px/1 system-ui, -apple-system, Segoe UI, Arial;
      font-weight: 500;
      color: #333;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .ratio-option:last-child {
      border-bottom: none;
    }
    
    .ratio-option:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .ratio-option.active {
      background: rgba(255,255,255,0.4);
      color: #000;
    }
    
    button, label.btn {
      appearance: none;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.2);
      color:#333;
      padding:10px 16px;
      border-radius:12px;
      font: 14px/1 system-ui, -apple-system, Segoe UI, Arial;
      cursor:pointer;
      backdrop-filter: blur(10px);
      transition: all 0.2s ease;
      font-weight: 500;
    }
    button:hover, label.btn:hover { 
      background: rgba(255,255,255,0.35); 
      border-color: rgba(255,255,255,0.4);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    canvas { width:100vw; height:100vh; touch-action: none; display:block; }
  </style>
  <link rel="icon" href="data:,">
</head>
<body>
  <div id="ui">
    <input id="file" type="file" accept="image/*" hidden>
    <label class="btn" for="file">上传</label>
    <div class="ratio-selector">
      <button id="ratio">比例</button>
      <div class="ratio-dropdown" id="ratioDropdown">
        <div class="ratio-option" data-ratio="16:9">16:9</div>
        <div class="ratio-option" data-ratio="4:3">4:3</div>
        <div class="ratio-option" data-ratio="3:2">3:2</div>
        <div class="ratio-option" data-ratio="9:16">9:16</div>
        <div class="ratio-option" data-ratio="3:4">3:4</div>
        <div class="ratio-option" data-ratio="2:3">2:3</div>
        <div class="ratio-option" data-ratio="original">原图</div>
      </div>
    </div>
    <button id="download">下载</button>
  </div>
  <canvas id="c"></canvas>

  <script>
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d', { alpha: false, desynchronized: true });

  // 底部覆盖图
  const overlay = new Image();
  const overlay2 = new Image(); // 竖屏背景图
  overlay.src = 'ydh.png';
  overlay2.src = 'ydh-2.png';
  let overlayReady = false;
  let overlay2Ready = false;
  overlay.onload = () => { overlayReady = true; draw(); };
  overlay2.onload = () => { overlay2Ready = true; draw(); };

  // 上传的主图
  let img = null;
  let imgX = 0, imgY = 0, imgScale = 1;

  // 预览框比例和背景图选择
  let aspect = 16/9;
  let isPortrait = false; // 是否为竖屏比例
  const ratioPresets = [
    { name: '16:9', value: 16/9, portrait: false },
    { name: '4:3', value: 4/3, portrait: false },
    { name: '3:2', value: 3/2, portrait: false },
    { name: '9:16', value: 9/16, portrait: true },
    { name: '3:4', value: 3/4, portrait: true },
    { name: '2:3', value: 2/3, portrait: true }
  ];
  let ratioIndex = 0; // -1 表示原图比例
  const ratioBtn = document.getElementById('ratio');
  const ratioDropdown = document.getElementById('ratioDropdown');
  
  function updateRatioLabel() {
    if (!ratioBtn) return;
    if (ratioIndex >= 0) {
      ratioBtn.textContent = `比例 ${ratioPresets[ratioIndex].name}`;
    } else {
      ratioBtn.textContent = '比例 原图';
    }
  }
  updateRatioLabel();

  // 指针交互状态
  let dragging = false;
  let lastX = 0, lastY = 0;
  const pointers = new Map();
  let pinchInitial = null; // { dist, scale, midX, midY }

  function resize() {
    const w = window.innerWidth;
    const h = window.innerHeight;
    canvas.width = Math.floor(w * dpr);
    canvas.height = Math.floor(h * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // 使用 CSS 像素坐标绘制
    draw();
  }
  window.addEventListener('resize', resize);
  resize();

  function frameRect() {
    const cw = canvas.width / dpr;
    const ch = canvas.height / dpr;
    const pad = Math.max(24, Math.min(cw, ch) * 0.04);
    let w = cw - pad * 2;
    let h = w / aspect;
    if (h > ch - pad * 2) { h = ch - pad * 2; w = h * aspect; }
    const x = (cw - w) / 2;
    const y = (ch - h) / 2;
    return { x, y, w, h };
  }

  function fitImage(mode='cover') {
    if (!img) return;
    const f = frameRect();
    const iw = img.width, ih = img.height;
    const scaleContain = Math.min(f.w/iw, f.h/ih);
    const scaleCover = Math.max(f.w/iw, f.h/ih);
    imgScale = mode === 'contain' ? scaleContain : scaleCover;
    imgX = f.x + f.w/2;
    imgY = f.y + f.h/2;
    draw();
  }

  function draw() {
    const cw = canvas.width / dpr;
    const ch = canvas.height / dpr;
    ctx.clearRect(0, 0, cw, ch);
    // 页面背景为白色
    ctx.fillStyle = '#fff';
    ctx.fillRect(0, 0, cw, ch);

    const f = frameRect();

    // 立体阴影边框（圆角矩形）
    const r = Math.min(8, Math.min(f.w, f.h) * 0.04);
    function roundRectPath(x, y, w, h, rad) {
      const rr = Math.min(rad, w * 0.5, h * 0.5);
      ctx.beginPath();
      ctx.moveTo(x + rr, y);
      ctx.lineTo(x + w - rr, y);
      ctx.quadraticCurveTo(x + w, y, x + w, y + rr);
      ctx.lineTo(x + w, y + h - rr);
      ctx.quadraticCurveTo(x + w, y + h, x + w - rr, y + h);
      ctx.lineTo(x + rr, y + h);
      ctx.quadraticCurveTo(x, y + h, x, y + h - rr);
      ctx.lineTo(x, y + rr);
      ctx.quadraticCurveTo(x, y, x + rr, y);
    }

    // 阴影
    ctx.save();
    ctx.shadowColor = 'rgba(0,0,0,0.22)';
    ctx.shadowBlur = 28;
    ctx.shadowOffsetY = 12;
    roundRectPath(f.x, f.y, f.w, f.h, r);
    ctx.fillStyle = '#333';
    ctx.fill();
    ctx.restore();

    // 边框线
    ctx.save();
    roundRectPath(f.x, f.y, f.w, f.h, r);
    ctx.strokeStyle = 'rgba(0,0,0,0.12)';
    ctx.lineWidth = 1;
    ctx.stroke();
    ctx.restore();

    // 裁剪到预览框内并填充预览背景，确保画面与覆盖层对比清晰
    ctx.save();
    roundRectPath(f.x, f.y, f.w, f.h, r);
    ctx.clip();
    ctx.fillStyle = '#fefefe';
    ctx.fillRect(f.x, f.y, f.w, f.h);

    if (img) {
      ctx.save();
      ctx.translate(imgX, imgY);
      ctx.scale(imgScale, imgScale);
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(img, -img.width/2, -img.height/2);
      ctx.restore();
    }

    // 根据比例选择背景图
    const currentOverlay = isPortrait ? overlay2 : overlay;
    const currentOverlayReady = isPortrait ? overlay2Ready : overlayReady;
    
    if (currentOverlayReady) {
      const scale = f.w / currentOverlay.width;
      const targetH = currentOverlay.height * scale;
      ctx.drawImage(currentOverlay, f.x, f.y + f.h - targetH, f.w, targetH);
    }

    ctx.restore();
  }

  // 上传
  document.getElementById('file').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      const im = new Image();
      im.onload = () => {
        img = im;
        // 设置为原图比例，并判断是否为竖屏
        aspect = Math.max(im.width, im.height) / Math.min(im.width, im.height);
        isPortrait = im.height > im.width;
        ratioIndex = -1;
        updateRatioLabel();
        updateActiveOption();
        fitImage('cover');
      };
      im.src = reader.result;
    };
    reader.readAsDataURL(file);
  });

  // 点击画布也可触发上传
  canvas.addEventListener('click', () => {
    document.getElementById('file').click();
  });

  // 指针事件：拖拽与双指缩放
  canvas.addEventListener('pointerdown', (e) => {
    canvas.setPointerCapture(e.pointerId);
    pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });
    if (pointers.size === 1) {
      dragging = true;
      lastX = e.clientX; lastY = e.clientY;
    } else if (pointers.size === 2) {
      const pts = Array.from(pointers.values());
      const d = Math.hypot(pts[0].x-pts[1].x, pts[0].y-pts[1].y);
      const midX = (pts[0].x+pts[1].x)/2;
      const midY = (pts[0].y+pts[1].y)/2;
      pinchInitial = { dist: d, scale: imgScale, midX, midY };
    }
  });

  canvas.addEventListener('pointermove', (e) => {
    if (!pointers.has(e.pointerId)) return;
    pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });
    if (pointers.size === 1 && dragging && img) {
      const dx = e.clientX - lastX;
      const dy = e.clientY - lastY;
      imgX += dx; imgY += dy;
      lastX = e.clientX; lastY = e.clientY;
      draw();
    } else if (pointers.size === 2 && pinchInitial && img) {
      const pts = Array.from(pointers.values());
      const d = Math.hypot(pts[0].x-pts[1].x, pts[0].y-pts[1].y);
      const midX = (pts[0].x+pts[1].x)/2;
      const midY = (pts[0].y+pts[1].y)/2;
      const k = d / pinchInitial.dist;
      const newScale = clamp(pinchInitial.scale * k, 0.1, 20);
      zoomAroundPoint(midX, midY, newScale);
      draw();
    }
  });

  canvas.addEventListener('pointerup', (e) => {
    pointers.delete(e.pointerId);
    dragging = false;
    if (pointers.size < 2) pinchInitial = null;
  });
  canvas.addEventListener('pointercancel', (e) => {
    pointers.delete(e.pointerId);
    dragging = false;
    pinchInitial = null;
  });

  function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

  function zoomAroundPoint(px, py, newScale) {
    if (!img) return;
    const oldScale = imgScale;
    const ix = (px - imgX) / oldScale;
    const iy = (py - imgY) / oldScale;
    imgScale = clamp(newScale, 0.1, 20);
    imgX = px - ix * imgScale;
    imgY = py - iy * imgScale;
  }

  // 鼠标滚轮缩放
  canvas.addEventListener('wheel', (e) => {
    if (!img) return;
    e.preventDefault();
    const k = Math.pow(1.0015, -e.deltaY);
    const newScale = clamp(imgScale * k, 0.1, 20);
    zoomAroundPoint(e.clientX, e.clientY, newScale);
    draw();
  }, { passive: false });

  // 比例选择器交互
  let dropdownVisible = false;
  
  // 切换下拉菜单显示/隐藏
  ratioBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    dropdownVisible = !dropdownVisible;
    ratioDropdown.classList.toggle('show', dropdownVisible);
    updateActiveOption();
  });
  
  // 点击选项
  ratioDropdown.addEventListener('click', (e) => {
    const option = e.target.closest('.ratio-option');
    if (!option) return;
    
    const ratioValue = option.dataset.ratio;
    
    if (ratioValue === 'original') {
      // 原图比例
      ratioIndex = -1;
      if (img) {
        aspect = Math.max(img.width, img.height) / Math.min(img.width, img.height);
        isPortrait = img.height > img.width;
      }
    } else {
      // 预设比例
      const [w, h] = ratioValue.split(':').map(Number);
      aspect = w / h;
      isPortrait = w < h;
      
      // 找到对应的预设索引
      ratioIndex = ratioPresets.findIndex(preset => preset.value === aspect && preset.portrait === isPortrait);
    }
    
    updateRatioLabel();
    updateActiveOption();
    fitImage('cover');
    
    // 隐藏下拉菜单
    dropdownVisible = false;
    ratioDropdown.classList.remove('show');
  });
  
  // 点击其他地方隐藏下拉菜单
  document.addEventListener('click', () => {
    if (dropdownVisible) {
      dropdownVisible = false;
      ratioDropdown.classList.remove('show');
    }
  });
  
  // 更新活跃选项样式
  function updateActiveOption() {
    const options = ratioDropdown.querySelectorAll('.ratio-option');
    options.forEach(option => {
      option.classList.remove('active');
      
      if (ratioIndex === -1 && option.dataset.ratio === 'original') {
        option.classList.add('active');
      } else if (ratioIndex >= 0) {
        const preset = ratioPresets[ratioIndex];
        const [w, h] = option.dataset.ratio.split(':').map(Number);
        if (w && h && Math.abs((w/h) - preset.value) < 0.001 && preset.portrait === (w < h)) {
          option.classList.add('active');
        }
      }
    });
  }
  document.getElementById('download').addEventListener('click', () => {
    const f = frameRect();
    const out = document.createElement('canvas');
    out.width = Math.round(f.w * dpr);
    out.height = Math.round(f.h * dpr);
    const octx = out.getContext('2d', { alpha: false });
    octx.setTransform(dpr, 0, 0, dpr, 0, 0);
    octx.fillStyle = '#000';
    octx.fillRect(0, 0, f.w, f.h);
    if (img) {
      octx.save();
      octx.translate(imgX - f.x, imgY - f.y);
      octx.scale(imgScale, imgScale);
      octx.imageSmoothingEnabled = true;
      octx.imageSmoothingQuality = 'high';
      octx.drawImage(img, -img.width/2, -img.height/2);
      octx.restore();
    }
    // 根据比例选择背景图
    const currentOverlay = isPortrait ? overlay2 : overlay;
    const currentOverlayReady = isPortrait ? overlay2Ready : overlayReady;
    
    if (currentOverlayReady) {
      const scale = f.w / currentOverlay.width;
      const targetH = currentOverlay.height * scale;
      octx.drawImage(currentOverlay, 0, f.h - targetH, f.w, targetH);
    }
    const a = document.createElement('a');
    a.download = 'ydh.jpg';
    a.href = out.toDataURL('image/jpeg', 0.92);
    a.click();
  });
  </script>
</body>
</html>