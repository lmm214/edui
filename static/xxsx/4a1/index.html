<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å››å¹´çº§ä¸Šå†Œã€Šå¤§æ•°çš„è®¤è¯†ã€‹äº’åŠ¨è¯¾å ‚</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Noto Sans SC', 'Inter', sans-serif;
            background-image: radial-gradient(73% 147%, #EADFDF 59%, #ECE2DF 100%), radial-gradient(91% 146%, rgba(255,255,255,0.50) 47%, rgba(0,0,0,0.50) 100%); background-blend-mode: screen;
            color: #2d3748;
        }
        .activity-content { display: none; }
        .activity-content.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .nav-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #e2e8f0;
            font-size: 1rem;
            color: #64748b;
        }
        .nav-btn:hover { background-color: #f8fafc; border-color: #cbd5e1; }
        .nav-btn.active { color: #1e40af; background-color: #eff6ff; border-color: #3b82f6; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); border: 1px solid #e2e8f0; }
        .btn { display: inline-block; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; font-size: 1rem; color: white; background-color: #3b82f6; transition: all 0.2s ease; border: none; cursor: pointer; user-select: none; }
        .btn:hover { background-color: #2563eb; transform: translateY(-1px); }
        .feedback { min-height: 2rem; font-weight: 600; font-size: 1.25rem; transition: all 0.3s ease; }
        .correct { color: #059669; }
        .incorrect { color: #dc2626; }
        .section-title { font-size: 2.25rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem; }
        .section-subtitle { font-size: 1.125rem; color: #64748b; font-weight: 500; }
        .num-separator { display: none; border-left:2px dashed #888; height:3.5rem; margin: 0 -0.5px; vertical-align: middle; }
        .num-separator.visible { display: inline-block; }
        

        #numberComposer{max-width: 780px;margin: 0 auto;}
        /* Number Composer Styles */
        .composer-digit-wrapper { cursor: pointer; padding: 0.5rem; border-radius: 0.5rem; transition: background-color 0.2s; position: relative; background-color: #f1f5f9; }
        .composer-digit-wrapper:hover { background-color: #e2e8f0; }
        .composer-digit { background-color: white; border-radius: 0.375rem; padding: 1rem 0; font-size: 3rem; font-weight: 700; color: #1e293b; border: 1px solid #e2e8f0; }

        /* Popover Styles */
        #digitPopover {
            position: absolute;
            background-color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.2s ease;
        }
        #digitPopover.visible { opacity: 1; visibility: visible; transform: translateY(0); }
        .digit-wheel { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; }
        .digit-wheel-btn { width: 3rem; height: 3rem; font-size: 1.25rem; font-weight: 600; border-radius: 0.375rem; background-color: #f8fafc; color: #475569; cursor: pointer; transition: all 0.2s; display: flex; justify-content: center; align-items: center; border: 1px solid #e2e8f0; }
        .digit-wheel-btn:hover { background-color: #3b82f6; color: white; }

        /* Highlighted Chars */
        .highlight-unit { color: #dc2626; font-weight: 700; background-color: #fef2f2; padding: 0.125rem 0.25rem; border-radius: 0.25rem; }
        .highlight-ling { color: #1d4ed8; font-weight: 700; background-color: #eff6ff; padding: 0.125rem 0.25rem; border-radius: 0.25rem; }
        
        /* Comparison Button Styles */
        .comparison-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            background-color: #f8fafc;
            color: #475569;
            font-weight: 600;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 0.25rem;
            font-size: 0.875rem;
        }
        .comparison-btn:hover {
            background-color: #f1f5f9;
            border-color: #cbd5e1;
        }
        .comparison-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        

        /* Rounding Visual Styles */
        .rounding-digit {
            display: inline-block;
            padding: 0.25rem 0.375rem;
            margin: 0 0.125rem;
            border-radius: 0.25rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .rounding-digit.target.show {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }
        .rounding-digit.important.show {
             background-color: #eff6ff;
             color: #1e40af;
             border: 1px solid #3b82f6;
         }
         
         /* Auto-show animation for rounding help */
         #roundingRule {
             display: none;
             opacity: 0;
             transition: opacity 0.6s ease-in-out;
             color: #64748b;
             font-weight: 500;
             min-height: 2rem;
         }
         
         #roundingRule.show {
             display: block;
             opacity: 1;
         }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header -->
    <header>
        <div class="container mx-auto px-6 py-4">
            <h1 class="text-3xl font-bold text-gray-800 text-center mb-4">ğŸš€ å¤§æ•°æ¢é™©å®¶</h1>
            <nav id="main-nav" class="flex justify-center items-center space-x-2 md:space-x-4">
                <button data-target="reader" class="nav-btn active">ç»„æ•°è¯»æ•°</button>
                <button data-target="comparison" class="nav-btn">å¤§å°æ¯”è¾ƒ</button>
                <button data-target="rounding" class="nav-btn">è¿‘ä¼¼æ•°</button>
                <button data-target="visualization" class="nav-btn">æ„ŸçŸ¥å¤§æ•°</button>
            </nav>
        </div>
    </header>

    <main class="container mx-auto p-4 main-content">
        <!-- Section 1: Number Composer & Reader -->
        <section id="reader" class="activity-content active">
            <div class="card p-6 px-16 md:px-24 text-center">
                <h2 class="section-title mb-2">æ•°å­—é­”æ³•ç»„è£…æœº</h2>
                <p class="section-subtitle mb-8">ç‚¹å‡»æ•°ä½ï¼Œåœ¨ä¸‹æ–¹å¼¹å‡ºçš„è½¬ç›˜ä¸Šé€‰æ•°ï¼</p>
                <div id="numberComposer" class="grid grid-cols-5 md:grid-cols-9 gap-1 text-center mb-6"></div>
                <div class="text-3xl md:text-4xl font-bold my-6 p-4 bg-gray-50 rounded-lg flex items-center justify-center border border-gray-200 cursor-pointer" id="composedNumberDisplay" title="ç‚¹å‡»æ˜¾ç¤º/éšè—æ•°ä½åˆ†éš”ç¬¦">0</div>
                <div id="numberOutput" class="feedback text-2xl md:text-3xl text-gray-700 p-4 bg-gray-50 rounded-lg cursor-pointer border border-gray-200" title="ç‚¹å‡»æ˜¾ç¤ºè¯»éŸ³æˆ–é«˜äº®/å–æ¶ˆé«˜äº®'é›¶'å­—">é›¶</div>
                <div class="mt-6 space-x-4">
                    <button id="clearComposerBtn" class="btn">å…¨éƒ¨æ¸…é›¶</button>
                    <button id="randomComposerBtn" class="btn">éšæœºç»„æ•°</button>
                </div>
            </div>
        </section>

        <!-- Section 2: Number Comparison Game -->
        <section id="comparison" class="activity-content">
             <div class="card p-6 md:p-10 text-center">
                <h2 class="section-title mb-2">æ¯”å¤§å°æŒ‘æˆ˜</h2>
                <p class="section-subtitle mb-8">é€‰å‡ºä¸¤ä¸ªæ•°ä¸­æ›´å¤§çš„é‚£ä¸ªï¼</p>
                <div class="flex justify-center items-center space-x-2 md:space-x-4 mb-6 px-24">
                    <button id="num1Btn" class="text-4xl md:text-5xl font-bold p-4 md:p-6 rounded-lg bg-gray-50 hover:bg-gray-100 transition w-1/2 flex items-center justify-center h-32 border-2 border-gray-200 hover:border-blue-300 text-gray-700"></button>
                    <button id="num2Btn" class="text-4xl md:text-5xl font-bold p-4 md:p-6 rounded-lg bg-gray-50 hover:bg-gray-100 transition w-1/2 flex items-center justify-center h-32 border-2 border-gray-200 hover:border-blue-300 text-gray-700"></button>
                </div>
                <button id="startComparison" class="btn mb-4">æ¢ä¸€é¢˜</button>
                <div id="comparisonFeedback" class="feedback"></div>
            </div>
        </section>

        <!-- Section 4: Enhanced Rounding Off Challenge -->
        <section id="rounding" class="activity-content">
            <div class="card p-6 md:p-10 text-center">
                <h2 class="section-title mb-2">å››èˆäº”å…¥ç¥å°„æ‰‹</h2>
                <p class="section-subtitle mb-8">å°†ä¸‹é¢çš„æ•°çœç•¥"ä¸‡"ä½åé¢çš„å°¾æ•°ï¼Œé€‰æ‹©æ­£ç¡®çš„è¿‘ä¼¼æ•°ï¼</p>
                
                <!-- Number Display with Visual Helper -->
                 <div class="mb-6 p-6 bg-gray-50 rounded-lg border border-gray-200">
                     <div id="roundingNumber" class="text-3xl md:text-4xl font-bold mb-4 text-center text-gray-800"></div>
                 </div>
                <div id="roundingOptions" class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6"></div>
                <button id="nextRoundingBtn" class="btn w-full md:w-auto mt-6">æ¢ä¸€é¢˜</button>
                <div id="roundingFeedback" class="feedback mt-4"></div>
            </div>
        </section>

        <!-- Section 5: Enhanced Visualization of Big Numbers -->
        <section id="visualization" class="activity-content">
            <div class="card p-6 md:p-10 text-center">
                <h2 class="section-title mb-2">1äº¿åˆ°åº•æœ‰å¤šå¤§ï¼Ÿ</h2>
                <p class="section-subtitle mb-8">è®©æˆ‘ä»¬ç”¨ç†Ÿæ‚‰çš„äº‹ç‰©æ¥æ„Ÿå—ä¸€ä¸‹"1äº¿"è¿™ä¸ªæ•°å­—å§ï¼</p>
                
                <!-- Dynamic Visualization Display -->
                <div id="visualizationDisplay" class="mb-8">
                    <div class="grid md:grid-cols-3 lg:grid-cols-5 gap-6 text-left">
                        <div class="p-6 bg-gray-50 rounded-lg border border-gray-200"><h3 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">ğŸ“š 1äº¿å¼ çº¸</h3><p class="text-gray-600 text-lg md:text-xl">å¦‚æœæŠŠ1äº¿å¼ A4çº¸å åœ¨ä¸€èµ·ï¼Œå¤§çº¦æœ‰ <strong class="text-2xl md:text-3xl text-blue-600">10åƒç±³</strong>é«˜ï¼Œæ¯”ç ç©†æœ—ç›å³°è¿˜è¦é«˜ï¼</p></div>
                        <div class="p-6 bg-gray-50 rounded-lg border border-gray-200"><h3 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">â±ï¸ æ•°åˆ°1äº¿</h3><p class="text-gray-600 text-lg md:text-xl">å¦‚æœä½ ä¸åƒä¸å–ä¸ç¡è§‰ï¼Œä¸€ç§’é’Ÿæ•°ä¸€ä¸ªæ•°ï¼Œæ•°åˆ°1äº¿å¤§çº¦éœ€è¦ <strong class="text-2xl md:text-3xl text-blue-600">3.17å¹´</strong>ï¼</p></div>
                        <div class="p-6 bg-gray-50 rounded-lg border border-gray-200"><h3 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">ğŸ‘£ èµ°1äº¿æ­¥</h3><p class="text-gray-600 text-lg md:text-xl">å¦‚æœæˆ‘ä»¬æ¯æ­¥èµ°50å˜ç±³ï¼Œèµ°1äº¿æ­¥çš„è·ç¦»å¤§çº¦æ˜¯ <strong class="text-2xl md:text-3xl text-blue-600">5ä¸‡å…¬é‡Œ</strong>ï¼Œå¯ä»¥ç»•åœ°çƒèµ¤é“èµ°ä¸€åœˆå¤šï¼</p></div>
                        <div class="p-6 bg-gray-50 rounded-lg border border-gray-200"><h3 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">ğŸ’° 1äº¿æšç¡¬å¸</h3><p class="text-gray-600 text-lg md:text-xl">1äº¿æš1å…ƒç¡¬å¸çš„é‡é‡çº¦ <strong class="text-2xl md:text-3xl text-blue-600">600åƒå…‹</strong>ï¼Œç›¸å½“äºä¸€å¤´æˆå¹´ç‰›çš„é‡é‡ï¼</p></div>
                        <div class="p-6 bg-gray-50 rounded-lg border border-gray-200"><h3 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">ğŸŒ¾ 1äº¿ç²’ç±³</h3><p class="text-gray-600 text-lg md:text-xl">1äº¿ç²’å¤§ç±³çš„é‡é‡çº¦ <strong class="text-2xl md:text-3xl text-blue-600">2.5å…¬æ–¤</strong>ï¼Œå¤Ÿä¸€ä¸ªäººåƒå¥½å‡ å¤©ï¼</p></div>
                    </div>
                </div>
                
                <!-- Interactive Calculator -->
                <div class="bg-gray-50 p-6 rounded-lg mb-6 border border-gray-200">
                    <h3 class="text-2xl md:text-3xl font-bold mb-6 text-gray-800">ğŸ§® å¤§æ•°è®¡ç®—å™¨</h3>
                    <div class="mb-6">
                         <label class="block text-lg md:text-xl font-semibold mb-4 text-center text-gray-700">æ‹–åŠ¨é€‰æ‹©ä¸€ä¸ªå¤§æ•°ï¼š</label>
                         <input type="range" id="customNumberSlider" min="1000" max="999999999" step="1000" value="100000000" class="w-full mb-4">
                         <div class="text-center text-2xl md:text-3xl font-bold mb-6 text-gray-800" id="customNumberDisplay"></div>
                         <div class="flex justify-center items-center space-x-4">
                             <select id="comparisonType" class="p-3 border border-gray-300 rounded text-lg text-gray-700 bg-white">
                                 <option value="paper">å¼ çº¸çš„é«˜åº¦</option>
                                 <option value="time">æ•°æ•°çš„æ—¶é—´</option>
                                 <option value="steps">èµ°è·¯çš„è·ç¦»</option>
                             </select>
                             <button id="calculateBtn" class="btn text-lg px-6 py-3">è®¡ç®—</button>
                         </div>
                     </div>
                    <div id="calculationResult" class="text-2xl md:text-3xl font-bold text-gray-800"></div>
                </div>
                

            </div>
        </section>
        

    </main>

    <!-- Digit Picker Popover -->
    <div id="digitPopover">
        <div id="digitWheel" class="digit-wheel"></div>
    </div>

    <script>
        // --- App Navigation ---
        const navButtons = document.querySelectorAll('.nav-btn');
        const activityContents = document.querySelectorAll('.activity-content');
        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetId = button.dataset.target;
                navButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                activityContents.forEach(content => {
                    content.id === targetId ? content.classList.add('active') : content.classList.remove('active');
                });
             });
         });

        // --- Shared Utility Functions ---
        const CHINESE_CHARS = ['é›¶', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹'];
        const SECTION_UNITS = ['', 'å', 'ç™¾', 'åƒ'];
        function formatNumberWithSeparators(num, showSeparators = false) {
            let s = num.toString();
            if (s.length <= 4) return s;
            let result = '';
            const separatorClass = showSeparators ? 'num-separator visible' : 'num-separator';
            while (s.length > 4) {
                result = `<span class="${separatorClass}"></span>` + s.slice(-4) + result;
                s = s.slice(0, s.length - 4);
            }
            return s + result;
        }
        function numberToChinese(num) {
            if (num === 0) return 'é›¶';
            const units = ['', 'ä¸‡', 'äº¿'];
            
            // å°†æ•°å­—æŒ‰å››ä½ä¸€ç»„æ‹†åˆ†ï¼ˆä½ä½åœ¨å‰ï¼Œé«˜ä½åœ¨åï¼‰
            const sections = [];
            while (num > 0) {
                sections.push(num % 10000);
                num = Math.floor(num / 10000);
            }
            
            // ä»é«˜ä½èŠ‚åˆ°ä½ä½èŠ‚ç»„è£…ï¼ŒæŒ‰éœ€åœ¨èŠ‚ä¸èŠ‚ä¹‹é—´æ’å…¥ä¸€ä¸ªâ€œé›¶â€
            let result = '';
            let pendingZero = false; // æ ‡è®°æ˜¯å¦éœ€è¦åœ¨ä¸‹ä¸€ä¸ªéé›¶èŠ‚å‰è¡¥ä¸€ä¸ªâ€œé›¶â€
            for (let i = sections.length - 1; i >= 0; i--) {
                const sec = sections[i];
                if (sec === 0) {
                    // å½“å‰èŠ‚ä¸º 0ï¼šå¦‚æœä¹‹å‰å·²ç»æœ‰è¾“å‡ºï¼Œåˆ™è®°å½•éœ€è¦ä¸€ä¸ªâ€œé›¶â€ï¼ˆå¤šä¸ªè¿ç»­0åªè¯»ä¸€ä¸ªé›¶ï¼‰
                    if (result.length > 0) pendingZero = true;
                } else {
                    // åœ¨éœ€è¦çš„ä½ç½®è¡¥ä¸€ä¸ªâ€œé›¶â€ï¼š
                    if (result.length > 0) {
                        if (pendingZero) {
                            result += 'é›¶';
                            pendingZero = false;
                        } else if (sec < 1000) {
                            // ä½ä½èŠ‚éé›¶ä½†å°äº1000ï¼Œè¯´æ˜è¯¥èŠ‚å‰é¢å­˜åœ¨èŠ‚å†…å‰å¯¼é›¶ï¼Œéœ€è¦è¡¥ä¸€ä¸ªâ€œé›¶â€
                            result += 'é›¶';
                        }
                    }
                    result += sectionToChinese(sec) + units[i];
                }
            }
            
            // å¤„ç†æ•´ä½“ä»¥â€œä¸€åâ€å¼€å¤´çš„æƒ…å†µï¼ˆå¦‚â€œä¸€åä¸‡â€ã€â€œä¸€åä¹â€ç­‰ï¼‰
            if (result.startsWith('ä¸€å')) {
                result = result.slice(1);
            }
            
            return result || 'é›¶';
        }
        function sectionToChinese(section) {
            if (section === 0) return '';
            
            let str = '';
            let needZero = false;
            let hasDigit = false;
            
            for (let i = 0; i < 4; i++) {
                const digit = section % 10;
                
                if (digit === 0) {
                    // å½“å‰ä½æ˜¯0
                    if (hasDigit) {
                        needZero = true;
                    }
                } else {
                    // å½“å‰ä½ä¸æ˜¯0
                    if (needZero && str.length > 0) {
                        str = 'é›¶' + str;
                        needZero = false;
                    }
                    str = CHINESE_CHARS[digit] + SECTION_UNITS[i] + str;
                    hasDigit = true;
                }
                
                section = Math.floor(section / 10);
            }
            
            return str;
        }
        function highlightChineseNumber(str) {
            return str.replace(/([äº¿ä¸‡])/g, '<span class="highlight-unit">$1</span>');
        }

        // --- Part 1: Number Composer & Reader ---
        const composerEl = document.getElementById('numberComposer');
        const composedNumberDisplayEl = document.getElementById('composedNumberDisplay');
        let separatorsVisible = false;
        const numberOutputEl = document.getElementById('numberOutput');
        const clearComposerBtn = document.getElementById('clearComposerBtn');
        const digitPopover = document.getElementById('digitPopover');
        const digitWheel = document.getElementById('digitWheel');
        const placeValues = ['äº¿', 'åƒä¸‡', 'ç™¾ä¸‡', 'åä¸‡', 'ä¸‡', 'åƒ', 'ç™¾', 'å', 'ä¸ª'];
        let composedDigits = Array(9).fill(0);
        let activeDigitIndex = 0;

        function renderComposer() {
            composerEl.innerHTML = '';
            placeValues.forEach((unit, index) => {
                const unitEl = document.createElement('div');
                unitEl.className = 'composer-digit-wrapper';
                unitEl.innerHTML = `<div class="text-xl md:text-2xl font-semibold text-blue-800 my-2">${unit}</div><div class="composer-digit" id="digit-${index}">${composedDigits[index]}</div>`;
                unitEl.addEventListener('click', (e) => { e.stopPropagation(); openDigitPicker(index, unitEl); });
                composerEl.appendChild(unitEl);
            });
            updateComposedNumber();
        }

        function openDigitPicker(index, targetElement) {
            activeDigitIndex = index;
            const rect = targetElement.getBoundingClientRect();
            digitPopover.style.left = `${rect.left + rect.width / 2 - digitPopover.offsetWidth / 2}px`;
            digitPopover.style.top = `${rect.bottom + 10}px`;
            digitPopover.classList.add('visible');
        }

        function closeDigitPicker() { digitPopover.classList.remove('visible'); }
        
        digitWheel.addEventListener('click', (e) => {
            if (e.target.classList.contains('digit-wheel-btn')) {
                const digit = parseInt(e.target.dataset.digit);
                composedDigits[activeDigitIndex] = digit;
                document.getElementById(`digit-${activeDigitIndex}`).textContent = digit;
                updateComposedNumber();
                closeDigitPicker();
            }
        });
        
        function updateComposedNumber() {
            const num = BigInt(composedDigits.join(''));
            composedNumberDisplayEl.innerHTML = formatNumberWithSeparators(num);
            
            // ä¿æŒè™šçº¿æ˜¾ç¤ºçŠ¶æ€çš„è®°å¿†
            if (separatorsVisible) {
                const separators = composedNumberDisplayEl.querySelectorAll('.num-separator');
                separators.forEach(separator => {
                    separator.classList.add('visible');
                });
            }
            
            const chineseStr = numberToChinese(Number(num));
            numberOutputEl.innerHTML = highlightChineseNumber(chineseStr);
            numberOutputEl.dataset.highlighted = "false";
            // å¦‚æœä¸æ˜¯é€šè¿‡éšæœºæŒ‰é’®è§¦å‘çš„æ›´æ–°ï¼Œé‡ç½®æ–‡å­—æ˜¾ç¤ºçŠ¶æ€
            if (!isTextHidden) {
                numberOutputEl.style.color = '';
            }
        }
        
        numberOutputEl.addEventListener('click', () => {
            if (isTextHidden) {
                // å¦‚æœæ–‡å­—è¢«éšè—ï¼Œç‚¹å‡»æ˜¾ç¤ºæ–‡å­—
                numberOutputEl.style.color = '';
                isTextHidden = false;
            } else {
                // å¦‚æœæ–‡å­—æ˜¾ç¤ºï¼Œè¿›è¡Œé›¶å­—é«˜äº®åˆ‡æ¢
                const isHighlighted = numberOutputEl.dataset.highlighted === "true";
                let currentHTML = numberOutputEl.innerHTML;
                if (isHighlighted) {
                    // å–æ¶ˆé«˜äº®ï¼šå°†æ‰€æœ‰é«˜äº®çš„é›¶å­—è¿˜åŸä¸ºæ™®é€šé›¶å­—
                    currentHTML = currentHTML.replace(/<span class="highlight-ling">é›¶<\/span>/g, 'é›¶');
                } else {
                    // æ·»åŠ é«˜äº®ï¼šå…ˆç§»é™¤æ‰€æœ‰ç°æœ‰çš„é›¶å­—é«˜äº®ï¼Œç„¶åé‡æ–°é«˜äº®æ‰€æœ‰é›¶å­—
                    currentHTML = currentHTML.replace(/<span class="highlight-ling">é›¶<\/span>/g, 'é›¶');
                    currentHTML = currentHTML.replace(/é›¶/g, '<span class="highlight-ling">é›¶</span>');
                }
                numberOutputEl.innerHTML = currentHTML;
                numberOutputEl.dataset.highlighted = !isHighlighted;
            }
        });

        let isTextHidden = false;
        
        clearComposerBtn.addEventListener('click', () => { 
            composedDigits.fill(0); 
            renderComposer(); 
            isTextHidden = false;
        });
        
        // éšæœºç»„æ•°æŒ‰é’®åŠŸèƒ½
        const randomComposerBtn = document.getElementById('randomComposerBtn');
        randomComposerBtn.addEventListener('click', () => {
            // ç”Ÿæˆä¸‡ä»¥ä¸Šçš„éšæœºå¤§æ•°ï¼ˆ5-9ä½æ•°ï¼‰
            const digits = Math.floor(Math.random() * 5) + 5; // 5åˆ°9ä½æ•°
            const minValue = Math.pow(10, digits - 1);
            const maxValue = Math.pow(10, digits) - 1;
            const randomNum = Math.floor(Math.random() * (maxValue - minValue + 1)) + minValue;
            
            // å°†éšæœºæ•°å¡«å…¥composedDigitsæ•°ç»„
            const numStr = randomNum.toString().padStart(9, '0');
            for (let i = 0; i < 9; i++) {
                composedDigits[i] = parseInt(numStr[i]);
                document.getElementById(`digit-${i}`).textContent = composedDigits[i];
            }
            
            updateComposedNumber();
            // éšè—æ–‡å­—å†…å®¹
            numberOutputEl.style.color = 'transparent';
            isTextHidden = true;
        });
        
        // composedNumberDisplayç‚¹å‡»äº‹ä»¶ - åˆ‡æ¢è™šçº¿æ˜¾ç¤º
        composedNumberDisplayEl.addEventListener('click', () => {
            separatorsVisible = !separatorsVisible;
            const separators = composedNumberDisplayEl.querySelectorAll('.num-separator');
            separators.forEach(separator => {
                if (separatorsVisible) {
                    separator.classList.add('visible');
                } else {
                    separator.classList.remove('visible');
                }
            });
        });
        document.addEventListener('click', closeDigitPicker);
        digitPopover.addEventListener('click', (e) => e.stopPropagation());

        // Init Digit Wheel
        for (let i = 1; i <= 9; i++) {
            const btn = document.createElement('div');
            btn.className = 'digit-wheel-btn';
            btn.dataset.digit = i;
            btn.textContent = i;
            digitWheel.appendChild(btn);
        }
        const zeroBtn = document.createElement('div');
        zeroBtn.className = 'digit-wheel-btn';
        zeroBtn.dataset.digit = 0;
        zeroBtn.textContent = 0;
        digitWheel.appendChild(zeroBtn);
        renderComposer();

        // --- Part 2: Number Comparison Game ---
        const num1Btn = document.getElementById('num1Btn');
        const num2Btn = document.getElementById('num2Btn');
        const startComparisonBtn = document.getElementById('startComparison');
        const comparisonFeedback = document.getElementById('comparisonFeedback');
        let largerNum;

        function generateComparisonNumbers() {
            let digits1, digits2;
            if (Math.random() < 0.8) { // 80% chance for same digits
                digits1 = Math.floor(Math.random() * 4) + 5; // 5 to 8 digits
                digits2 = digits1;
            } else { // 20% chance for different digits
                digits1 = Math.floor(Math.random() * 4) + 5;
                digits2 = Math.floor(Math.random() * 4) + 5;
                while (digits1 === digits2) { digits2 = Math.floor(Math.random() * 4) + 5; }
            }
            const num1 = Math.floor(Math.random() * (Math.pow(10, digits1) - Math.pow(10, digits1-1))) + Math.pow(10, digits1-1);
            let num2 = Math.floor(Math.random() * (Math.pow(10, digits2) - Math.pow(10, digits2-1))) + Math.pow(10, digits2-1);
            while (num1 === num2) { num2 = Math.floor(Math.random() * (Math.pow(10, digits2) - Math.pow(10, digits2-1))) + Math.pow(10, digits2-1); }
            
            num1Btn.innerHTML = formatNumberWithSeparators(num1, true);
            num1Btn.dataset.value = num1;
            num2Btn.innerHTML = formatNumberWithSeparators(num2, true);
            num2Btn.dataset.value = num2;
            largerNum = Math.max(num1, num2);
            comparisonFeedback.textContent = '';
            [num1Btn, num2Btn].forEach(btn => btn.disabled = false);
        }
        startComparisonBtn.addEventListener('click', generateComparisonNumbers);
        function checkComparison(selectedNum) {
            [num1Btn, num2Btn].forEach(btn => btn.disabled = true);
            if (parseInt(selectedNum) === largerNum) {
                comparisonFeedback.textContent = 'å¤ªæ£’äº†ï¼ä½ é€‰å¯¹äº†ï¼ğŸ‘';
                comparisonFeedback.classList.add('correct');
            } else {
                comparisonFeedback.textContent = 'ä¸å¯¹å“¦ï¼Œå†ä»”ç»†çœ‹çœ‹ï¼ğŸ¤”';
                comparisonFeedback.classList.add('incorrect');
            }
            setTimeout(generateComparisonNumbers, 1500);
        }
        num1Btn.addEventListener('click', () => checkComparison(num1Btn.dataset.value));
        num2Btn.addEventListener('click', () => checkComparison(num2Btn.dataset.value));
        generateComparisonNumbers();

        // --- Part 3: Rounding Off Challenge (MCQ) ---
        const roundingNumberEl = document.getElementById('roundingNumber');
        const roundingOptionsEl = document.getElementById('roundingOptions');
        const nextRoundingBtn = document.getElementById('nextRoundingBtn');
        const roundingFeedback = document.getElementById('roundingFeedback');
        let currentRoundingAnswer;

        function generateRoundingQuestion() {
            roundingOptionsEl.innerHTML = '';
            roundingFeedback.textContent = '';
            const num = Math.floor(Math.random() * 9999999) + 100000;
            roundingNumberEl.innerHTML = formatNumberWithSeparators(num, true);
            currentRoundingAnswer = Math.round(num / 10000);
            const options = new Set([currentRoundingAnswer]);
            while(options.size < 3) {
                const wrongAnswer1 = Math.floor(num / 10000);
                const wrongAnswer2 = Math.ceil(num / 10000);
                if(wrongAnswer1 !== currentRoundingAnswer && wrongAnswer1 > 0) options.add(wrongAnswer1);
                if(wrongAnswer2 !== currentRoundingAnswer && wrongAnswer2 > 0) options.add(wrongAnswer2);
                if(options.size < 3) {
                    const randomOffset = (Math.random() > 0.5 ? 1 : -1) * (Math.floor(Math.random()*3)+1);
                    if (currentRoundingAnswer + randomOffset > 0) { options.add(currentRoundingAnswer + randomOffset); }
                }
            }
            const shuffledOptions = Array.from(options).sort(() => Math.random() - 0.5);
            shuffledOptions.forEach(opt => {
                const optionBtn = document.createElement('button');
                optionBtn.className = 'option-btn text-3xl p-4 border-2 rounded-lg';
                optionBtn.textContent = `çº¦ ${opt} ä¸‡`;
                optionBtn.dataset.value = opt;
                optionBtn.addEventListener('click', checkRoundingAnswer);
                roundingOptionsEl.appendChild(optionBtn);
            });
        }
        function checkRoundingAnswer(e) {
            const userAnswer = parseInt(e.target.dataset.value);
            roundingOptionsEl.querySelectorAll('button').forEach(btn => {
                btn.disabled = true;
                if (parseInt(btn.dataset.value) === currentRoundingAnswer) { btn.classList.add('bg-green-200', 'border-green-400'); }
            });
            if (userAnswer === currentRoundingAnswer) {
                roundingFeedback.textContent = 'å®Œå…¨æ­£ç¡®ï¼ä½ çœŸæ˜¯ä¸ªç¥å°„æ‰‹ï¼ğŸ¯';
                roundingFeedback.classList.add('correct');
            } else {
                roundingFeedback.textContent = 'æœ‰ç‚¹åå·®å“¦ï¼Œæƒ³æƒ³"å››èˆäº”å…¥"çš„è§„åˆ™ï¼';
                roundingFeedback.classList.add('incorrect');
                e.target.classList.add('bg-red-200', 'border-red-400');
            }
            
            // Show help and highlights after answer is selected
            setTimeout(() => {
                const targetSpans = document.querySelectorAll('.rounding-digit.target, .rounding-digit.important');
                targetSpans.forEach(span => span.classList.add('show'));
            }, 300);
        }
        nextRoundingBtn.addEventListener('click', generateRoundingQuestion);
        
        // Enhanced rounding with visual helper
        function enhancedGenerateRoundingQuestion() {
            roundingOptionsEl.innerHTML = '';
            roundingFeedback.textContent = '';
            const num = Math.floor(Math.random() * 9999999) + 100000;
            
            // Visual breakdown - mark digits directly in the number
             const numStr = num.toString();
             const wanPosition = numStr.length - 5; // Position of ä¸‡ä½
             let visualHTML = '';
             
             for (let i = 0; i < numStr.length; i++) {
                 const digit = numStr[i];
                 let className = 'rounding-digit';
                 if (i === wanPosition) className += ' target';
                 if (i === wanPosition + 1) className += ' important';
                 visualHTML += `<span class="${className}">${digit}</span>`;
                 
                 // Add separator every 4 digits from right
                 if ((numStr.length - i - 1) % 4 === 0 && i < numStr.length - 1) {
                     visualHTML += '<span class="num-separator visible"></span>';
                 }
             }
             
             const targetDigit = wanPosition >= 0 && wanPosition + 1 < numStr.length ? parseInt(numStr[wanPosition + 1]) : 0;

             const targetSpans = document.querySelectorAll('.rounding-digit.target, .rounding-digit.important');
             targetSpans.forEach(span => span.classList.remove('show'));
             
             roundingNumberEl.innerHTML = visualHTML;
            currentRoundingAnswer = Math.round(num / 10000);
            
            const options = new Set([currentRoundingAnswer]);
            while(options.size < 3) {
                const wrongAnswer1 = Math.floor(num / 10000);
                const wrongAnswer2 = Math.ceil(num / 10000);
                if(wrongAnswer1 !== currentRoundingAnswer && wrongAnswer1 > 0) options.add(wrongAnswer1);
                if(wrongAnswer2 !== currentRoundingAnswer && wrongAnswer2 > 0) options.add(wrongAnswer2);
                if(options.size < 3) {
                    const randomOffset = (Math.random() > 0.5 ? 1 : -1) * (Math.floor(Math.random()*3)+1);
                    if (currentRoundingAnswer + randomOffset > 0) { options.add(currentRoundingAnswer + randomOffset); }
                }
            }
            const shuffledOptions = Array.from(options).sort(() => Math.random() - 0.5);
            shuffledOptions.forEach(opt => {
                const optionBtn = document.createElement('button');
                optionBtn.className = 'option-btn text-3xl p-4 border-2 rounded-lg';
                optionBtn.textContent = `çº¦ ${opt} ä¸‡`;
                optionBtn.dataset.value = opt;
                optionBtn.addEventListener('click', checkRoundingAnswer);
                roundingOptionsEl.appendChild(optionBtn);
            });
        }
        
        nextRoundingBtn.addEventListener('click', enhancedGenerateRoundingQuestion);
        enhancedGenerateRoundingQuestion();
        

        
        // --- Enhanced Visualization ---
        const comparisonBtns = document.querySelectorAll('.comparison-btn');
        const visualizationDisplay = document.getElementById('visualizationDisplay');
        const customNumberSlider = document.getElementById('customNumberSlider');
         const customNumberDisplay = document.getElementById('customNumberDisplay');
        const comparisonTypeSelect = document.getElementById('comparisonType');
        const calculateBtn = document.getElementById('calculateBtn');
        const calculationResult = document.getElementById('calculationResult');
        
        const visualizationData = {
            paper: { title: 'ğŸ“š çº¸å¼ é«˜åº¦', unit: 'å…¬é‡Œ', factor: 0.0001, description: 'å¼ A4çº¸å èµ·æ¥çº¦' },
            time: { title: 'â±ï¸ æ•°æ•°æ—¶é—´', unit: 'å¹´', factor: 1/31536000, description: 'ç§’é’Ÿæ•°ä¸€ä¸ªæ•°ï¼Œéœ€è¦çº¦' },
            steps: { title: 'ğŸ‘£ æ­¥è¡Œè·ç¦»', unit: 'å…¬é‡Œ', factor: 0.0005, description: 'æ­¥(æ¯æ­¥50cm)ï¼Œè·ç¦»çº¦' },
            money: { title: 'ğŸ’° ç¡¬å¸é‡é‡', unit: 'å…¬æ–¤', factor: 0.006, description: 'æš1å…ƒç¡¬å¸ï¼Œé‡é‡çº¦' },
            rice: { title: 'ğŸŒ¾ ç±³ç²’é‡é‡', unit: 'å…¬æ–¤', factor: 0.000025, description: 'ç²’å¤§ç±³ï¼Œé‡é‡çº¦' }
        };
        
        comparisonBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                comparisonBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                const type = btn.dataset.type;
                const data = visualizationData[type];
                const result = 100000000 * data.factor;
                
                visualizationDisplay.innerHTML = `
                    <div class="p-8 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg text-center">
                        <h3 class="text-3xl font-bold mb-4">${data.title}</h3>
                        <p class="text-xl mb-4">1äº¿${data.description}</p>
                        <div class="text-5xl font-bold text-blue-600 mb-2">${result.toLocaleString()}</div>
                        <div class="text-2xl text-blue-800">${data.unit}</div>
                    </div>
                `;
            });
        });
        
        // Update slider display
         customNumberSlider.addEventListener('input', (e) => {
             const value = parseInt(e.target.value);
             customNumberDisplay.innerHTML = formatNumberWithSeparators(value);
         });
         
         calculateBtn.addEventListener('click', () => {
             const number = parseInt(customNumberSlider.value);
             const type = comparisonTypeSelect.value;
             
             const data = visualizationData[type];
             const result = number * data.factor;
             calculationResult.textContent = `${number}${data.description}${result} ${data.unit}`;
         });
         
         // Initialize slider display
         customNumberDisplay.innerHTML = formatNumberWithSeparators(parseInt(customNumberSlider.value));
        

        

    </script>
</body>
</html>