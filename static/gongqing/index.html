<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公顷和平方千米</title>
    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: '0b71da9c4b2abe5d30da60fccd70f788'
        };
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            /* 防止移动端点击闪烁 */
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        body {
            height: 100vh;
            overflow: hidden;
        }
        
        #mapContainer {
            width: 100%;
            height: 100vh;
            cursor: crosshair;
        }
        
        .control-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 180px;
            backdrop-filter: blur(10px);
        }
        
        .area-info {
            margin-top: 12px;
        }
        
        .area-info h3 {
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .drawing-controls {
            border-bottom: 1px solid #eee;
            margin-bottom: 0;
            display: flex;
            gap: 8px;
        }
        
        .control-btn {
            background: #4b6cb7;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 0;
            flex: 1;
        }
        
        .area-value {
            font-size: 28px;
            font-weight: 600;
            color: #4b6cb7;
            margin: 6px 0;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .area-value:hover {
            background-color: #f0f0f0;
        }
        
        .area-conversions {
            font-size: 28px;
            color: #666;
            line-height: 1.3;
        }
        
        .area-conversions div {
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.3s ease;
            margin: 2px 0;
        }
        
        .area-conversions div:hover {
            background-color: #f0f0f0;
            color: #4b6cb7;
        }
        
        .area-conversions div.active {
            font-size: 36px;
            font-weight: 600;
            color: #4b6cb7;
            background-color: #f8f9ff;
            border: 1px solid #4b6cb7;
            margin: 6px 0;
        }
        
        .control-btn:hover {
            background: #3a5a9e;
            transform: translateY(-1px);
        }
        
        .control-btn.active {
            background: #28a745;
        }
        
        .status-message {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 1000;
            display: none;
            font-size: 14px;
        }
        
        .drawing-polygon {
            stroke: #ff4757;
            stroke-width: 3;
            fill: rgba(255, 71, 87, 0.3);
        }
        
        .drawing-point {
            fill: #ff4757;
            stroke: white;
            stroke-width: 2;
        }
        
        .more-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            color: #333;
        }
        
        .more-btn:hover {
            background-color: rgba(255, 255, 255, 1);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .more-btn:active {
            transform: scale(0.95);
        }
        
        .more-panel {
            position: absolute;
            bottom: 80px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 999;
            backdrop-filter: blur(10px);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px) scale(0.95);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .more-panel.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        
        .more-panel-content {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .button-row {
            display: flex;
            gap: 8px;
        }
        
        .more-option-btn {
            flex: 1;
            background: none;
            border: none;
            padding: 12px 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 4px;
            font-size: 12px;
            color: #333;
            min-height: 60px;
        }
        
        .more-option-btn:hover {
            background-color: rgba(75, 108, 183, 0.1);
            color: #4b6cb7;
        }
        
        .more-option-btn:active {
            transform: scale(0.98);
        }
        
        .option-icon {
            font-size: 20px;
            width: auto;
            text-align: center;
        }
        
        .option-text {
            text-align: center;
            font-weight: 500;
            line-height: 1.2;
        }
        
        .location-info {
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            margin-top: 8px;
            padding-top: 8px;
        }
        
        .location-btn {
            font-size: 11px;
            min-height: 50px;
        }
        
        .location-btn .option-icon {
            font-size: 18px;
        }

        /* 目的地输入框样式 */
        .destination-input-container {
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            margin-top: 8px;
            padding-top: 12px;
        }
        
        .destination-input-wrapper {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .destination-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s ease;
        }
        
        .destination-input:focus {
            border-color: #4b6cb7;
            box-shadow: 0 0 0 2px rgba(75, 108, 183, 0.1);
        }
        
        .destination-search-btn {
            padding: 10px 16px;
            background: #4b6cb7;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
        
        .destination-search-btn:hover {
            background: #3a5a9e;
        }
        
        .destination-search-btn:active {
            transform: scale(0.98);
        }
        
        /* 预设地点按钮样式 */
        .preset-locations {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        
        .preset-location-btn {
            padding: 6px 12px;
            background: rgba(75, 108, 183, 0.1);
            color: #4b6cb7;
            border: 1px solid rgba(75, 108, 183, 0.2);
            border-radius: 16px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .preset-location-btn:hover {
            background: rgba(75, 108, 183, 0.2);
            border-color: rgba(75, 108, 183, 0.4);
            transform: translateY(-1px);
        }
        
        .preset-location-btn:active {
            transform: translateY(0) scale(0.98);
        }

        /* 场所选择列表与遮罩统一样式 */
        .places-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9998;
        }

        .places-list {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            width: 400px;
            max-height: 500px;
            overflow-y: auto;
            z-index: 9999;
            padding: 0;
        }

        .places-list-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
            border-radius: 10px 10px 0 0;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .places-list-header-inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .places-list-title {
            margin: 0;
            color: #333;
            font-size: 16px;
        }

        .places-list-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .places-list-subtitle {
            margin: 5px 0 0 0;
            color: #666;
            font-size: 12px;
        }

        .places-list-content {
            padding: 10px 0;
        }

        .places-list-item {
            padding: 12px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .places-list-item:hover {
            background-color: #f8f9fa;
        }

        .places-list-item-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }

        .places-list-item-address {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
        }

        .places-list-item-distance {
            font-size: 12px;
            color: #28a745;
        }
    </style>
</head>
<body>
    <div id="mapContainer"></div>
    
    <div class="control-panel" id="control-panel">
        <div class="drawing-controls">
            <button class="control-btn active" id="draw-btn">
                ✏️ 绘制
            </button>
            <button class="control-btn" id="clear-btn">
                🗑️ 清除
            </button>
        </div>
        
        <div class="area-info" id="area-info" style="display: none;">
            <h3>📐 区域面积</h3>
            <div class="area-value" id="area-value">0 平方米</div>
            <div class="area-conversions" id="area-conversions">
                <div>0 公顷</div>
                <div>0 平方千米</div>
            </div>
        </div>
    </div>
    
    <div class="status-message" id="status-message"></div>
    
    <!-- 更多按钮 -->
    <button class="more-btn" id="more-btn" title="更多选项">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
            <circle cx="12" cy="5" r="2"/>
            <circle cx="12" cy="12" r="2"/>
            <circle cx="12" cy="19" r="2"/>
        </svg>
    </button>
    
    <!-- 更多控制面板 -->
    <div class="more-panel" id="more-panel">
        <div class="more-panel-content">
            <div class="button-row">
                <button class="more-option-btn" id="relocate-btn">
                    <span class="option-icon">📍</span>
                    <span class="option-text">附近小学</span>
                </button>
                <button class="more-option-btn" id="gym-btn">
                    <span class="option-icon">🏟️</span>
                    <span class="option-text">附近体育馆</span>
                </button>
            </div>
            <div class="button-row">
                <button class="more-option-btn" id="airport-btn">
                    <span class="option-icon">✈️</span>
                    <span class="option-text">附近机场</span>
                </button>
                <button class="more-option-btn" id="attraction-btn">
                    <span class="option-icon">🏞️</span>
                    <span class="option-text">附近景点</span>
                </button>
            </div>
            <div class="location-info" id="location-info">
                <div class="button-row">
                    <button class="more-option-btn location-btn" id="district-btn">
                        <span class="option-icon">🏘️</span>
                        <span class="option-text" id="district-text">获取区县信息</span>
                    </button>
                    <button class="more-option-btn location-btn" id="city-btn">
                        <span class="option-icon">🏙️</span>
                        <span class="option-text" id="city-text">获取城市信息</span>
                    </button>
                </div>
                <div class="button-row">
                    <button class="more-option-btn location-btn" id="province-btn">
                        <span class="option-icon">🗺️</span>
                        <span class="option-text" id="province-text">获取省份信息</span>
                    </button>
                    <button class="more-option-btn location-btn" id="country-btn">
                        <span class="option-icon">🇨🇳</span>
                        <span class="option-text" id="country-text">全中国</span>
                    </button>
                </div>
            </div>
            
            <!-- 目的地输入框 -->
            <div class="destination-input-container">
                <div class="destination-input-wrapper">
                    <input type="text" class="destination-input" id="destination-input" placeholder="输入目的地名称或地址">
                    <button class="destination-search-btn" id="destination-search-btn">搜索</button>
                </div>
                <!-- 预设地点按钮 -->
                <div class="preset-locations">
                    <button class="preset-location-btn" data-location="天安门广场">天安门广场</button>
                    <button class="preset-location-btn" data-location="故宫">故宫</button>
                    <button class="preset-location-btn" data-location="北京市朝阳区国家体育场">鸟巢</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 高德地图API -->
    <script src="https://webapi.amap.com/maps?v=1.4.15&key=05bce3e045e35d9c8479155adbb6716c&plugin=AMap.Geocoder,AMap.PlaceSearch"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let map, geocoder, placeSearch;
            let isDrawing = false;
            let drawingPoints = [];
            let currentPolygon = null;
            let pointMarkers = [];
            
            // 存储所有绘制的区域
            let allPolygons = [];
            let currentActivePolygon = null;
            
            const drawBtn = document.getElementById('draw-btn');
            const clearBtn = document.getElementById('clear-btn');
            const moreBtn = document.getElementById('more-btn');
            const morePanel = document.getElementById('more-panel');
            const relocateBtn = document.getElementById('relocate-btn');
            const gymBtn = document.getElementById('gym-btn');
            const airportBtn = document.getElementById('airport-btn');
            const attractionBtn = document.getElementById('attraction-btn');
            const districtBtn = document.getElementById('district-btn');
            const cityBtn = document.getElementById('city-btn');
            const provinceBtn = document.getElementById('province-btn');
            const countryBtn = document.getElementById('country-btn');
            const destinationInput = document.getElementById('destination-input');
            const destinationSearchBtn = document.getElementById('destination-search-btn');
            const areaInfo = document.getElementById('area-info');
            const areaValue = document.getElementById('area-value');
            const areaConversions = document.getElementById('area-conversions');
            const statusMessage = document.getElementById('status-message');
            
            // 当前位置信息
            let currentLocation = null;
            let currentLocationInfo = null;
            let districtSearch = null; // 行政区域搜索对象
            let currentDistrictPolygon = null; // 当前显示的行政区域多边形
            
            // 初始化地图
            function initMap() {
                map = new AMap.Map('mapContainer', {
                    zoom: 20, // 改为最大缩放级别
                    center: [39.91598,116.4006182],
                    viewMode: '2D',
                    resizeEnable: true
                });
                
                // 加载插件
                AMap.plugin(['AMap.Geocoder', 'AMap.PlaceSearch', 'AMap.Scale', 'AMap.DistrictSearch'], function() {
                    geocoder = new AMap.Geocoder({
                        city: "全国"
                    });
                    
                    placeSearch = new AMap.PlaceSearch({
                        city: "全国",
                        pageSize: 20,
                        pageIndex: 1,
                        extensions: 'all'
                    });
                    
                    // 初始化行政区域搜索
                    districtSearch = new AMap.DistrictSearch({
                        level: 'district',
                        extensions: 'all'
                    });
                    
                    // 添加比例尺控件
                    //const scale = new AMap.Scale({
                    //    position: 'LB', // 左下角位置
                    //    offset: new AMap.Pixel(10,10)
                    //});
                    //map.addControl(scale);
                });
                
                // 地图点击事件
                map.on('click', function(e) {
                    if (isDrawing) {
                        addDrawingPoint(e.lnglat);
                    }
                });
                
                // 自动定位到最近的小学
                setTimeout(() => {
                    autoFindNearestSchool();
                }, 1000);
            }
            
            // 显示状态消息
            function showStatus(message, duration = 3000, type = 'info') {
                statusMessage.textContent = message;
                statusMessage.style.display = 'block';
                
                // 根据消息类型设置不同的样式
                statusMessage.className = 'status-message';
                if (type === 'error') {
                    statusMessage.style.backgroundColor = '#ff4757';
                    statusMessage.style.color = 'white';
                } else if (type === 'success') {
                    statusMessage.style.backgroundColor = '#2ed573';
                    statusMessage.style.color = 'white';
                } else if (type === 'warning') {
                    statusMessage.style.backgroundColor = '#ffa502';
                    statusMessage.style.color = 'white';
                } else {
                    statusMessage.style.backgroundColor = '#5352ed';
                    statusMessage.style.color = 'white';
                }
                
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, duration);
            }
            
            // 开始/停止绘制
            drawBtn.addEventListener('click', function() {
                if (isDrawing) {
                    // 完成绘制
                    finishDrawing();
                } else {
                    // 开始绘制
                    startDrawing();
                }
            });
            
            // 清除绘制
            clearBtn.addEventListener('click', function() {
                clearDrawing();
                showStatus('已清除所有绘制内容');
            });
            
            // 重新定位按钮事件
            relocateBtn.addEventListener('click', function() {
                // 添加点击动画效果
                relocateBtn.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    relocateBtn.style.transform = '';
                }, 150);
                
                // 执行重新定位
                autoFindNearestSchool();
                // 关闭更多面板
                morePanel.classList.remove('show');
            });
            
            // 更多按钮事件
            moreBtn.addEventListener('click', function() {
                morePanel.classList.toggle('show');
            });
            
            // 点击页面其他地方关闭更多面板
            document.addEventListener('click', function(e) {
                if (!moreBtn.contains(e.target) && !morePanel.contains(e.target)) {
                    morePanel.classList.remove('show');
                }
            });
            
            // 体育馆按钮事件
            gymBtn.addEventListener('click', function() {
                if (currentLocation) {
                    searchNearbyPlaces('体育中心', '🏟️');
                } else {
                    showStatus('请先获取位置信息', 2000, 'warning');
                }
                morePanel.classList.remove('show');
            });
            
            // 机场按钮事件
            airportBtn.addEventListener('click', function() {
                if (currentLocation) {
                    searchNearbyPlaces('机场', '✈️');
                } else {
                    showStatus('请先获取位置信息', 2000, 'warning');
                }
                morePanel.classList.remove('show');
            });

            // 景点景区按钮事件
            attractionBtn.addEventListener('click', function() {
                if (currentLocation) {
                    // 参考已有附近点击事件，列表与点击自动定位逻辑
                    searchNearbyPlaces('景点景区', '🏞️');
                } else {
                    showStatus('请先获取位置信息', 2000, 'warning');
                }
                morePanel.classList.remove('show');
            });
            
            // 区县按钮事件
            districtBtn.addEventListener('click', function() {
                if (currentLocationInfo && currentLocationInfo.district) {
                    showLocationArea(currentLocationInfo.district, 'district');
                } else {
                    showStatus('区县信息不可用', 2000, 'warning');
                }
                morePanel.classList.remove('show');
            });
            
            // 城市按钮事件
            cityBtn.addEventListener('click', function() {
                if (currentLocationInfo && currentLocationInfo.city) {
                    showLocationArea(currentLocationInfo.city, 'city');
                } else {
                    showStatus('城市信息不可用', 2000, 'warning');
                }
                morePanel.classList.remove('show');
            });
            
            // 省份按钮事件
            provinceBtn.addEventListener('click', function() {
                if (currentLocationInfo && currentLocationInfo.province) {
                    showLocationArea(currentLocationInfo.province, 'province');
                } else {
                    showStatus('省份信息不可用', 2000, 'warning');
                }
                morePanel.classList.remove('show');
            });
            
            // 中国按钮事件
            countryBtn.addEventListener('click', function() {
                showLocationArea('中华人民共和国', 'country');
                morePanel.classList.remove('show');
            });
            
            // 目的地搜索按钮事件
            destinationSearchBtn.addEventListener('click', function() {
                searchDestination();
            });
            
            // 目的地输入框回车事件
            destinationInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchDestination();
                }
            });
            
            // 预设地点按钮事件
            const presetLocationBtns = document.querySelectorAll('.preset-location-btn');
            presetLocationBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const location = this.getAttribute('data-location');
                    destinationInput.value = location;
                    searchDestination();
                });
            });
            
            // 开始绘制
            function startDrawing() {
                isDrawing = true;
                drawingPoints = [];
                drawBtn.textContent = '✅ 完成';
                drawBtn.classList.add('active');
                document.getElementById('mapContainer').style.cursor = 'crosshair';
                showStatus('点击地图开始绘制区域，再次点击"完成绘制"按钮结束');
            }
            
            // 完成绘制
            function finishDrawing() {
                if (drawingPoints.length < 3) {
                    showStatus('至少需要3个点才能形成区域');
                    return;
                }
                
                isDrawing = false;
                drawBtn.textContent = '✏️ 绘制';
                drawBtn.classList.remove('active');
                document.getElementById('mapContainer').style.cursor = 'default';
                
                // 创建多边形
                createPolygon();
                showStatus('区域绘制完成，面积已计算');
            }
            
            // 添加绘制点
             function addDrawingPoint(lnglat) {
                 const point = [lnglat.lng, lnglat.lat];
                 
                 // 检查是否点击了第一个点（如果已有3个或更多点）
                 if (drawingPoints.length >= 3) {
                     const firstPoint = drawingPoints[0];
                     const distance = calculateDistance(
                         firstPoint[1], firstPoint[0],
                         point[1], point[0]
                     );
                     
                     // 如果点击位置距离第一个点很近（50米内），自动完成绘制
                     if (distance < 50) {
                         finishDrawing();
                         return;
                     }
                 }
                 
                 drawingPoints.push(point);
                 
                 // 添加点标记
                 const marker = new AMap.CircleMarker({
                     center: point,
                     radius: 4,
                     strokeColor: '#ff4757',
                     strokeWeight: 2,
                     fillColor: '#ff4757',
                     fillOpacity: 0.8,
                     zIndex: 100
                 });
                 
                 // 如果是第一个点，使其更显眼并添加点击事件
                 if (drawingPoints.length === 1) {
                     marker.setOptions({
                         zIndex: 200
                     });
                     
                     // 为第一个点添加专门的点击事件
                     marker.on('click', function(event) {
                         if (event && event.stopPropagation) {
                             event.stopPropagation(); // 阻止事件冒泡
                         }
                         if (isDrawing && drawingPoints.length >= 3) {
                             finishDrawing();
                         }
                         return false; // 阻止默认行为
                     });
                     
                     // 添加鼠标悬停效果
                     marker.on('mouseover', function() {
                         if (isDrawing && drawingPoints.length >= 3) {
                             marker.setOptions({
                                 radius: 12,
                                 strokeWeight: 5
                             });
                             document.getElementById('mapContainer').style.cursor = 'pointer';
                         }
                     });
                     
                     marker.on('mouseout', function() {
                         if (isDrawing) {
                             marker.setOptions({
                                 radius: 10,
                                 strokeWeight: 4
                             });
                             document.getElementById('mapContainer').style.cursor = 'crosshair';
                         }
                     });
                 }
                 
                 map.add(marker);
                 pointMarkers.push(marker);
                 
                 // 如果有多个点，绘制连线
                 if (drawingPoints.length > 1) {
                     updateDrawingLine();
                 }
             }
            
            // 更新绘制线条
            function updateDrawingLine() {
                // 移除之前的临时线条
                if (window.tempPolyline) {
                    map.remove(window.tempPolyline);
                }
                
                // 创建新的临时线条
                window.tempPolyline = new AMap.Polyline({
                    path: drawingPoints,
                    strokeColor: '#ff4757',
                    strokeWeight: 3,
                    strokeOpacity: 0.8,
                    strokeStyle: 'dashed'
                });
                map.add(window.tempPolyline);
            }
            
            // 创建多边形并计算面积
            function createPolygon() {
                // 移除临时线条
                if (window.tempPolyline) {
                    map.remove(window.tempPolyline);
                    window.tempPolyline = null;
                }
                
                // 创建多边形
                const polygon = new AMap.Polygon({
                    path: drawingPoints.slice(), // 复制数组避免引用问题
                    strokeColor: '#ff4757',
                    strokeWeight: 3,
                    strokeOpacity: 0.8,
                    fillColor: '#ff4757',
                    fillOpacity: 0.3,
                    cursor: 'pointer'
                });
                
                // 计算面积
                const area = AMap.GeometryUtil.ringArea(drawingPoints);
                
                // 创建多边形数据对象
                const polygonData = {
                    polygon: polygon,
                    points: drawingPoints.slice(),
                    area: area,
                    id: Date.now() // 使用时间戳作为唯一ID
                };
                
                // 添加到数组中
                allPolygons.push(polygonData);
                
                // 添加点击事件
                polygon.on('click', function() {
                    setActivePolygon(polygonData);
                });
                
                map.add(polygon);
                
                // 设置为当前激活的多边形
                setActivePolygon(polygonData);
                
                // 重置绘制状态，准备绘制下一个区域
                drawingPoints = [];
                currentPolygon = null;
                
                // 移除点标记
                pointMarkers.forEach(marker => {
                    map.remove(marker);
                });
                pointMarkers = [];
            }
            
            // 设置激活的多边形
            function setActivePolygon(polygonData) {
                // 重置所有多边形样式
                allPolygons.forEach(data => {
                    data.polygon.setOptions({
                        strokeColor: '#ff4757',
                        strokeWeight: 3,
                        strokeOpacity: 0.8,
                        fillColor: '#ff4757',
                        fillOpacity: 0.3
                    });
                });
                
                // 高亮当前激活的多边形
                polygonData.polygon.setOptions({
                    strokeColor: '#2ed573',
                    strokeWeight: 4,
                    strokeOpacity: 1,
                    fillColor: '#2ed573',
                    fillOpacity: 0.4
                });
                
                currentActivePolygon = polygonData;
                displayArea(polygonData.area);
            }
            
            // 显示面积信息
            function displayArea(area) {
                // 转换单位
                const hectares = area / 10000; // 公顷
                const squareKm = area / 1000000; // 平方千米
                
                // 格式化显示
                areaValue.textContent = '约 ' + formatArea(area) + ' 平方米';
                
                areaConversions.innerHTML = `
                    <div class="unit-option" data-unit="hectares">约 ${formatArea(hectares)} 公顷</div>
                    <div class="unit-option" data-unit="squareKm">约 ${formatArea(squareKm)} 平方千米</div>
                `;
                
                // 添加点击事件监听器
                const unitOptions = areaConversions.querySelectorAll('.unit-option');
                unitOptions.forEach(option => {
                    option.addEventListener('click', function() {
                        // 移除所有active类
                        unitOptions.forEach(opt => opt.classList.remove('active'));
                        areaValue.classList.remove('active');
                        
                        // 添加active类到被点击的元素
                        this.classList.add('active');
                    });
                });
                
                areaInfo.style.display = 'block';
            }
            
            // 格式化面积数值
            function formatArea(area) {
                if (area < 1) {
                    return area.toFixed(4);
                } else if (area < 100) {
                    return area.toFixed(2);
                } else {
                    return Math.round(area).toString();
                }
            }
            
            // 清除绘制
            function clearDrawing() {
                // 停止绘制模式
                isDrawing = false;
                drawBtn.textContent = '✏️ 绘制';
                drawBtn.classList.remove('active');
                document.getElementById('mapContainer').style.cursor = 'default';
                
                // 清除所有绘制内容
                drawingPoints = [];
                
                // 移除点标记
                pointMarkers.forEach(marker => {
                    map.remove(marker);
                });
                pointMarkers = [];
                
                // 移除临时线条
                if (window.tempPolyline) {
                    map.remove(window.tempPolyline);
                    window.tempPolyline = null;
                }
                
                // 移除当前绘制中的多边形
                if (currentPolygon) {
                    map.remove(currentPolygon);
                    currentPolygon = null;
                }
                
                // 移除所有已绘制的多边形
                allPolygons.forEach(data => {
                    map.remove(data.polygon);
                });
                allPolygons = [];
                currentActivePolygon = null;
                
                // 隐藏面积信息
                areaInfo.style.display = 'none';
            }
            
            // 通过IP地址获取大概位置
            async function getLocationByIP() {
                try {
                    showStatus("正在通过IP地址获取您的位置...", 2000, 'info');
                    
                    // 使用多个IP地理位置API服务，优先使用ip.sb API
                    const apis = [
                        {
                            name: 'ip.sb',
                            url: 'https://api.ip.sb/geoip',
                            parser: (data) => ({
                                lat: data.latitude,
                                lng: data.longitude,
                                city: data.city,
                                country: data.country
                            })
                        },
                        {
                            name: 'ipapi.co',
                            url: 'https://ipapi.co/json/',
                            parser: (data) => ({
                                lat: data.latitude,
                                lng: data.longitude,
                                city: data.city,
                                country: data.country_name
                            })
                        },
                        {
                            name: 'ipgeolocation.io',
                            url: 'https://api.ipgeolocation.io/ipgeo?apiKey=free',
                            parser: (data) => ({
                                lat: parseFloat(data.latitude),
                                lng: parseFloat(data.longitude),
                                city: data.city,
                                country: data.country_name
                            })
                        },
                        {
                            name: 'ipinfo.io',
                            url: 'https://ipinfo.io/json',
                            parser: (data) => {
                                const [lat, lng] = data.loc.split(',').map(parseFloat);
                                return {
                                    lat: lat,
                                    lng: lng,
                                    city: data.city,
                                    country: data.country
                                };
                            }
                        }
                    ];
                    
                    for (const api of apis) {
                        try {
                            console.log(`尝试使用 ${api.name} API 进行IP定位...`);
                            
                            const response = await fetch(api.url, {
                                method: 'GET',
                                headers: {
                                    'Accept': 'application/json'
                                },
                                signal: AbortSignal.timeout(5000) // 5秒超时
                            });
                            
                            if (response.ok) {
                                const data = await response.json();
                                const location = api.parser(data);
                                
                                if (location.lat && location.lng && !isNaN(location.lat) && !isNaN(location.lng)) {
                                    console.log(`${api.name} IP定位成功:`, location);
                                    showStatus(`已通过${api.name}定位到${location.city || ''}${location.country || ''}`, 2000, 'success');
                                    return [location.lng, location.lat];
                                }
                            }
                        } catch (error) {
                            console.log(`${api.name} IP定位API失败:`, error);
                            continue;
                        }
                    }
                    
                    throw new Error('所有IP定位API都失败了');
                    
                } catch (error) {
                    console.log('IP定位失败:', error);
                    showStatus("所有IP定位API都失败，正在尝试浏览器定位...", 2000, 'warning');
                    return null;
                }
            }
            
            // 自动获取用户位置并搜索最近的小学（优先使用浏览器定位）
            async function autoFindNearestSchool() {
                showStatus("正在获取您的位置并搜索最近的小学...", 2000, 'info');
                
                // 第一优先级：尝试浏览器GPS精确定位
                if (navigator.geolocation) {
                    showStatus("正在尝试浏览器GPS精确定位...", 2000, 'info');
                    
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const userLat = position.coords.latitude;
                            const userLng = position.coords.longitude;
                            const userPosition = [userLng, userLat];
                            
                            showStatus("浏览器GPS定位成功，正在搜索最近的小学...", 2000, 'success');
                            findNearestSchool(userPosition);
                        },
                        async function(error) {
                            // 浏览器GPS定位失败，尝试IP定位
                            console.log("浏览器GPS定位失败，尝试IP定位", error);
                            
                            let errorMsg = "浏览器定位失败";
                            if (error.code === error.PERMISSION_DENIED) {
                                errorMsg = "位置权限被拒绝，尝试IP定位";
                            } else if (error.code === error.POSITION_UNAVAILABLE) {
                                errorMsg = "位置信息不可用，尝试IP定位";
                            } else if (error.code === error.TIMEOUT) {
                                errorMsg = "浏览器定位超时，尝试IP定位";
                            }
                            showStatus(errorMsg, 2000, 'warning');
                            
                            // 第二优先级：尝试IP定位（使用ip.sb等API）
                            const ipPosition = await getLocationByIP();
                            if (ipPosition) {
                                showStatus("IP定位成功，正在搜索最近的小学...", 2000, 'success');
                                findNearestSchool(ipPosition);
                                return;
                            }
                            
                            // 所有定位方式都失败，使用默认位置
                            const defaultPosition = [116.433293, 39.905301]; // 北京天安门
                            findNearestSchool(defaultPosition);
                            showStatus("所有定位方式都失败，已显示北京地区的小学", 4000, 'warning');
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 8000,
                            maximumAge: 60000
                        }
                    );
                } else {
                    // 浏览器不支持地理位置，尝试IP定位
                    showStatus("浏览器不支持定位功能，尝试IP定位...", 2000, 'warning');
                    
                    // 第二优先级：尝试IP定位（使用ip.sb等API）
                    const ipPosition = await getLocationByIP();
                    if (ipPosition) {
                        showStatus("IP定位成功，正在搜索最近的小学...", 2000, 'success');
                        findNearestSchool(ipPosition);
                        return;
                    }
                    
                    // 所有定位方式都失败，使用默认位置
                    const defaultPosition = [116.433293, 39.905301]; // 北京天安门
                    findNearestSchool(defaultPosition);
                    showStatus("所有定位方式都失败，已显示北京地区的小学", 4000, 'warning');
                }
            }
            
            // 搜索最近的小学并定位
            function findNearestSchool(center) {
                if (!placeSearch) {
                    showStatus("搜索功能未初始化，请刷新页面重试");
                    return;
                }
                
                // 保存当前位置
                currentLocation = center;
                
                // 设置搜索中心点
                placeSearch.searchNearBy('小学', center, 5000, function(status, result) {
                    if (status === 'complete' && result.poiList && result.poiList.pois.length > 0) {
                        const schools = result.poiList.pois;
                        
                        // 计算距离并找到最近的小学
                        const schoolsWithDistance = schools.map(school => {
                            const distance = calculateDistance(
                                center[1], center[0],
                                school.location.lat, school.location.lng
                            );
                            return { ...school, distance: distance };
                        }).sort((a, b) => a.distance - b.distance);
                        
                        if (schoolsWithDistance.length > 0) {
                            const nearestSchool = schoolsWithDistance[0];
                            const schoolPosition = [nearestSchool.location.lng, nearestSchool.location.lat];
                            
                            // 将地图中心定位到最近的小学
                            map.setCenter(schoolPosition);
                            map.setZoom(20); // 改为最大缩放级别
                            
                            // 添加最近小学的标记
                            const marker = new AMap.Marker({
                                position: schoolPosition,
                                icon: new AMap.Icon({
                                    size: new AMap.Size(25, 34),
                                    image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png'
                                }),
                                title: nearestSchool.name
                            });
                            
                            // 添加信息窗体
                            const infoWindow = new AMap.InfoWindow({
                                content: `
                                    <div style="padding: 10px;">
                                        <h4 style="margin: 0 0 5px 0; color: #333;">${nearestSchool.name}</h4>
                                        <p style="margin: 0; color: #666; font-size: 12px;">${nearestSchool.address || '地址信息不详'}</p>
                                        <p style="margin: 5px 0 0 0; color: #28a745; font-size: 12px;">距离: ${nearestSchool.distance.toFixed(0)}米</p>
                                    </div>
                                `,
                                offset: new AMap.Pixel(0, -30)
                            });
                            
                            marker.on('click', function() {
                                infoWindow.open(map, marker.getPosition());
                            });
                            
                            map.add(marker);
                            
                            showStatus(`已定位到最近的小学：${nearestSchool.name}`, 3000, 'success');
                            
                            // 获取位置信息
                            getLocationInfo(schoolPosition);
                        }
                    } else {
                        showStatus("附近没有找到小学，显示当前位置", 3000, 'warning');
                        map.setCenter(center);
                        getLocationInfo(center);
                    }
                });
            }
            
            // 获取位置信息（逆地理编码）
            function getLocationInfo(position) {
                geocoder.getAddress(position, function(status, result) {
                    if (status === 'complete' && result.regeocode) {
                        const addressComponent = result.regeocode.addressComponent;
                        const locationInfo = {
                            province: addressComponent.province,
                            city: addressComponent.city,
                            district: addressComponent.district
                        };
                        updateLocationInfo(locationInfo);
                    }
                });
            }
            
            // 搜索附近场所
            function searchNearbyPlaces(keyword, icon) {
                if (!currentLocationInfo || !currentLocationInfo.city) {
                    showStatus('请先获取位置信息', 2000, 'warning');
                    return;
                }
                
                const district = currentLocationInfo.district;
                const city = currentLocationInfo.city;
                const province = currentLocationInfo.province;
                
                // 机场、景点景区、体育中心搜索直接从市级范围开始
                if (keyword === '机场' || keyword === '景点景区' || keyword === '体育中心') {
                    showStatus(`正在${city}范围内搜索${keyword}...`, 2000, 'info');
                    searchInArea(keyword, icon, city, 'city');
                } else {
                    // 其他场所从区县范围开始搜索
                    showStatus(`正在${district}范围内搜索${keyword}...`, 2000, 'info');
                    searchInArea(keyword, icon, district, 'district');
                }
            }
            
            // 在指定区域内搜索
            function searchInArea(keyword, icon, areaName, areaType) {
                const searchKeyword = `${areaName} ${keyword}`;
                
                placeSearch.search(searchKeyword, function(status, result) {
                    if (status === 'complete' && result.poiList && result.poiList.pois.length > 0) {
                        const places = result.poiList.pois;
                        displaySearchResults(places, keyword, icon, areaName, areaType);
                    } else {
                        // 如果区县范围内没有找到，尝试在市级范围内搜索
                        if (areaType === 'district' && currentLocationInfo.city) {
                            showStatus(`${areaName}范围内未找到，正在${currentLocationInfo.city}范围内搜索...`, 2000, 'info');
                            searchInArea(keyword, icon, currentLocationInfo.city, 'city');
                        } 
                        // 如果市级范围内没有找到机场，尝试在省级范围内搜索
                        else if (areaType === 'city' && keyword === '机场' && currentLocationInfo.province) {
                            showStatus(`${areaName}范围内未找到，正在${currentLocationInfo.province}范围内搜索...`, 2000, 'info');
                            searchInArea(keyword, icon, currentLocationInfo.province, 'province');
                        } else {
                            showStatus(`${areaName}范围内没有找到${keyword}`, 3000, 'warning');
                        }
                    }
                });
            }
            
            // 显示搜索结果
            function displaySearchResults(places, keyword, icon, areaName, areaType) {
                // 清除之前的标记
                if (window.nearbyMarkers) {
                    window.nearbyMarkers.forEach(marker => map.remove(marker));
                }
                window.nearbyMarkers = [];
                
                // 过滤出距离当前位置合理范围内的结果，并排除不相关的POI类型
                const filteredPlaces = places.filter(place => {
                    if (!place.location) return false;
                    
                    // 距离过滤
                    const distance = calculateDistance(
                        currentLocation[1], currentLocation[0],
                        place.location.lat, place.location.lng
                    );
                    // 区县范围内限制在20公里，市级范围内限制在50公里
                    const maxDistance = areaType === 'district' ? 20000 : 50000;
                    if (distance > maxDistance) return false;
                    
                    // POI类型过滤 - 根据搜索关键词排除不相关类型
                    if (keyword === '体育中心') {
                        // 排除学校、医院、商店等不相关类型
                        const excludeTypes = ['小学', '中学', '学校', '医院', '诊所', '商店', '超市', '餐厅', '酒店'];
                        const placeName = place.name.toLowerCase();
                        const placeType = place.type || '';
                        
                        // 检查是否包含排除的类型
                        const hasExcludedType = excludeTypes.some(excludeType => 
                            placeName.includes(excludeType.toLowerCase()) || 
                            placeType.includes(excludeType)
                        );
                        
                        if (hasExcludedType) return false;
                        
                        // 确保包含体育相关关键词
                        const sportsKeywords = ['体育', '运动', '健身', '游泳', '篮球', '足球', '羽毛球', '乒乓球', '网球', '体育馆', '体育场', '体育中心'];
                        const hasSportsKeyword = sportsKeywords.some(keyword => 
                            placeName.includes(keyword.toLowerCase()) || 
                            placeType.includes(keyword)
                        );
                        
                        if (!hasSportsKeyword) return false;
                    }
                    
                    // 机场专用过滤逻辑
                    if (keyword === '机场') {
                        const placeName = place.name.toLowerCase();
                        const placeType = place.type || '';
                        const placeAddress = place.address || '';
                        
                        // 排除包含"路"、"街"、"道"等道路相关词汇的结果
                        const roadKeywords = ['路', '街', '道', '巷', '弄', '大道', '公路', '高速'];
                        const hasRoadKeyword = roadKeywords.some(roadKeyword => 
                            placeName.includes(roadKeyword) || placeAddress.includes(roadKeyword)
                        );
                        
                        if (hasRoadKeyword) return false;
                        
                        // 排除其他不相关类型
                        const excludeTypes = ['酒店', '宾馆', '餐厅', '商店', '超市', '加油站', '停车场', '汽车站', '火车站'];
                        const hasExcludedType = excludeTypes.some(excludeType => 
                            placeName.includes(excludeType) || 
                            placeType.includes(excludeType)
                        );
                        
                        if (hasExcludedType) return false;
                        
                        // 确保包含机场相关关键词
                        const airportKeywords = ['机场', 'airport', '航空', '航站楼', '候机楼'];
                        const hasAirportKeyword = airportKeywords.some(airportKeyword => 
                            placeName.includes(airportKeyword.toLowerCase()) || 
                            placeType.includes(airportKeyword)
                        );
                        
                        if (!hasAirportKeyword) return false;
                    }
                    
                    return true;
                });
                
                // 按距离排序
                filteredPlaces.sort((a, b) => {
                    const distanceA = calculateDistance(
                        currentLocation[1], currentLocation[0],
                        a.location.lat, a.location.lng
                    );
                    const distanceB = calculateDistance(
                        currentLocation[1], currentLocation[0],
                        b.location.lat, b.location.lng
                    );
                    return distanceA - distanceB;
                });
                
                const areaTypeText = areaType === 'district' ? '区县' : '市级';
                
                if (filteredPlaces.length === 0) {
                    showStatus(`${areaName}(${areaTypeText})范围内没有找到${keyword}`, 3000, 'warning');
                    return;
                } else if (filteredPlaces.length === 1) {
                    // 只有一个结果时，直接定位过去
                    const place = filteredPlaces[0];
                    const distance = calculateDistance(
                        currentLocation[1], currentLocation[0],
                        place.location.lat, place.location.lng
                    );
                    
                    // 清除区域边界和色块
                    if (currentDistrictPolygon) {
                        map.remove(currentDistrictPolygon);
                        currentDistrictPolygon = null;
                    }
                    
                    // 直接定位到该位置
                    map.setCenter([place.location.lng, place.location.lat]);
                    map.setZoom(16);
                    
                    // 添加标记
                    const marker = new AMap.Marker({
                        position: [place.location.lng, place.location.lat],
                        icon: new AMap.Icon({
                            size: new AMap.Size(30, 40),
                            image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png'
                        }),
                        title: place.name
                    });
                    
                    const infoWindow = new AMap.InfoWindow({
                        content: `
                            <div style="padding: 10px;">
                                <h4 style="margin: 0 0 5px 0; color: #333;">${icon} ${place.name}</h4>
                                <p style="margin: 0; color: #666; font-size: 12px;">${place.address || '地址信息不详'}</p>
                                <p style="margin: 5px 0 0 0; color: #28a745; font-size: 12px;">距离: ${distance.toFixed(0)}米</p>
                                <p style="margin: 2px 0 0 0; color: #007bff; font-size: 11px;">搜索范围: ${areaName}</p>
                            </div>
                        `,
                        offset: new AMap.Pixel(0, -30)
                    });
                    
                    map.add(marker);
                    window.nearbyMarkers = [marker];
                    
                    // 自动打开信息窗口
                    setTimeout(() => {
                        infoWindow.open(map, marker.getPosition());
                    }, 500);
                    
                    showStatus(`已定位到${place.name}`, 3000, 'success');
                } else {
                    // 多个结果时，显示选择列表
                    showPlacesList(filteredPlaces, keyword, icon, areaName, areaTypeText);
                }
            }
            
            // 显示场所选择列表
            function showPlacesList(places, keyword, icon, areaName, areaTypeText) {
                // 移除之前的列表
                const existingList = document.getElementById('places-list');
                if (existingList) {
                    existingList.remove();
                }
                
                // 移除之前的遮罩层
                const existingOverlay = document.getElementById('places-overlay');
                if (existingOverlay) {
                    existingOverlay.remove();
                }
                
                // 创建遮罩层
                const overlay = document.createElement('div');
                overlay.id = 'places-overlay';
                overlay.className = 'places-overlay';
                
                // 创建列表容器
                const listContainer = document.createElement('div');
                listContainer.id = 'places-list';
                listContainer.className = 'places-list';
                
                // 创建标题
                const header = document.createElement('div');
                header.className = 'places-list-header';
                header.innerHTML = `
                    <div class="places-list-header-inner">
                        <h3 class="places-list-title">${icon} ${keyword} (${places.length}个)</h3>
                        <button id="close-places-list" class="places-list-close">×</button>
                    </div>
                    <p class="places-list-subtitle">搜索范围: ${areaName}(${areaTypeText})</p>
                `;
                
                // 创建列表内容
                const listContent = document.createElement('div');
                listContent.className = 'places-list-content';
                
                // 关闭列表和遮罩层的函数
                const closeList = () => {
                    listContainer.remove();
                    overlay.remove();
                };
                
                places.slice(0, 10).forEach((place, index) => {
                    const distance = calculateDistance(
                        currentLocation[1], currentLocation[0],
                        place.location.lat, place.location.lng
                    );
                    
                    const item = document.createElement('div');
                    item.className = 'places-list-item';
                    
                    item.innerHTML = `
                        <div class="places-list-item-name">${place.name}</div>
                        <div class="places-list-item-address">${place.address || '地址信息不详'}</div>
                        <div class="places-list-item-distance">距离: ${distance.toFixed(0)}米</div>
                    `;
                    
                    item.addEventListener('click', () => {
                        navigateToPlace(place, icon);
                        closeList(); // 关闭列表和遮罩层
                    });
                    
                    listContent.appendChild(item);
                });
                
                listContainer.appendChild(header);
                listContainer.appendChild(listContent);
                
                // 添加到页面
                document.body.appendChild(overlay);
                document.body.appendChild(listContainer);
                
                // 点击背景关闭
                overlay.addEventListener('click', closeList);
                
                // 关闭按钮事件 - 确保元素已添加到DOM后再绑定事件
                const closeButton = document.getElementById('close-places-list');
                if (closeButton) {
                    closeButton.addEventListener('click', closeList);
                }
                
                showStatus(`找到${places.length}个${keyword}，请选择要前往的地点`, 3000, 'info');
            }
            
            // 导航到指定场所
            function navigateToPlace(place, icon) {
                // 清除之前的标记
                if (window.nearbyMarkers) {
                    window.nearbyMarkers.forEach(marker => map.remove(marker));
                }
                window.nearbyMarkers = [];
                
                // 清除区域边界和色块
                if (currentDistrictPolygon) {
                    map.remove(currentDistrictPolygon);
                    currentDistrictPolygon = null;
                }
                
                const distance = calculateDistance(
                    currentLocation[1], currentLocation[0],
                    place.location.lat, place.location.lng
                );
                
                // 定位到该位置
                map.setCenter([place.location.lng, place.location.lat]);
                map.setZoom(16);
                
                // 添加标记
                const marker = new AMap.Marker({
                    position: [place.location.lng, place.location.lat],
                    icon: new AMap.Icon({
                        size: new AMap.Size(30, 40),
                        image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png'
                    }),
                    title: place.name
                });
                
                const infoWindow = new AMap.InfoWindow({
                    content: `
                        <div style="padding: 10px;">
                            <h4 style="margin: 0 0 5px 0; color: #333;">${icon} ${place.name}</h4>
                            <p style="margin: 0; color: #666; font-size: 12px;">${place.address || '地址信息不详'}</p>
                            <p style="margin: 5px 0 0 0; color: #28a745; font-size: 12px;">距离: ${distance.toFixed(0)}米</p>
                        </div>
                    `,
                    offset: new AMap.Pixel(0, -30)
                });
                
                map.add(marker);
                window.nearbyMarkers = [marker];
                
                // 自动打开信息窗口
                setTimeout(() => {
                    infoWindow.open(map, marker.getPosition());
                }, 500);
                
                showStatus(`已定位到${place.name}`, 3000, 'success');
            }
            
            // 显示区域信息
            function showLocationArea(areaName, type) {
                
                // 清除之前的行政区域多边形
                if (currentDistrictPolygon) {
                    map.remove(currentDistrictPolygon);
                    currentDistrictPolygon = null;
                }
                
                let zoomLevel = 10;
                if (type === 'district') zoomLevel = 10;
                else if (type === 'city') zoomLevel = 8;
                else if (type === 'province') zoomLevel = 6;
                else if (type === 'country') zoomLevel = 4;
                
                // 搜索并绘制行政区域边界
                if (districtSearch) {
                    // 设置搜索级别
                    let searchLevel = 'district';
                    if (type === 'city') searchLevel = 'city';
                    else if (type === 'province') searchLevel = 'province';
                    else if (type === 'country') searchLevel = 'country';
                    
                    districtSearch.setLevel(searchLevel);
                    
                    districtSearch.search(areaName, function(status, result) {
                        if (status === 'complete' && result.districtList && result.districtList.length > 0) {
                            const district = result.districtList[0];
                            const boundaries = district.boundaries;
                            
                            if (boundaries && boundaries.length > 0) {
                                // 创建多边形样式
                                let polygonOptions = {
                                    strokeWeight: 2,
                                    fillOpacity: 0.2,
                                    strokeOpacity: 0.8,
                                    strokeStyle: 'solid'
                                };
                                
                                // 根据行政级别设置不同的颜色
                                if (type === 'district') {
                                    polygonOptions.strokeColor = '#FF6B6B';
                                    polygonOptions.fillColor = '#FF6B6B';
                                } else if (type === 'city') {
                                    polygonOptions.strokeColor = '#4ECDC4';
                                    polygonOptions.fillColor = '#4ECDC4';
                                } else if (type === 'province') {
                                    polygonOptions.strokeColor = '#45B7D1';
                                    polygonOptions.fillColor = '#45B7D1';
                                } else if (type === 'country') {
                                    polygonOptions.strokeColor = '#FFD93D';
                                    polygonOptions.fillColor = '#FFD93D';
                                }
                                
                                // 创建多边形
                                const polygons = [];
                                let totalArea = 0;
                                boundaries.forEach(boundary => {
                                    const polygon = new AMap.Polygon({
                                        path: boundary,
                                        ...polygonOptions,
                                        cursor: 'pointer'
                                    });
                                    
                                    // 优化面积计算 - 使用更精确的椭球面计算
                                    let polygonArea;
                                    try {
                                        // 使用高德地图的椭球面积计算方法
                                        polygonArea = AMap.GeometryUtil.ringArea(boundary);
                                        
                                        // 对于大面积区域，应用地球曲率修正
                                        if (polygonArea > 10000000000) { // 大于10000平方千米
                                            // 应用椭球面修正系数
                                            const sphericalCorrection = 1.0003; // 椭球面修正
                                            polygonArea *= sphericalCorrection;
                                        }
                                        
                                        // 坐标系精度修正（GCJ-02坐标系）
                                        const coordinateCorrection = 0.9996; // GCJ-02坐标系修正
                                        polygonArea *= coordinateCorrection;
                                        
                                    } catch (error) {
                                        console.warn('面积计算出错，使用备用方法:', error);
                                        // 备用计算方法
                                        polygonArea = calculatePolygonAreaFallback(boundary);
                                    }
                                    
                                    totalArea += polygonArea;
                                    
                                    // 为每个多边形添加点击事件
                                    polygon.on('click', function(e) {
                                        // 阻止事件冒泡到地图
                                        if (e && e.stopPropagation) {
                                            e.stopPropagation();
                                        }
                                        
                                        // 显示该行政区域的面积信息
                                        showDistrictAreaInfo(areaName, totalArea, type);
                                        
                                        // 高亮被点击的多边形
                                        highlightClickedPolygon(polygon, polygons);
                                        
                                        return false;
                                    });
                                    
                                    // 添加鼠标悬停效果
                                    polygon.on('mouseover', function() {
                                        polygon.setOptions({
                                            fillOpacity: 0.4,
                                            strokeWeight: 3
                                        });
                                    });
                                    
                                    polygon.on('mouseout', function() {
                                        polygon.setOptions({
                                            fillOpacity: 0.2,
                                            strokeWeight: 2
                                        });
                                    });
                                    
                                    polygons.push(polygon);
                                });
                                
                                // 添加到地图
                                map.add(polygons);
                                currentDistrictPolygon = polygons;
                                
                                // 根据区域大小动态调整缩放级别
                                if (boundaries.length > 0) {
                                    // 使用 setFitView 自动适配已添加的多边形视野，避免手动构造 Bounds 可能导致的异常
                                    setTimeout(() => {
                                        // 立即适配视野，避免动画分步效果
                                        map.setFitView(polygons, false);
                                        
                                        // 计算目标中心：以区域边界范围（包络盒）的中心为准
                                        let targetCenter = null;
                                        let minLng = Infinity, minLat = Infinity, maxLng = -Infinity, maxLat = -Infinity;
                                        boundaries.forEach(boundary => {
                                            boundary.forEach(pt => {
                                                const lng = (typeof pt.lng === 'number') ? pt.lng : (pt.getLng ? pt.getLng() : (Array.isArray(pt) ? pt[0] : undefined));
                                                const lat = (typeof pt.lat === 'number') ? pt.lat : (pt.getLat ? pt.getLat() : (Array.isArray(pt) ? pt[1] : undefined));
                                                if (typeof lng === 'number' && typeof lat === 'number') {
                                                    if (lng < minLng) minLng = lng;
                                                    if (lng > maxLng) maxLng = lng;
                                                    if (lat < minLat) minLat = lat;
                                                    if (lat > maxLat) maxLat = lat;
                                                }
                                            });
                                        });
                                        if (isFinite(minLng) && isFinite(maxLng) && isFinite(minLat) && isFinite(maxLat)) {
                                            targetCenter = [(minLng + maxLng) / 2, (minLat + maxLat) / 2];
                                        } else if (district.center && typeof district.center.lng === 'number' && typeof district.center.lat === 'number') {
                                            // 边界点异常时回退到行政区中心
                                            targetCenter = [district.center.lng, district.center.lat];
                                        } else {
                                            // 再次回退到当前地图中心
                                            targetCenter = map.getCenter();
                                        }
                                        
                                        // 一次性设置最终缩放与中心：保证至少达到目标缩放级别，并将地区中心置于浏览器中心
                                        const fittedZoom = map.getZoom();
                                        const finalZoom = Math.max(fittedZoom, zoomLevel);
                                        map.setZoomAndCenter(finalZoom, targetCenter);
                                    }, 100);
                                } else {
                                    // 调整地图视野以适应区域
                                    if (district.center) {
                                        // 使用setZoomAndCenter方法
                                        map.setZoomAndCenter(zoomLevel, [district.center.lng, district.center.lat]);
                                    } else {
                                        // 使用setZoomAndCenter方法，保持当前中心点
                                        map.setZoomAndCenter(zoomLevel, map.getCenter());
                                    }
                                }
                                
                                showStatus(`已显示${areaName}边界`, 2000, 'success');
                            } else {
                                // 没有边界数据时，先定位到区域中心，再设置缩放
                                if (district.center) {
                                    map.setCenter([district.center.lng, district.center.lat]);
                                    map.setZoom(zoomLevel);
                                } else {
                                    // 如果没有中心点，尝试通过地理编码获取位置
                                    geocoder.getLocation(areaName, function(status, result) {
                                        if (status === 'complete' && result.geocodes && result.geocodes.length > 0) {
                                            const location = result.geocodes[0].location;
                                            map.setZoomAndCenter(zoomLevel, [location.lng, location.lat]);
                                        } else {
                                            map.setZoomAndCenter(zoomLevel, map.getCenter());
                                        }
                                    });
                                }
                                showStatus(`已切换到${areaName}视图（无边界数据）`, 2000, 'warning');
                            }
                        } else {
                            // 搜索失败时，尝试通过地理编码获取位置
                            geocoder.getLocation(areaName, function(status, result) {
                                if (status === 'complete' && result.geocodes && result.geocodes.length > 0) {
                                    const location = result.geocodes[0].location;
                                    map.setZoomAndCenter(zoomLevel, [location.lng, location.lat]);
                                    showStatus(`已定位到${areaName}`, 2000, 'success');
                                } else {
                                    map.setZoomAndCenter(zoomLevel, map.getCenter());
                                    showStatus(`无法获取${areaName}位置信息`, 2000, 'warning');
                                }
                            });
                        }
                    });
                } else {
                    // 如果districtSearch不可用，尝试通过地理编码获取位置
                    geocoder.getLocation(areaName, function(status, result) {
                        if (status === 'complete' && result.geocodes && result.geocodes.length > 0) {
                            const location = result.geocodes[0].location;
                            map.setZoomAndCenter(zoomLevel, [location.lng, location.lat]);
                            showStatus(`已定位到${areaName}`, 2000, 'success');
                        } else {
                            map.setZoomAndCenter(zoomLevel, map.getCenter());
                            showStatus(`已切换到${areaName}视图`, 2000, 'success');
                        }
                    });
                }
            }
            
            // 备用面积计算方法（使用Shoelace公式）
            function calculatePolygonAreaFallback(boundary) {
                if (!boundary || boundary.length < 3) return 0;
                
                let area = 0;
                const n = boundary.length;
                
                for (let i = 0; i < n; i++) {
                    const j = (i + 1) % n;
                    const xi = boundary[i].lng || boundary[i][0];
                    const yi = boundary[i].lat || boundary[i][1];
                    const xj = boundary[j].lng || boundary[j][0];
                    const yj = boundary[j].lat || boundary[j][1];
                    
                    area += xi * yj;
                    area -= xj * yi;
                }
                
                area = Math.abs(area) / 2;
                
                // 将度数转换为米（近似）
                // 1度经度 ≈ 111320米 * cos(纬度)
                // 1度纬度 ≈ 110540米
                const avgLat = boundary.reduce((sum, point) => {
                    return sum + (point.lat || point[1]);
                }, 0) / boundary.length;
                
                const latToMeter = 110540;
                const lngToMeter = 111320 * Math.cos(avgLat * Math.PI / 180);
                
                return area * latToMeter * lngToMeter;
            }
            
            // 官方面积数据映射表（单位：平方千米）
            const officialAreaData = {
                // 国家
                '中华人民共和国': 9600000,
                '中国': 9600000,
                
                // 直辖市
                '北京市': 16410.54,
                '上海市': 6340.5,
                '天津市': 11916.85,
                '重庆市': 82402.95,
                
                // 省份（部分主要省份）
                '广东省': 179800,
                '新疆维吾尔自治区': 1664897,
                '内蒙古自治区': 1183000,
                '西藏自治区': 1228400,
                '青海省': 722300,
                '四川省': 486000,
                '黑龙江省': 473000,
                '甘肃省': 425800,
                '云南省': 394100,
                '广西壮族自治区': 236700,
                '湖南省': 211800,
                '陕西省': 205600,
                '河北省': 188800,
                '吉林省': 187400,
                '湖北省': 185900,
                '广东省': 179800,
                '贵州省': 176167,
                '江西省': 166900,
                '河南省': 167000,
                '山西省': 156700,
                '山东省': 157100,
                '辽宁省': 148000,
                '安徽省': 140100,
                '福建省': 124000,
                '江苏省': 107200,
                '浙江省': 105500,
                '宁夏回族自治区': 66400,
                '海南省': 35400,
                
                // 主要城市
                '深圳市': 1997.47,
                '广州市': 7434.4,
                '杭州市': 16853.57,
                '成都市': 14335,
                '武汉市': 8569.15,
                '西安市': 10108,
                '南京市': 6587.02,
                '青岛市': 11293,
                '大连市': 12573.85,
                '宁波市': 9816,
                '厦门市': 1699.39,
                '济南市': 10244.45,
                '沈阳市': 12860,
                '长沙市': 11819,
                '哈尔滨市': 53100,
                '石家庄市': 15722,
                '呼和浩特市': 17224,
                '兰州市': 13085.6,
                '银川市': 9025.38,
                '西宁市': 7660,
                '乌鲁木齐市': 14216.3,
                '拉萨市': 31662,
                '昆明市': 21473,
                '贵阳市': 8034,
                '南宁市': 22112,
                '海口市': 3145.93,
                '南昌市': 7402.36,
                '长春市': 24744,
                '福州市': 12154,
                '郑州市': 7567.18,
                '太原市': 6988,
                '合肥市': 11445.1
            };
            
            // 显示行政区域面积信息
            function showDistrictAreaInfo(areaName, calculatedArea, type) {
                // 检查是否有官方数据
                const officialArea = officialAreaData[areaName];
                let finalArea, dataSource;
                
                if (officialArea) {
                    // 使用官方数据（已经是平方千米）
                    finalArea = officialArea * 1000000; // 转换为平方米用于统一计算
                    dataSource = '官方数据';
                } else {
                    // 使用计算数据，应用修正系数
                    const correctionFactor = 0.98; // 经验修正系数，减少约2%的偏差
                    finalArea = calculatedArea * correctionFactor;
                    dataSource = '地图计算';
                }
                
                // 转换单位
                const hectares = finalArea / 10000; // 公顷
                const squareKm = finalArea / 1000000; // 平方千米
                
                // 根据行政级别设置不同的图标
                let icon = '🏘️';
                if (type === 'city') icon = '🏙️';
                else if (type === 'province') icon = '🗺️';
                else if (type === 'country') icon = '🇨🇳';
                
                // 格式化显示
                areaValue.textContent = `${icon} ${areaName}`;
                
                areaConversions.innerHTML = `
                    <div class="unit-option" data-unit="squareMeters">约 ${formatArea(finalArea)} 平方米</div>
                    <div class="unit-option" data-unit="hectares">约 ${formatArea(hectares)} 公顷</div>
                    <div class="unit-option" data-unit="squareKm">约 ${formatArea(squareKm)} 平方千米</div>
                    <div class="area-data-source" style="font-size: 12px; color: #666; margin-top: 8px; padding: 4px 8px; background: #f5f5f5; border-radius: 4px;">
                        数据来源: ${dataSource} ${officialArea ? '✓' : '(估算)'}
                    </div>
                `;
                
                // 添加点击事件监听器
                const unitOptions = areaConversions.querySelectorAll('.unit-option');
                unitOptions.forEach(option => {
                    option.addEventListener('click', function() {
                        // 移除所有active类
                        unitOptions.forEach(opt => opt.classList.remove('active'));
                        areaValue.classList.remove('active');
                        
                        // 添加active类到被点击的元素
                        this.classList.add('active');
                    });
                });
                
                areaInfo.style.display = 'block';
                
                // 显示成功消息
                const accuracyNote = officialArea ? '' : '(估算值)';
                showStatus(`${areaName}面积：${formatArea(squareKm)} 平方千米 ${accuracyNote}`, 4000, 'success');
            }
            
            // 高亮被点击的多边形
            function highlightClickedPolygon(clickedPolygon, allPolygons) {
                // 重置所有多边形样式
                allPolygons.forEach(polygon => {
                    const originalOptions = polygon.getOptions();
                    polygon.setOptions({
                        fillOpacity: 0.2,
                        strokeWeight: 2,
                        strokeOpacity: 0.8
                    });
                });
                
                // 高亮被点击的多边形
                clickedPolygon.setOptions({
                    fillOpacity: 0.5,
                    strokeWeight: 4,
                    strokeOpacity: 1
                });
            }
            
            // 更新位置信息显示
            function updateLocationInfo(locationInfo) {
                currentLocationInfo = locationInfo;
                
                if (locationInfo.district) {
                    document.getElementById('district-text').textContent = locationInfo.district;
                }
                if (locationInfo.city) {
                    document.getElementById('city-text').textContent = locationInfo.city;
                }
                if (locationInfo.province) {
                    document.getElementById('province-text').textContent = locationInfo.province;
                }
            }
            
            // 计算两点间距离（米）
            function calculateDistance(lat1, lng1, lat2, lng2) {
                const R = 6371000; // 地球半径（米）
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLng = (lng1 - lng2) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                        Math.sin(dLng/2) * Math.sin(dLng/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }
            
            // 搜索目的地
            function searchDestination() {
                const keyword = destinationInput.value.trim();
                if (!keyword) {
                    showStatus('请输入目的地名称或地址', 2000, 'warning');
                    return;
                }
                
                showStatus(`正在搜索"${keyword}"...`, 2000, 'info');
                
                // 使用地理编码搜索
                geocoder.getLocation(keyword, function(status, result) {
                    if (status === 'complete' && result.geocodes && result.geocodes.length > 0) {
                        const geocodes = result.geocodes;
                        
                        if (geocodes.length === 1) {
                            // 只有一个结果，直接定位
                            const location = geocodes[0];
                            navigateToDestination(location, keyword);
                        } else {
                            // 多个结果，显示选择列表
                            displayDestinationResults(geocodes, keyword);
                        }
                    } else {
                        // 地理编码失败，尝试POI搜索
                        placeSearch.search(keyword, function(status, result) {
                            if (status === 'complete' && result.poiList && result.poiList.pois.length > 0) {
                                const places = result.poiList.pois;
                                
                                if (places.length === 1) {
                                    // 只有一个结果，直接定位
                                    navigateToPlace(places[0], '📍');
                                } else {
                                    // 多个结果，显示选择列表
                                    displaySearchResults(places, keyword, '📍', '全国', 'country');
                                }
                            } else {
                                showStatus(`未找到"${keyword}"相关位置`, 3000, 'warning');
                            }
                        });
                    }
                });
                
                // 关闭更多面板
                morePanel.classList.remove('show');
            }
            
            // 定位到目的地
            function navigateToDestination(location, keyword) {
                // 清除区域边界和色块
                if (currentDistrictPolygon) {
                    map.remove(currentDistrictPolygon);
                    currentDistrictPolygon = null;
                }
                
                // 清除之前的标记
                if (window.nearbyMarkers) {
                    window.nearbyMarkers.forEach(marker => map.remove(marker));
                }
                window.nearbyMarkers = [];
                
                // 定位到该位置
                map.setCenter([location.location.lng, location.location.lat]);
                map.setZoom(16);
                
                // 添加标记
                const marker = new AMap.Marker({
                    position: [location.location.lng, location.location.lat],
                    icon: new AMap.Icon({
                        size: new AMap.Size(30, 40),
                        image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png'
                    }),
                    title: location.formattedAddress || keyword
                });
                
                const infoWindow = new AMap.InfoWindow({
                    content: `
                        <div style="padding: 10px;">
                            <h4 style="margin: 0 0 5px 0; color: #333;">📍 ${location.formattedAddress || keyword}</h4>
                            <p style="margin: 0; color: #666; font-size: 12px;">${location.addressComponent ? 
                                `${location.addressComponent.province || ''} ${location.addressComponent.city || ''} ${location.addressComponent.district || ''}` : 
                                '详细地址信息'}</p>
                        </div>
                    `,
                    offset: new AMap.Pixel(0, -30)
                });
                
                map.add(marker);
                window.nearbyMarkers = [marker];
                
                // 自动打开信息窗口
                setTimeout(() => {
                    infoWindow.open(map, marker.getPosition());
                }, 500);
                
                showStatus(`已定位到${location.formattedAddress || keyword}`, 3000, 'success');
                
                // 清空输入框
                destinationInput.value = '';
            }
            
            // 显示目的地搜索结果列表
            function displayDestinationResults(geocodes, keyword) {
                // 创建遮罩层
                const overlay = document.createElement('div');
                overlay.className = 'places-overlay';
                
                // 创建列表容器
                const listContainer = document.createElement('div');
                listContainer.className = 'places-list';
                
                // 创建标题
                const header = document.createElement('div');
                header.className = 'places-list-header';
                header.innerHTML = `
                    <div class="places-list-header-content">
                        <h3 class="places-list-title">📍 ${keyword} (${geocodes.length}个)</h3>
                        <button id="close-destination-list" class="places-list-close">×</button>
                    </div>
                    <p class="places-list-subtitle">搜索结果</p>
                `;
                
                // 创建列表内容
                const listContent = document.createElement('div');
                listContent.className = 'places-list-content';
                
                // 关闭列表和遮罩层的函数
                const closeList = () => {
                    listContainer.remove();
                    overlay.remove();
                };
                
                geocodes.slice(0, 10).forEach((location, index) => {
                    const item = document.createElement('div');
                    item.className = 'places-list-item';
                    
                    item.innerHTML = `
                        <div class="places-list-item-name">${location.formattedAddress}</div>
                        <div class="places-list-item-address">${location.addressComponent ? 
                            `${location.addressComponent.province || ''} ${location.addressComponent.city || ''} ${location.addressComponent.district || ''}` : 
                            '详细地址信息'}</div>
                    `;
                    
                    item.addEventListener('click', () => {
                        navigateToDestination(location, keyword);
                        closeList();
                    });
                    
                    listContent.appendChild(item);
                });
                
                listContainer.appendChild(header);
                listContainer.appendChild(listContent);
                
                // 添加到页面
                document.body.appendChild(overlay);
                document.body.appendChild(listContainer);
                
                // 点击背景关闭
                overlay.addEventListener('click', closeList);
                
                // 关闭按钮事件
                const closeButton = document.getElementById('close-destination-list');
                if (closeButton) {
                    closeButton.addEventListener('click', closeList);
                }
                
                showStatus(`找到${geocodes.length}个"${keyword}"相关位置，请选择`, 3000, 'info');
             }
             
             // 初始化
             initMap();
         });
     </script>
 </body>
 </html>