<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬é¡·å’Œå¹³æ–¹åƒç±³</title>
    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: '0b71da9c4b2abe5d30da60fccd70f788'
        };
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            /* é˜²æ­¢ç§»åŠ¨ç«¯ç‚¹å‡»é—ªçƒ */
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        body {
            height: 100vh;
            overflow: hidden;
        }
        
        #mapContainer {
            width: 100%;
            height: 100vh;
            cursor: crosshair;
        }
        
        .control-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 180px;
            backdrop-filter: blur(10px);
        }
        
        .area-info {
            margin-top: 12px;
        }
        
        .area-info h3 {
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .drawing-controls {
            border-bottom: 1px solid #eee;
            margin-bottom: 0;
            display: flex;
            gap: 8px;
        }
        
        .control-btn {
            background: #4b6cb7;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 0;
            flex: 1;
        }
        
        .area-value {
            font-size: 28px;
            font-weight: 600;
            color: #4b6cb7;
            margin: 6px 0;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .area-value:hover {
            background-color: #f0f0f0;
        }
        
        .area-conversions {
            font-size: 28px;
            color: #666;
            line-height: 1.3;
        }
        
        .area-conversions div {
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.3s ease;
            margin: 2px 0;
        }
        
        .area-conversions div:hover {
            background-color: #f0f0f0;
            color: #4b6cb7;
        }
        
        .area-conversions div.active {
            font-size: 36px;
            font-weight: 600;
            color: #4b6cb7;
            background-color: #f8f9ff;
            border: 1px solid #4b6cb7;
            margin: 6px 0;
        }
        
        .control-btn:hover {
            background: #3a5a9e;
            transform: translateY(-1px);
        }
        
        .control-btn.active {
            background: #28a745;
        }
        
        .status-message {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 1000;
            display: none;
            font-size: 14px;
        }
        
        .drawing-polygon {
            stroke: #ff4757;
            stroke-width: 3;
            fill: rgba(255, 71, 87, 0.3);
        }
        
        .drawing-point {
            fill: #ff4757;
            stroke: white;
            stroke-width: 2;
        }
        
        .more-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            color: #333;
        }
        
        .more-btn:hover {
            background-color: rgba(255, 255, 255, 1);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .more-btn:active {
            transform: scale(0.95);
        }
        
        .more-panel {
            position: absolute;
            bottom: 80px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 999;
            backdrop-filter: blur(10px);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px) scale(0.95);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .more-panel.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        
        .more-panel-content {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .button-row {
            display: flex;
            gap: 8px;
        }
        
        .more-option-btn {
            flex: 1;
            background: none;
            border: none;
            padding: 12px 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 4px;
            font-size: 12px;
            color: #333;
            min-height: 60px;
        }
        
        .more-option-btn:hover {
            background-color: rgba(75, 108, 183, 0.1);
            color: #4b6cb7;
        }
        
        .more-option-btn:active {
            transform: scale(0.98);
        }
        
        .option-icon {
            font-size: 20px;
            width: auto;
            text-align: center;
        }
        
        .option-text {
            text-align: center;
            font-weight: 500;
            line-height: 1.2;
        }
        
        .location-info {
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            margin-top: 8px;
            padding-top: 8px;
        }
        
        .location-btn {
            font-size: 11px;
            min-height: 50px;
        }
        
        .location-btn .option-icon {
            font-size: 18px;
        }

        /* ç›®çš„åœ°è¾“å…¥æ¡†æ ·å¼ */
        .destination-input-container {
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            margin-top: 8px;
            padding-top: 12px;
        }
        
        .destination-input-wrapper {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .destination-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s ease;
        }
        
        .destination-input:focus {
            border-color: #4b6cb7;
            box-shadow: 0 0 0 2px rgba(75, 108, 183, 0.1);
        }
        
        .destination-search-btn {
            padding: 10px 16px;
            background: #4b6cb7;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
        
        .destination-search-btn:hover {
            background: #3a5a9e;
        }
        
        .destination-search-btn:active {
            transform: scale(0.98);
        }
        
        /* é¢„è®¾åœ°ç‚¹æŒ‰é’®æ ·å¼ */
        .preset-locations {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        
        .preset-location-btn {
            padding: 6px 12px;
            background: rgba(75, 108, 183, 0.1);
            color: #4b6cb7;
            border: 1px solid rgba(75, 108, 183, 0.2);
            border-radius: 16px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .preset-location-btn:hover {
            background: rgba(75, 108, 183, 0.2);
            border-color: rgba(75, 108, 183, 0.4);
            transform: translateY(-1px);
        }
        
        .preset-location-btn:active {
            transform: translateY(0) scale(0.98);
        }

        /* åœºæ‰€é€‰æ‹©åˆ—è¡¨ä¸é®ç½©ç»Ÿä¸€æ ·å¼ */
        .places-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9998;
        }

        .places-list {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            width: 400px;
            max-height: 500px;
            overflow-y: auto;
            z-index: 9999;
            padding: 0;
        }

        .places-list-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
            border-radius: 10px 10px 0 0;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .places-list-header-inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .places-list-title {
            margin: 0;
            color: #333;
            font-size: 16px;
        }

        .places-list-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .places-list-subtitle {
            margin: 5px 0 0 0;
            color: #666;
            font-size: 12px;
        }

        .places-list-content {
            padding: 10px 0;
        }

        .places-list-item {
            padding: 12px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .places-list-item:hover {
            background-color: #f8f9fa;
        }

        .places-list-item-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }

        .places-list-item-address {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
        }

        .places-list-item-distance {
            font-size: 12px;
            color: #28a745;
        }
    </style>
</head>
<body>
    <div id="mapContainer"></div>
    
    <div class="control-panel" id="control-panel">
        <div class="drawing-controls">
            <button class="control-btn active" id="draw-btn">
                âœï¸ ç»˜åˆ¶
            </button>
            <button class="control-btn" id="clear-btn">
                ğŸ—‘ï¸ æ¸…é™¤
            </button>
        </div>
        
        <div class="area-info" id="area-info" style="display: none;">
            <h3>ğŸ“ åŒºåŸŸé¢ç§¯</h3>
            <div class="area-value" id="area-value">0 å¹³æ–¹ç±³</div>
            <div class="area-conversions" id="area-conversions">
                <div>0 å…¬é¡·</div>
                <div>0 å¹³æ–¹åƒç±³</div>
            </div>
        </div>
    </div>
    
    <div class="status-message" id="status-message"></div>
    
    <!-- æ›´å¤šæŒ‰é’® -->
    <button class="more-btn" id="more-btn" title="æ›´å¤šé€‰é¡¹">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
            <circle cx="12" cy="5" r="2"/>
            <circle cx="12" cy="12" r="2"/>
            <circle cx="12" cy="19" r="2"/>
        </svg>
    </button>
    
    <!-- æ›´å¤šæ§åˆ¶é¢æ¿ -->
    <div class="more-panel" id="more-panel">
        <div class="more-panel-content">
            <div class="button-row">
                <button class="more-option-btn" id="relocate-btn">
                    <span class="option-icon">ğŸ“</span>
                    <span class="option-text">é™„è¿‘å°å­¦</span>
                </button>
                <button class="more-option-btn" id="gym-btn">
                    <span class="option-icon">ğŸŸï¸</span>
                    <span class="option-text">é™„è¿‘ä½“è‚²é¦†</span>
                </button>
            </div>
            <div class="button-row">
                <button class="more-option-btn" id="airport-btn">
                    <span class="option-icon">âœˆï¸</span>
                    <span class="option-text">é™„è¿‘æœºåœº</span>
                </button>
                <button class="more-option-btn" id="attraction-btn">
                    <span class="option-icon">ğŸï¸</span>
                    <span class="option-text">é™„è¿‘æ™¯ç‚¹</span>
                </button>
            </div>
            <div class="location-info" id="location-info">
                <div class="button-row">
                    <button class="more-option-btn location-btn" id="district-btn">
                        <span class="option-icon">ğŸ˜ï¸</span>
                        <span class="option-text" id="district-text">è·å–åŒºå¿ä¿¡æ¯</span>
                    </button>
                    <button class="more-option-btn location-btn" id="city-btn">
                        <span class="option-icon">ğŸ™ï¸</span>
                        <span class="option-text" id="city-text">è·å–åŸå¸‚ä¿¡æ¯</span>
                    </button>
                </div>
                <div class="button-row">
                    <button class="more-option-btn location-btn" id="province-btn">
                        <span class="option-icon">ğŸ—ºï¸</span>
                        <span class="option-text" id="province-text">è·å–çœä»½ä¿¡æ¯</span>
                    </button>
                    <button class="more-option-btn location-btn" id="country-btn">
                        <span class="option-icon">ğŸ‡¨ğŸ‡³</span>
                        <span class="option-text" id="country-text">å…¨ä¸­å›½</span>
                    </button>
                </div>
            </div>
            
            <!-- ç›®çš„åœ°è¾“å…¥æ¡† -->
            <div class="destination-input-container">
                <div class="destination-input-wrapper">
                    <input type="text" class="destination-input" id="destination-input" placeholder="è¾“å…¥ç›®çš„åœ°åç§°æˆ–åœ°å€">
                    <button class="destination-search-btn" id="destination-search-btn">æœç´¢</button>
                </div>
                <!-- é¢„è®¾åœ°ç‚¹æŒ‰é’® -->
                <div class="preset-locations">
                    <button class="preset-location-btn" data-location="å¤©å®‰é—¨å¹¿åœº">å¤©å®‰é—¨å¹¿åœº</button>
                    <button class="preset-location-btn" data-location="æ•…å®«">æ•…å®«</button>
                    <button class="preset-location-btn" data-location="åŒ—äº¬å¸‚æœé˜³åŒºå›½å®¶ä½“è‚²åœº">é¸Ÿå·¢</button>
                </div>
            </div>
        </div>
    </div>

    <!-- é«˜å¾·åœ°å›¾API -->
    <script src="https://webapi.amap.com/maps?v=1.4.15&key=05bce3e045e35d9c8479155adbb6716c&plugin=AMap.Geocoder,AMap.PlaceSearch"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let map, geocoder, placeSearch;
            let isDrawing = false;
            let drawingPoints = [];
            let currentPolygon = null;
            let pointMarkers = [];
            
            // å­˜å‚¨æ‰€æœ‰ç»˜åˆ¶çš„åŒºåŸŸ
            let allPolygons = [];
            let currentActivePolygon = null;
            
            const drawBtn = document.getElementById('draw-btn');
            const clearBtn = document.getElementById('clear-btn');
            const moreBtn = document.getElementById('more-btn');
            const morePanel = document.getElementById('more-panel');
            const relocateBtn = document.getElementById('relocate-btn');
            const gymBtn = document.getElementById('gym-btn');
            const airportBtn = document.getElementById('airport-btn');
            const attractionBtn = document.getElementById('attraction-btn');
            const districtBtn = document.getElementById('district-btn');
            const cityBtn = document.getElementById('city-btn');
            const provinceBtn = document.getElementById('province-btn');
            const countryBtn = document.getElementById('country-btn');
            const destinationInput = document.getElementById('destination-input');
            const destinationSearchBtn = document.getElementById('destination-search-btn');
            const areaInfo = document.getElementById('area-info');
            const areaValue = document.getElementById('area-value');
            const areaConversions = document.getElementById('area-conversions');
            const statusMessage = document.getElementById('status-message');
            
            // å½“å‰ä½ç½®ä¿¡æ¯
            let currentLocation = null;
            let currentLocationInfo = null;
            let districtSearch = null; // è¡Œæ”¿åŒºåŸŸæœç´¢å¯¹è±¡
            let currentDistrictPolygon = null; // å½“å‰æ˜¾ç¤ºçš„è¡Œæ”¿åŒºåŸŸå¤šè¾¹å½¢
            
            // åˆå§‹åŒ–åœ°å›¾
            function initMap() {
                map = new AMap.Map('mapContainer', {
                    zoom: 20, // æ”¹ä¸ºæœ€å¤§ç¼©æ”¾çº§åˆ«
                    center: [39.91598,116.4006182],
                    viewMode: '2D',
                    resizeEnable: true
                });
                
                // åŠ è½½æ’ä»¶
                AMap.plugin(['AMap.Geocoder', 'AMap.PlaceSearch', 'AMap.Scale', 'AMap.DistrictSearch'], function() {
                    geocoder = new AMap.Geocoder({
                        city: "å…¨å›½"
                    });
                    
                    placeSearch = new AMap.PlaceSearch({
                        city: "å…¨å›½",
                        pageSize: 20,
                        pageIndex: 1,
                        extensions: 'all'
                    });
                    
                    // åˆå§‹åŒ–è¡Œæ”¿åŒºåŸŸæœç´¢
                    districtSearch = new AMap.DistrictSearch({
                        level: 'district',
                        extensions: 'all'
                    });
                    
                    // æ·»åŠ æ¯”ä¾‹å°ºæ§ä»¶
                    //const scale = new AMap.Scale({
                    //    position: 'LB', // å·¦ä¸‹è§’ä½ç½®
                    //    offset: new AMap.Pixel(10,10)
                    //});
                    //map.addControl(scale);
                });
                
                // åœ°å›¾ç‚¹å‡»äº‹ä»¶
                map.on('click', function(e) {
                    if (isDrawing) {
                        addDrawingPoint(e.lnglat);
                    }
                });
                
                // è‡ªåŠ¨å®šä½åˆ°æœ€è¿‘çš„å°å­¦
                setTimeout(() => {
                    autoFindNearestSchool();
                }, 1000);
            }
            
            // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
            function showStatus(message, duration = 3000, type = 'info') {
                statusMessage.textContent = message;
                statusMessage.style.display = 'block';
                
                // æ ¹æ®æ¶ˆæ¯ç±»å‹è®¾ç½®ä¸åŒçš„æ ·å¼
                statusMessage.className = 'status-message';
                if (type === 'error') {
                    statusMessage.style.backgroundColor = '#ff4757';
                    statusMessage.style.color = 'white';
                } else if (type === 'success') {
                    statusMessage.style.backgroundColor = '#2ed573';
                    statusMessage.style.color = 'white';
                } else if (type === 'warning') {
                    statusMessage.style.backgroundColor = '#ffa502';
                    statusMessage.style.color = 'white';
                } else {
                    statusMessage.style.backgroundColor = '#5352ed';
                    statusMessage.style.color = 'white';
                }
                
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, duration);
            }
            
            // å¼€å§‹/åœæ­¢ç»˜åˆ¶
            drawBtn.addEventListener('click', function() {
                if (isDrawing) {
                    // å®Œæˆç»˜åˆ¶
                    finishDrawing();
                } else {
                    // å¼€å§‹ç»˜åˆ¶
                    startDrawing();
                }
            });
            
            // æ¸…é™¤ç»˜åˆ¶
            clearBtn.addEventListener('click', function() {
                clearDrawing();
                showStatus('å·²æ¸…é™¤æ‰€æœ‰ç»˜åˆ¶å†…å®¹');
            });
            
            // é‡æ–°å®šä½æŒ‰é’®äº‹ä»¶
            relocateBtn.addEventListener('click', function() {
                // æ·»åŠ ç‚¹å‡»åŠ¨ç”»æ•ˆæœ
                relocateBtn.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    relocateBtn.style.transform = '';
                }, 150);
                
                // æ‰§è¡Œé‡æ–°å®šä½
                autoFindNearestSchool();
                // å…³é—­æ›´å¤šé¢æ¿
                morePanel.classList.remove('show');
            });
            
            // æ›´å¤šæŒ‰é’®äº‹ä»¶
            moreBtn.addEventListener('click', function() {
                morePanel.classList.toggle('show');
            });
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­æ›´å¤šé¢æ¿
            document.addEventListener('click', function(e) {
                if (!moreBtn.contains(e.target) && !morePanel.contains(e.target)) {
                    morePanel.classList.remove('show');
                }
            });
            
            // ä½“è‚²é¦†æŒ‰é’®äº‹ä»¶
            gymBtn.addEventListener('click', function() {
                if (currentLocation) {
                    searchNearbyPlaces('ä½“è‚²ä¸­å¿ƒ', 'ğŸŸï¸');
                } else {
                    showStatus('è¯·å…ˆè·å–ä½ç½®ä¿¡æ¯', 2000, 'warning');
                }
                morePanel.classList.remove('show');
            });
            
            // æœºåœºæŒ‰é’®äº‹ä»¶
            airportBtn.addEventListener('click', function() {
                if (currentLocation) {
                    searchNearbyPlaces('æœºåœº', 'âœˆï¸');
                } else {
                    showStatus('è¯·å…ˆè·å–ä½ç½®ä¿¡æ¯', 2000, 'warning');
                }
                morePanel.classList.remove('show');
            });

            // æ™¯ç‚¹æ™¯åŒºæŒ‰é’®äº‹ä»¶
            attractionBtn.addEventListener('click', function() {
                if (currentLocation) {
                    // å‚è€ƒå·²æœ‰é™„è¿‘ç‚¹å‡»äº‹ä»¶ï¼Œåˆ—è¡¨ä¸ç‚¹å‡»è‡ªåŠ¨å®šä½é€»è¾‘
                    searchNearbyPlaces('æ™¯ç‚¹æ™¯åŒº', 'ğŸï¸');
                } else {
                    showStatus('è¯·å…ˆè·å–ä½ç½®ä¿¡æ¯', 2000, 'warning');
                }
                morePanel.classList.remove('show');
            });
            
            // åŒºå¿æŒ‰é’®äº‹ä»¶
            districtBtn.addEventListener('click', function() {
                if (currentLocationInfo && currentLocationInfo.district) {
                    showLocationArea(currentLocationInfo.district, 'district');
                } else {
                    showStatus('åŒºå¿ä¿¡æ¯ä¸å¯ç”¨', 2000, 'warning');
                }
                morePanel.classList.remove('show');
            });
            
            // åŸå¸‚æŒ‰é’®äº‹ä»¶
            cityBtn.addEventListener('click', function() {
                if (currentLocationInfo && currentLocationInfo.city) {
                    showLocationArea(currentLocationInfo.city, 'city');
                } else {
                    showStatus('åŸå¸‚ä¿¡æ¯ä¸å¯ç”¨', 2000, 'warning');
                }
                morePanel.classList.remove('show');
            });
            
            // çœä»½æŒ‰é’®äº‹ä»¶
            provinceBtn.addEventListener('click', function() {
                if (currentLocationInfo && currentLocationInfo.province) {
                    showLocationArea(currentLocationInfo.province, 'province');
                } else {
                    showStatus('çœä»½ä¿¡æ¯ä¸å¯ç”¨', 2000, 'warning');
                }
                morePanel.classList.remove('show');
            });
            
            // ä¸­å›½æŒ‰é’®äº‹ä»¶
            countryBtn.addEventListener('click', function() {
                showLocationArea('ä¸­åäººæ°‘å…±å’Œå›½', 'country');
                morePanel.classList.remove('show');
            });
            
            // ç›®çš„åœ°æœç´¢æŒ‰é’®äº‹ä»¶
            destinationSearchBtn.addEventListener('click', function() {
                searchDestination();
            });
            
            // ç›®çš„åœ°è¾“å…¥æ¡†å›è½¦äº‹ä»¶
            destinationInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchDestination();
                }
            });
            
            // é¢„è®¾åœ°ç‚¹æŒ‰é’®äº‹ä»¶
            const presetLocationBtns = document.querySelectorAll('.preset-location-btn');
            presetLocationBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const location = this.getAttribute('data-location');
                    destinationInput.value = location;
                    searchDestination();
                });
            });
            
            // å¼€å§‹ç»˜åˆ¶
            function startDrawing() {
                isDrawing = true;
                drawingPoints = [];
                drawBtn.textContent = 'âœ… å®Œæˆ';
                drawBtn.classList.add('active');
                document.getElementById('mapContainer').style.cursor = 'crosshair';
                showStatus('ç‚¹å‡»åœ°å›¾å¼€å§‹ç»˜åˆ¶åŒºåŸŸï¼Œå†æ¬¡ç‚¹å‡»"å®Œæˆç»˜åˆ¶"æŒ‰é’®ç»“æŸ');
            }
            
            // å®Œæˆç»˜åˆ¶
            function finishDrawing() {
                if (drawingPoints.length < 3) {
                    showStatus('è‡³å°‘éœ€è¦3ä¸ªç‚¹æ‰èƒ½å½¢æˆåŒºåŸŸ');
                    return;
                }
                
                isDrawing = false;
                drawBtn.textContent = 'âœï¸ ç»˜åˆ¶';
                drawBtn.classList.remove('active');
                document.getElementById('mapContainer').style.cursor = 'default';
                
                // åˆ›å»ºå¤šè¾¹å½¢
                createPolygon();
                showStatus('åŒºåŸŸç»˜åˆ¶å®Œæˆï¼Œé¢ç§¯å·²è®¡ç®—');
            }
            
            // æ·»åŠ ç»˜åˆ¶ç‚¹
             function addDrawingPoint(lnglat) {
                 const point = [lnglat.lng, lnglat.lat];
                 
                 // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†ç¬¬ä¸€ä¸ªç‚¹ï¼ˆå¦‚æœå·²æœ‰3ä¸ªæˆ–æ›´å¤šç‚¹ï¼‰
                 if (drawingPoints.length >= 3) {
                     const firstPoint = drawingPoints[0];
                     const distance = calculateDistance(
                         firstPoint[1], firstPoint[0],
                         point[1], point[0]
                     );
                     
                     // å¦‚æœç‚¹å‡»ä½ç½®è·ç¦»ç¬¬ä¸€ä¸ªç‚¹å¾ˆè¿‘ï¼ˆ50ç±³å†…ï¼‰ï¼Œè‡ªåŠ¨å®Œæˆç»˜åˆ¶
                     if (distance < 50) {
                         finishDrawing();
                         return;
                     }
                 }
                 
                 drawingPoints.push(point);
                 
                 // æ·»åŠ ç‚¹æ ‡è®°
                 const marker = new AMap.CircleMarker({
                     center: point,
                     radius: 4,
                     strokeColor: '#ff4757',
                     strokeWeight: 2,
                     fillColor: '#ff4757',
                     fillOpacity: 0.8,
                     zIndex: 100
                 });
                 
                 // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªç‚¹ï¼Œä½¿å…¶æ›´æ˜¾çœ¼å¹¶æ·»åŠ ç‚¹å‡»äº‹ä»¶
                 if (drawingPoints.length === 1) {
                     marker.setOptions({
                         zIndex: 200
                     });
                     
                     // ä¸ºç¬¬ä¸€ä¸ªç‚¹æ·»åŠ ä¸“é—¨çš„ç‚¹å‡»äº‹ä»¶
                     marker.on('click', function(event) {
                         if (event && event.stopPropagation) {
                             event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                         }
                         if (isDrawing && drawingPoints.length >= 3) {
                             finishDrawing();
                         }
                         return false; // é˜»æ­¢é»˜è®¤è¡Œä¸º
                     });
                     
                     // æ·»åŠ é¼ æ ‡æ‚¬åœæ•ˆæœ
                     marker.on('mouseover', function() {
                         if (isDrawing && drawingPoints.length >= 3) {
                             marker.setOptions({
                                 radius: 12,
                                 strokeWeight: 5
                             });
                             document.getElementById('mapContainer').style.cursor = 'pointer';
                         }
                     });
                     
                     marker.on('mouseout', function() {
                         if (isDrawing) {
                             marker.setOptions({
                                 radius: 10,
                                 strokeWeight: 4
                             });
                             document.getElementById('mapContainer').style.cursor = 'crosshair';
                         }
                     });
                 }
                 
                 map.add(marker);
                 pointMarkers.push(marker);
                 
                 // å¦‚æœæœ‰å¤šä¸ªç‚¹ï¼Œç»˜åˆ¶è¿çº¿
                 if (drawingPoints.length > 1) {
                     updateDrawingLine();
                 }
             }
            
            // æ›´æ–°ç»˜åˆ¶çº¿æ¡
            function updateDrawingLine() {
                // ç§»é™¤ä¹‹å‰çš„ä¸´æ—¶çº¿æ¡
                if (window.tempPolyline) {
                    map.remove(window.tempPolyline);
                }
                
                // åˆ›å»ºæ–°çš„ä¸´æ—¶çº¿æ¡
                window.tempPolyline = new AMap.Polyline({
                    path: drawingPoints,
                    strokeColor: '#ff4757',
                    strokeWeight: 3,
                    strokeOpacity: 0.8,
                    strokeStyle: 'dashed'
                });
                map.add(window.tempPolyline);
            }
            
            // åˆ›å»ºå¤šè¾¹å½¢å¹¶è®¡ç®—é¢ç§¯
            function createPolygon() {
                // ç§»é™¤ä¸´æ—¶çº¿æ¡
                if (window.tempPolyline) {
                    map.remove(window.tempPolyline);
                    window.tempPolyline = null;
                }
                
                // åˆ›å»ºå¤šè¾¹å½¢
                const polygon = new AMap.Polygon({
                    path: drawingPoints.slice(), // å¤åˆ¶æ•°ç»„é¿å…å¼•ç”¨é—®é¢˜
                    strokeColor: '#ff4757',
                    strokeWeight: 3,
                    strokeOpacity: 0.8,
                    fillColor: '#ff4757',
                    fillOpacity: 0.3,
                    cursor: 'pointer'
                });
                
                // è®¡ç®—é¢ç§¯
                const area = AMap.GeometryUtil.ringArea(drawingPoints);
                
                // åˆ›å»ºå¤šè¾¹å½¢æ•°æ®å¯¹è±¡
                const polygonData = {
                    polygon: polygon,
                    points: drawingPoints.slice(),
                    area: area,
                    id: Date.now() // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºå”¯ä¸€ID
                };
                
                // æ·»åŠ åˆ°æ•°ç»„ä¸­
                allPolygons.push(polygonData);
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                polygon.on('click', function() {
                    setActivePolygon(polygonData);
                });
                
                map.add(polygon);
                
                // è®¾ç½®ä¸ºå½“å‰æ¿€æ´»çš„å¤šè¾¹å½¢
                setActivePolygon(polygonData);
                
                // é‡ç½®ç»˜åˆ¶çŠ¶æ€ï¼Œå‡†å¤‡ç»˜åˆ¶ä¸‹ä¸€ä¸ªåŒºåŸŸ
                drawingPoints = [];
                currentPolygon = null;
                
                // ç§»é™¤ç‚¹æ ‡è®°
                pointMarkers.forEach(marker => {
                    map.remove(marker);
                });
                pointMarkers = [];
            }
            
            // è®¾ç½®æ¿€æ´»çš„å¤šè¾¹å½¢
            function setActivePolygon(polygonData) {
                // é‡ç½®æ‰€æœ‰å¤šè¾¹å½¢æ ·å¼
                allPolygons.forEach(data => {
                    data.polygon.setOptions({
                        strokeColor: '#ff4757',
                        strokeWeight: 3,
                        strokeOpacity: 0.8,
                        fillColor: '#ff4757',
                        fillOpacity: 0.3
                    });
                });
                
                // é«˜äº®å½“å‰æ¿€æ´»çš„å¤šè¾¹å½¢
                polygonData.polygon.setOptions({
                    strokeColor: '#2ed573',
                    strokeWeight: 4,
                    strokeOpacity: 1,
                    fillColor: '#2ed573',
                    fillOpacity: 0.4
                });
                
                currentActivePolygon = polygonData;
                displayArea(polygonData.area);
            }
            
            // æ˜¾ç¤ºé¢ç§¯ä¿¡æ¯
            function displayArea(area) {
                // è½¬æ¢å•ä½
                const hectares = area / 10000; // å…¬é¡·
                const squareKm = area / 1000000; // å¹³æ–¹åƒç±³
                
                // æ ¼å¼åŒ–æ˜¾ç¤º
                areaValue.textContent = 'çº¦ ' + formatArea(area) + ' å¹³æ–¹ç±³';
                
                areaConversions.innerHTML = `
                    <div class="unit-option" data-unit="hectares">çº¦ ${formatArea(hectares)} å…¬é¡·</div>
                    <div class="unit-option" data-unit="squareKm">çº¦ ${formatArea(squareKm)} å¹³æ–¹åƒç±³</div>
                `;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
                const unitOptions = areaConversions.querySelectorAll('.unit-option');
                unitOptions.forEach(option => {
                    option.addEventListener('click', function() {
                        // ç§»é™¤æ‰€æœ‰activeç±»
                        unitOptions.forEach(opt => opt.classList.remove('active'));
                        areaValue.classList.remove('active');
                        
                        // æ·»åŠ activeç±»åˆ°è¢«ç‚¹å‡»çš„å…ƒç´ 
                        this.classList.add('active');
                    });
                });
                
                areaInfo.style.display = 'block';
            }
            
            // æ ¼å¼åŒ–é¢ç§¯æ•°å€¼
            function formatArea(area) {
                if (area < 1) {
                    return area.toFixed(4);
                } else if (area < 100) {
                    return area.toFixed(2);
                } else {
                    return Math.round(area).toString();
                }
            }
            
            // æ¸…é™¤ç»˜åˆ¶
            function clearDrawing() {
                // åœæ­¢ç»˜åˆ¶æ¨¡å¼
                isDrawing = false;
                drawBtn.textContent = 'âœï¸ ç»˜åˆ¶';
                drawBtn.classList.remove('active');
                document.getElementById('mapContainer').style.cursor = 'default';
                
                // æ¸…é™¤æ‰€æœ‰ç»˜åˆ¶å†…å®¹
                drawingPoints = [];
                
                // ç§»é™¤ç‚¹æ ‡è®°
                pointMarkers.forEach(marker => {
                    map.remove(marker);
                });
                pointMarkers = [];
                
                // ç§»é™¤ä¸´æ—¶çº¿æ¡
                if (window.tempPolyline) {
                    map.remove(window.tempPolyline);
                    window.tempPolyline = null;
                }
                
                // ç§»é™¤å½“å‰ç»˜åˆ¶ä¸­çš„å¤šè¾¹å½¢
                if (currentPolygon) {
                    map.remove(currentPolygon);
                    currentPolygon = null;
                }
                
                // ç§»é™¤æ‰€æœ‰å·²ç»˜åˆ¶çš„å¤šè¾¹å½¢
                allPolygons.forEach(data => {
                    map.remove(data.polygon);
                });
                allPolygons = [];
                currentActivePolygon = null;
                
                // éšè—é¢ç§¯ä¿¡æ¯
                areaInfo.style.display = 'none';
            }
            
            // é€šè¿‡IPåœ°å€è·å–å¤§æ¦‚ä½ç½®
            async function getLocationByIP() {
                try {
                    showStatus("æ­£åœ¨é€šè¿‡IPåœ°å€è·å–æ‚¨çš„ä½ç½®...", 2000, 'info');
                    
                    // ä½¿ç”¨å¤šä¸ªIPåœ°ç†ä½ç½®APIæœåŠ¡ï¼Œä¼˜å…ˆä½¿ç”¨ip.sb API
                    const apis = [
                        {
                            name: 'ip.sb',
                            url: 'https://api.ip.sb/geoip',
                            parser: (data) => ({
                                lat: data.latitude,
                                lng: data.longitude,
                                city: data.city,
                                country: data.country
                            })
                        },
                        {
                            name: 'ipapi.co',
                            url: 'https://ipapi.co/json/',
                            parser: (data) => ({
                                lat: data.latitude,
                                lng: data.longitude,
                                city: data.city,
                                country: data.country_name
                            })
                        },
                        {
                            name: 'ipgeolocation.io',
                            url: 'https://api.ipgeolocation.io/ipgeo?apiKey=free',
                            parser: (data) => ({
                                lat: parseFloat(data.latitude),
                                lng: parseFloat(data.longitude),
                                city: data.city,
                                country: data.country_name
                            })
                        },
                        {
                            name: 'ipinfo.io',
                            url: 'https://ipinfo.io/json',
                            parser: (data) => {
                                const [lat, lng] = data.loc.split(',').map(parseFloat);
                                return {
                                    lat: lat,
                                    lng: lng,
                                    city: data.city,
                                    country: data.country
                                };
                            }
                        }
                    ];
                    
                    for (const api of apis) {
                        try {
                            console.log(`å°è¯•ä½¿ç”¨ ${api.name} API è¿›è¡ŒIPå®šä½...`);
                            
                            const response = await fetch(api.url, {
                                method: 'GET',
                                headers: {
                                    'Accept': 'application/json'
                                },
                                signal: AbortSignal.timeout(5000) // 5ç§’è¶…æ—¶
                            });
                            
                            if (response.ok) {
                                const data = await response.json();
                                const location = api.parser(data);
                                
                                if (location.lat && location.lng && !isNaN(location.lat) && !isNaN(location.lng)) {
                                    console.log(`${api.name} IPå®šä½æˆåŠŸ:`, location);
                                    showStatus(`å·²é€šè¿‡${api.name}å®šä½åˆ°${location.city || ''}${location.country || ''}`, 2000, 'success');
                                    return [location.lng, location.lat];
                                }
                            }
                        } catch (error) {
                            console.log(`${api.name} IPå®šä½APIå¤±è´¥:`, error);
                            continue;
                        }
                    }
                    
                    throw new Error('æ‰€æœ‰IPå®šä½APIéƒ½å¤±è´¥äº†');
                    
                } catch (error) {
                    console.log('IPå®šä½å¤±è´¥:', error);
                    showStatus("æ‰€æœ‰IPå®šä½APIéƒ½å¤±è´¥ï¼Œæ­£åœ¨å°è¯•æµè§ˆå™¨å®šä½...", 2000, 'warning');
                    return null;
                }
            }
            
            // è‡ªåŠ¨è·å–ç”¨æˆ·ä½ç½®å¹¶æœç´¢æœ€è¿‘çš„å°å­¦ï¼ˆä¼˜å…ˆä½¿ç”¨æµè§ˆå™¨å®šä½ï¼‰
            async function autoFindNearestSchool() {
                showStatus("æ­£åœ¨è·å–æ‚¨çš„ä½ç½®å¹¶æœç´¢æœ€è¿‘çš„å°å­¦...", 2000, 'info');
                
                // ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šå°è¯•æµè§ˆå™¨GPSç²¾ç¡®å®šä½
                if (navigator.geolocation) {
                    showStatus("æ­£åœ¨å°è¯•æµè§ˆå™¨GPSç²¾ç¡®å®šä½...", 2000, 'info');
                    
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const userLat = position.coords.latitude;
                            const userLng = position.coords.longitude;
                            const userPosition = [userLng, userLat];
                            
                            showStatus("æµè§ˆå™¨GPSå®šä½æˆåŠŸï¼Œæ­£åœ¨æœç´¢æœ€è¿‘çš„å°å­¦...", 2000, 'success');
                            findNearestSchool(userPosition);
                        },
                        async function(error) {
                            // æµè§ˆå™¨GPSå®šä½å¤±è´¥ï¼Œå°è¯•IPå®šä½
                            console.log("æµè§ˆå™¨GPSå®šä½å¤±è´¥ï¼Œå°è¯•IPå®šä½", error);
                            
                            let errorMsg = "æµè§ˆå™¨å®šä½å¤±è´¥";
                            if (error.code === error.PERMISSION_DENIED) {
                                errorMsg = "ä½ç½®æƒé™è¢«æ‹’ç»ï¼Œå°è¯•IPå®šä½";
                            } else if (error.code === error.POSITION_UNAVAILABLE) {
                                errorMsg = "ä½ç½®ä¿¡æ¯ä¸å¯ç”¨ï¼Œå°è¯•IPå®šä½";
                            } else if (error.code === error.TIMEOUT) {
                                errorMsg = "æµè§ˆå™¨å®šä½è¶…æ—¶ï¼Œå°è¯•IPå®šä½";
                            }
                            showStatus(errorMsg, 2000, 'warning');
                            
                            // ç¬¬äºŒä¼˜å…ˆçº§ï¼šå°è¯•IPå®šä½ï¼ˆä½¿ç”¨ip.sbç­‰APIï¼‰
                            const ipPosition = await getLocationByIP();
                            if (ipPosition) {
                                showStatus("IPå®šä½æˆåŠŸï¼Œæ­£åœ¨æœç´¢æœ€è¿‘çš„å°å­¦...", 2000, 'success');
                                findNearestSchool(ipPosition);
                                return;
                            }
                            
                            // æ‰€æœ‰å®šä½æ–¹å¼éƒ½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®
                            const defaultPosition = [116.433293, 39.905301]; // åŒ—äº¬å¤©å®‰é—¨
                            findNearestSchool(defaultPosition);
                            showStatus("æ‰€æœ‰å®šä½æ–¹å¼éƒ½å¤±è´¥ï¼Œå·²æ˜¾ç¤ºåŒ—äº¬åœ°åŒºçš„å°å­¦", 4000, 'warning');
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 8000,
                            maximumAge: 60000
                        }
                    );
                } else {
                    // æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®ï¼Œå°è¯•IPå®šä½
                    showStatus("æµè§ˆå™¨ä¸æ”¯æŒå®šä½åŠŸèƒ½ï¼Œå°è¯•IPå®šä½...", 2000, 'warning');
                    
                    // ç¬¬äºŒä¼˜å…ˆçº§ï¼šå°è¯•IPå®šä½ï¼ˆä½¿ç”¨ip.sbç­‰APIï¼‰
                    const ipPosition = await getLocationByIP();
                    if (ipPosition) {
                        showStatus("IPå®šä½æˆåŠŸï¼Œæ­£åœ¨æœç´¢æœ€è¿‘çš„å°å­¦...", 2000, 'success');
                        findNearestSchool(ipPosition);
                        return;
                    }
                    
                    // æ‰€æœ‰å®šä½æ–¹å¼éƒ½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®
                    const defaultPosition = [116.433293, 39.905301]; // åŒ—äº¬å¤©å®‰é—¨
                    findNearestSchool(defaultPosition);
                    showStatus("æ‰€æœ‰å®šä½æ–¹å¼éƒ½å¤±è´¥ï¼Œå·²æ˜¾ç¤ºåŒ—äº¬åœ°åŒºçš„å°å­¦", 4000, 'warning');
                }
            }
            
            // æœç´¢æœ€è¿‘çš„å°å­¦å¹¶å®šä½
            function findNearestSchool(center) {
                if (!placeSearch) {
                    showStatus("æœç´¢åŠŸèƒ½æœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
                    return;
                }
                
                // ä¿å­˜å½“å‰ä½ç½®
                currentLocation = center;
                
                // è®¾ç½®æœç´¢ä¸­å¿ƒç‚¹
                placeSearch.searchNearBy('å°å­¦', center, 5000, function(status, result) {
                    if (status === 'complete' && result.poiList && result.poiList.pois.length > 0) {
                        const schools = result.poiList.pois;
                        
                        // è®¡ç®—è·ç¦»å¹¶æ‰¾åˆ°æœ€è¿‘çš„å°å­¦
                        const schoolsWithDistance = schools.map(school => {
                            const distance = calculateDistance(
                                center[1], center[0],
                                school.location.lat, school.location.lng
                            );
                            return { ...school, distance: distance };
                        }).sort((a, b) => a.distance - b.distance);
                        
                        if (schoolsWithDistance.length > 0) {
                            const nearestSchool = schoolsWithDistance[0];
                            const schoolPosition = [nearestSchool.location.lng, nearestSchool.location.lat];
                            
                            // å°†åœ°å›¾ä¸­å¿ƒå®šä½åˆ°æœ€è¿‘çš„å°å­¦
                            map.setCenter(schoolPosition);
                            map.setZoom(20); // æ”¹ä¸ºæœ€å¤§ç¼©æ”¾çº§åˆ«
                            
                            // æ·»åŠ æœ€è¿‘å°å­¦çš„æ ‡è®°
                            const marker = new AMap.Marker({
                                position: schoolPosition,
                                icon: new AMap.Icon({
                                    size: new AMap.Size(25, 34),
                                    image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png'
                                }),
                                title: nearestSchool.name
                            });
                            
                            // æ·»åŠ ä¿¡æ¯çª—ä½“
                            const infoWindow = new AMap.InfoWindow({
                                content: `
                                    <div style="padding: 10px;">
                                        <h4 style="margin: 0 0 5px 0; color: #333;">${nearestSchool.name}</h4>
                                        <p style="margin: 0; color: #666; font-size: 12px;">${nearestSchool.address || 'åœ°å€ä¿¡æ¯ä¸è¯¦'}</p>
                                        <p style="margin: 5px 0 0 0; color: #28a745; font-size: 12px;">è·ç¦»: ${nearestSchool.distance.toFixed(0)}ç±³</p>
                                    </div>
                                `,
                                offset: new AMap.Pixel(0, -30)
                            });
                            
                            marker.on('click', function() {
                                infoWindow.open(map, marker.getPosition());
                            });
                            
                            map.add(marker);
                            
                            showStatus(`å·²å®šä½åˆ°æœ€è¿‘çš„å°å­¦ï¼š${nearestSchool.name}`, 3000, 'success');
                            
                            // è·å–ä½ç½®ä¿¡æ¯
                            getLocationInfo(schoolPosition);
                        }
                    } else {
                        showStatus("é™„è¿‘æ²¡æœ‰æ‰¾åˆ°å°å­¦ï¼Œæ˜¾ç¤ºå½“å‰ä½ç½®", 3000, 'warning');
                        map.setCenter(center);
                        getLocationInfo(center);
                    }
                });
            }
            
            // è·å–ä½ç½®ä¿¡æ¯ï¼ˆé€†åœ°ç†ç¼–ç ï¼‰
            function getLocationInfo(position) {
                geocoder.getAddress(position, function(status, result) {
                    if (status === 'complete' && result.regeocode) {
                        const addressComponent = result.regeocode.addressComponent;
                        const locationInfo = {
                            province: addressComponent.province,
                            city: addressComponent.city,
                            district: addressComponent.district
                        };
                        updateLocationInfo(locationInfo);
                    }
                });
            }
            
            // æœç´¢é™„è¿‘åœºæ‰€
            function searchNearbyPlaces(keyword, icon) {
                if (!currentLocationInfo || !currentLocationInfo.city) {
                    showStatus('è¯·å…ˆè·å–ä½ç½®ä¿¡æ¯', 2000, 'warning');
                    return;
                }
                
                const district = currentLocationInfo.district;
                const city = currentLocationInfo.city;
                const province = currentLocationInfo.province;
                
                // æœºåœºã€æ™¯ç‚¹æ™¯åŒºã€ä½“è‚²ä¸­å¿ƒæœç´¢ç›´æ¥ä»å¸‚çº§èŒƒå›´å¼€å§‹
                if (keyword === 'æœºåœº' || keyword === 'æ™¯ç‚¹æ™¯åŒº' || keyword === 'ä½“è‚²ä¸­å¿ƒ') {
                    showStatus(`æ­£åœ¨${city}èŒƒå›´å†…æœç´¢${keyword}...`, 2000, 'info');
                    searchInArea(keyword, icon, city, 'city');
                } else {
                    // å…¶ä»–åœºæ‰€ä»åŒºå¿èŒƒå›´å¼€å§‹æœç´¢
                    showStatus(`æ­£åœ¨${district}èŒƒå›´å†…æœç´¢${keyword}...`, 2000, 'info');
                    searchInArea(keyword, icon, district, 'district');
                }
            }
            
            // åœ¨æŒ‡å®šåŒºåŸŸå†…æœç´¢
            function searchInArea(keyword, icon, areaName, areaType) {
                const searchKeyword = `${areaName} ${keyword}`;
                
                placeSearch.search(searchKeyword, function(status, result) {
                    if (status === 'complete' && result.poiList && result.poiList.pois.length > 0) {
                        const places = result.poiList.pois;
                        displaySearchResults(places, keyword, icon, areaName, areaType);
                    } else {
                        // å¦‚æœåŒºå¿èŒƒå›´å†…æ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•åœ¨å¸‚çº§èŒƒå›´å†…æœç´¢
                        if (areaType === 'district' && currentLocationInfo.city) {
                            showStatus(`${areaName}èŒƒå›´å†…æœªæ‰¾åˆ°ï¼Œæ­£åœ¨${currentLocationInfo.city}èŒƒå›´å†…æœç´¢...`, 2000, 'info');
                            searchInArea(keyword, icon, currentLocationInfo.city, 'city');
                        } 
                        // å¦‚æœå¸‚çº§èŒƒå›´å†…æ²¡æœ‰æ‰¾åˆ°æœºåœºï¼Œå°è¯•åœ¨çœçº§èŒƒå›´å†…æœç´¢
                        else if (areaType === 'city' && keyword === 'æœºåœº' && currentLocationInfo.province) {
                            showStatus(`${areaName}èŒƒå›´å†…æœªæ‰¾åˆ°ï¼Œæ­£åœ¨${currentLocationInfo.province}èŒƒå›´å†…æœç´¢...`, 2000, 'info');
                            searchInArea(keyword, icon, currentLocationInfo.province, 'province');
                        } else {
                            showStatus(`${areaName}èŒƒå›´å†…æ²¡æœ‰æ‰¾åˆ°${keyword}`, 3000, 'warning');
                        }
                    }
                });
            }
            
            // æ˜¾ç¤ºæœç´¢ç»“æœ
            function displaySearchResults(places, keyword, icon, areaName, areaType) {
                // æ¸…é™¤ä¹‹å‰çš„æ ‡è®°
                if (window.nearbyMarkers) {
                    window.nearbyMarkers.forEach(marker => map.remove(marker));
                }
                window.nearbyMarkers = [];
                
                // è¿‡æ»¤å‡ºè·ç¦»å½“å‰ä½ç½®åˆç†èŒƒå›´å†…çš„ç»“æœï¼Œå¹¶æ’é™¤ä¸ç›¸å…³çš„POIç±»å‹
                const filteredPlaces = places.filter(place => {
                    if (!place.location) return false;
                    
                    // è·ç¦»è¿‡æ»¤
                    const distance = calculateDistance(
                        currentLocation[1], currentLocation[0],
                        place.location.lat, place.location.lng
                    );
                    // åŒºå¿èŒƒå›´å†…é™åˆ¶åœ¨20å…¬é‡Œï¼Œå¸‚çº§èŒƒå›´å†…é™åˆ¶åœ¨50å…¬é‡Œ
                    const maxDistance = areaType === 'district' ? 20000 : 50000;
                    if (distance > maxDistance) return false;
                    
                    // POIç±»å‹è¿‡æ»¤ - æ ¹æ®æœç´¢å…³é”®è¯æ’é™¤ä¸ç›¸å…³ç±»å‹
                    if (keyword === 'ä½“è‚²ä¸­å¿ƒ') {
                        // æ’é™¤å­¦æ ¡ã€åŒ»é™¢ã€å•†åº—ç­‰ä¸ç›¸å…³ç±»å‹
                        const excludeTypes = ['å°å­¦', 'ä¸­å­¦', 'å­¦æ ¡', 'åŒ»é™¢', 'è¯Šæ‰€', 'å•†åº—', 'è¶…å¸‚', 'é¤å…', 'é…’åº—'];
                        const placeName = place.name.toLowerCase();
                        const placeType = place.type || '';
                        
                        // æ£€æŸ¥æ˜¯å¦åŒ…å«æ’é™¤çš„ç±»å‹
                        const hasExcludedType = excludeTypes.some(excludeType => 
                            placeName.includes(excludeType.toLowerCase()) || 
                            placeType.includes(excludeType)
                        );
                        
                        if (hasExcludedType) return false;
                        
                        // ç¡®ä¿åŒ…å«ä½“è‚²ç›¸å…³å…³é”®è¯
                        const sportsKeywords = ['ä½“è‚²', 'è¿åŠ¨', 'å¥èº«', 'æ¸¸æ³³', 'ç¯®çƒ', 'è¶³çƒ', 'ç¾½æ¯›çƒ', 'ä¹’ä¹“çƒ', 'ç½‘çƒ', 'ä½“è‚²é¦†', 'ä½“è‚²åœº', 'ä½“è‚²ä¸­å¿ƒ'];
                        const hasSportsKeyword = sportsKeywords.some(keyword => 
                            placeName.includes(keyword.toLowerCase()) || 
                            placeType.includes(keyword)
                        );
                        
                        if (!hasSportsKeyword) return false;
                    }
                    
                    // æœºåœºä¸“ç”¨è¿‡æ»¤é€»è¾‘
                    if (keyword === 'æœºåœº') {
                        const placeName = place.name.toLowerCase();
                        const placeType = place.type || '';
                        const placeAddress = place.address || '';
                        
                        // æ’é™¤åŒ…å«"è·¯"ã€"è¡—"ã€"é“"ç­‰é“è·¯ç›¸å…³è¯æ±‡çš„ç»“æœ
                        const roadKeywords = ['è·¯', 'è¡—', 'é“', 'å··', 'å¼„', 'å¤§é“', 'å…¬è·¯', 'é«˜é€Ÿ'];
                        const hasRoadKeyword = roadKeywords.some(roadKeyword => 
                            placeName.includes(roadKeyword) || placeAddress.includes(roadKeyword)
                        );
                        
                        if (hasRoadKeyword) return false;
                        
                        // æ’é™¤å…¶ä»–ä¸ç›¸å…³ç±»å‹
                        const excludeTypes = ['é…’åº—', 'å®¾é¦†', 'é¤å…', 'å•†åº—', 'è¶…å¸‚', 'åŠ æ²¹ç«™', 'åœè½¦åœº', 'æ±½è½¦ç«™', 'ç«è½¦ç«™'];
                        const hasExcludedType = excludeTypes.some(excludeType => 
                            placeName.includes(excludeType) || 
                            placeType.includes(excludeType)
                        );
                        
                        if (hasExcludedType) return false;
                        
                        // ç¡®ä¿åŒ…å«æœºåœºç›¸å…³å…³é”®è¯
                        const airportKeywords = ['æœºåœº', 'airport', 'èˆªç©º', 'èˆªç«™æ¥¼', 'å€™æœºæ¥¼'];
                        const hasAirportKeyword = airportKeywords.some(airportKeyword => 
                            placeName.includes(airportKeyword.toLowerCase()) || 
                            placeType.includes(airportKeyword)
                        );
                        
                        if (!hasAirportKeyword) return false;
                    }
                    
                    return true;
                });
                
                // æŒ‰è·ç¦»æ’åº
                filteredPlaces.sort((a, b) => {
                    const distanceA = calculateDistance(
                        currentLocation[1], currentLocation[0],
                        a.location.lat, a.location.lng
                    );
                    const distanceB = calculateDistance(
                        currentLocation[1], currentLocation[0],
                        b.location.lat, b.location.lng
                    );
                    return distanceA - distanceB;
                });
                
                const areaTypeText = areaType === 'district' ? 'åŒºå¿' : 'å¸‚çº§';
                
                if (filteredPlaces.length === 0) {
                    showStatus(`${areaName}(${areaTypeText})èŒƒå›´å†…æ²¡æœ‰æ‰¾åˆ°${keyword}`, 3000, 'warning');
                    return;
                } else if (filteredPlaces.length === 1) {
                    // åªæœ‰ä¸€ä¸ªç»“æœæ—¶ï¼Œç›´æ¥å®šä½è¿‡å»
                    const place = filteredPlaces[0];
                    const distance = calculateDistance(
                        currentLocation[1], currentLocation[0],
                        place.location.lat, place.location.lng
                    );
                    
                    // æ¸…é™¤åŒºåŸŸè¾¹ç•Œå’Œè‰²å—
                    if (currentDistrictPolygon) {
                        map.remove(currentDistrictPolygon);
                        currentDistrictPolygon = null;
                    }
                    
                    // ç›´æ¥å®šä½åˆ°è¯¥ä½ç½®
                    map.setCenter([place.location.lng, place.location.lat]);
                    map.setZoom(16);
                    
                    // æ·»åŠ æ ‡è®°
                    const marker = new AMap.Marker({
                        position: [place.location.lng, place.location.lat],
                        icon: new AMap.Icon({
                            size: new AMap.Size(30, 40),
                            image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png'
                        }),
                        title: place.name
                    });
                    
                    const infoWindow = new AMap.InfoWindow({
                        content: `
                            <div style="padding: 10px;">
                                <h4 style="margin: 0 0 5px 0; color: #333;">${icon} ${place.name}</h4>
                                <p style="margin: 0; color: #666; font-size: 12px;">${place.address || 'åœ°å€ä¿¡æ¯ä¸è¯¦'}</p>
                                <p style="margin: 5px 0 0 0; color: #28a745; font-size: 12px;">è·ç¦»: ${distance.toFixed(0)}ç±³</p>
                                <p style="margin: 2px 0 0 0; color: #007bff; font-size: 11px;">æœç´¢èŒƒå›´: ${areaName}</p>
                            </div>
                        `,
                        offset: new AMap.Pixel(0, -30)
                    });
                    
                    map.add(marker);
                    window.nearbyMarkers = [marker];
                    
                    // è‡ªåŠ¨æ‰“å¼€ä¿¡æ¯çª—å£
                    setTimeout(() => {
                        infoWindow.open(map, marker.getPosition());
                    }, 500);
                    
                    showStatus(`å·²å®šä½åˆ°${place.name}`, 3000, 'success');
                } else {
                    // å¤šä¸ªç»“æœæ—¶ï¼Œæ˜¾ç¤ºé€‰æ‹©åˆ—è¡¨
                    showPlacesList(filteredPlaces, keyword, icon, areaName, areaTypeText);
                }
            }
            
            // æ˜¾ç¤ºåœºæ‰€é€‰æ‹©åˆ—è¡¨
            function showPlacesList(places, keyword, icon, areaName, areaTypeText) {
                // ç§»é™¤ä¹‹å‰çš„åˆ—è¡¨
                const existingList = document.getElementById('places-list');
                if (existingList) {
                    existingList.remove();
                }
                
                // ç§»é™¤ä¹‹å‰çš„é®ç½©å±‚
                const existingOverlay = document.getElementById('places-overlay');
                if (existingOverlay) {
                    existingOverlay.remove();
                }
                
                // åˆ›å»ºé®ç½©å±‚
                const overlay = document.createElement('div');
                overlay.id = 'places-overlay';
                overlay.className = 'places-overlay';
                
                // åˆ›å»ºåˆ—è¡¨å®¹å™¨
                const listContainer = document.createElement('div');
                listContainer.id = 'places-list';
                listContainer.className = 'places-list';
                
                // åˆ›å»ºæ ‡é¢˜
                const header = document.createElement('div');
                header.className = 'places-list-header';
                header.innerHTML = `
                    <div class="places-list-header-inner">
                        <h3 class="places-list-title">${icon} ${keyword} (${places.length}ä¸ª)</h3>
                        <button id="close-places-list" class="places-list-close">Ã—</button>
                    </div>
                    <p class="places-list-subtitle">æœç´¢èŒƒå›´: ${areaName}(${areaTypeText})</p>
                `;
                
                // åˆ›å»ºåˆ—è¡¨å†…å®¹
                const listContent = document.createElement('div');
                listContent.className = 'places-list-content';
                
                // å…³é—­åˆ—è¡¨å’Œé®ç½©å±‚çš„å‡½æ•°
                const closeList = () => {
                    listContainer.remove();
                    overlay.remove();
                };
                
                places.slice(0, 10).forEach((place, index) => {
                    const distance = calculateDistance(
                        currentLocation[1], currentLocation[0],
                        place.location.lat, place.location.lng
                    );
                    
                    const item = document.createElement('div');
                    item.className = 'places-list-item';
                    
                    item.innerHTML = `
                        <div class="places-list-item-name">${place.name}</div>
                        <div class="places-list-item-address">${place.address || 'åœ°å€ä¿¡æ¯ä¸è¯¦'}</div>
                        <div class="places-list-item-distance">è·ç¦»: ${distance.toFixed(0)}ç±³</div>
                    `;
                    
                    item.addEventListener('click', () => {
                        navigateToPlace(place, icon);
                        closeList(); // å…³é—­åˆ—è¡¨å’Œé®ç½©å±‚
                    });
                    
                    listContent.appendChild(item);
                });
                
                listContainer.appendChild(header);
                listContainer.appendChild(listContent);
                
                // æ·»åŠ åˆ°é¡µé¢
                document.body.appendChild(overlay);
                document.body.appendChild(listContainer);
                
                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                overlay.addEventListener('click', closeList);
                
                // å…³é—­æŒ‰é’®äº‹ä»¶ - ç¡®ä¿å…ƒç´ å·²æ·»åŠ åˆ°DOMåå†ç»‘å®šäº‹ä»¶
                const closeButton = document.getElementById('close-places-list');
                if (closeButton) {
                    closeButton.addEventListener('click', closeList);
                }
                
                showStatus(`æ‰¾åˆ°${places.length}ä¸ª${keyword}ï¼Œè¯·é€‰æ‹©è¦å‰å¾€çš„åœ°ç‚¹`, 3000, 'info');
            }
            
            // å¯¼èˆªåˆ°æŒ‡å®šåœºæ‰€
            function navigateToPlace(place, icon) {
                // æ¸…é™¤ä¹‹å‰çš„æ ‡è®°
                if (window.nearbyMarkers) {
                    window.nearbyMarkers.forEach(marker => map.remove(marker));
                }
                window.nearbyMarkers = [];
                
                // æ¸…é™¤åŒºåŸŸè¾¹ç•Œå’Œè‰²å—
                if (currentDistrictPolygon) {
                    map.remove(currentDistrictPolygon);
                    currentDistrictPolygon = null;
                }
                
                const distance = calculateDistance(
                    currentLocation[1], currentLocation[0],
                    place.location.lat, place.location.lng
                );
                
                // å®šä½åˆ°è¯¥ä½ç½®
                map.setCenter([place.location.lng, place.location.lat]);
                map.setZoom(16);
                
                // æ·»åŠ æ ‡è®°
                const marker = new AMap.Marker({
                    position: [place.location.lng, place.location.lat],
                    icon: new AMap.Icon({
                        size: new AMap.Size(30, 40),
                        image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png'
                    }),
                    title: place.name
                });
                
                const infoWindow = new AMap.InfoWindow({
                    content: `
                        <div style="padding: 10px;">
                            <h4 style="margin: 0 0 5px 0; color: #333;">${icon} ${place.name}</h4>
                            <p style="margin: 0; color: #666; font-size: 12px;">${place.address || 'åœ°å€ä¿¡æ¯ä¸è¯¦'}</p>
                            <p style="margin: 5px 0 0 0; color: #28a745; font-size: 12px;">è·ç¦»: ${distance.toFixed(0)}ç±³</p>
                        </div>
                    `,
                    offset: new AMap.Pixel(0, -30)
                });
                
                map.add(marker);
                window.nearbyMarkers = [marker];
                
                // è‡ªåŠ¨æ‰“å¼€ä¿¡æ¯çª—å£
                setTimeout(() => {
                    infoWindow.open(map, marker.getPosition());
                }, 500);
                
                showStatus(`å·²å®šä½åˆ°${place.name}`, 3000, 'success');
            }
            
            // æ˜¾ç¤ºåŒºåŸŸä¿¡æ¯
            function showLocationArea(areaName, type) {
                
                // æ¸…é™¤ä¹‹å‰çš„è¡Œæ”¿åŒºåŸŸå¤šè¾¹å½¢
                if (currentDistrictPolygon) {
                    map.remove(currentDistrictPolygon);
                    currentDistrictPolygon = null;
                }
                
                let zoomLevel = 10;
                if (type === 'district') zoomLevel = 10;
                else if (type === 'city') zoomLevel = 8;
                else if (type === 'province') zoomLevel = 6;
                else if (type === 'country') zoomLevel = 4;
                
                // æœç´¢å¹¶ç»˜åˆ¶è¡Œæ”¿åŒºåŸŸè¾¹ç•Œ
                if (districtSearch) {
                    // è®¾ç½®æœç´¢çº§åˆ«
                    let searchLevel = 'district';
                    if (type === 'city') searchLevel = 'city';
                    else if (type === 'province') searchLevel = 'province';
                    else if (type === 'country') searchLevel = 'country';
                    
                    districtSearch.setLevel(searchLevel);
                    
                    districtSearch.search(areaName, function(status, result) {
                        if (status === 'complete' && result.districtList && result.districtList.length > 0) {
                            const district = result.districtList[0];
                            const boundaries = district.boundaries;
                            
                            if (boundaries && boundaries.length > 0) {
                                // åˆ›å»ºå¤šè¾¹å½¢æ ·å¼
                                let polygonOptions = {
                                    strokeWeight: 2,
                                    fillOpacity: 0.2,
                                    strokeOpacity: 0.8,
                                    strokeStyle: 'solid'
                                };
                                
                                // æ ¹æ®è¡Œæ”¿çº§åˆ«è®¾ç½®ä¸åŒçš„é¢œè‰²
                                if (type === 'district') {
                                    polygonOptions.strokeColor = '#FF6B6B';
                                    polygonOptions.fillColor = '#FF6B6B';
                                } else if (type === 'city') {
                                    polygonOptions.strokeColor = '#4ECDC4';
                                    polygonOptions.fillColor = '#4ECDC4';
                                } else if (type === 'province') {
                                    polygonOptions.strokeColor = '#45B7D1';
                                    polygonOptions.fillColor = '#45B7D1';
                                } else if (type === 'country') {
                                    polygonOptions.strokeColor = '#FFD93D';
                                    polygonOptions.fillColor = '#FFD93D';
                                }
                                
                                // åˆ›å»ºå¤šè¾¹å½¢
                                const polygons = [];
                                let totalArea = 0;
                                boundaries.forEach(boundary => {
                                    const polygon = new AMap.Polygon({
                                        path: boundary,
                                        ...polygonOptions,
                                        cursor: 'pointer'
                                    });
                                    
                                    // ä¼˜åŒ–é¢ç§¯è®¡ç®— - ä½¿ç”¨æ›´ç²¾ç¡®çš„æ¤­çƒé¢è®¡ç®—
                                    let polygonArea;
                                    try {
                                        // ä½¿ç”¨é«˜å¾·åœ°å›¾çš„æ¤­çƒé¢ç§¯è®¡ç®—æ–¹æ³•
                                        polygonArea = AMap.GeometryUtil.ringArea(boundary);
                                        
                                        // å¯¹äºå¤§é¢ç§¯åŒºåŸŸï¼Œåº”ç”¨åœ°çƒæ›²ç‡ä¿®æ­£
                                        if (polygonArea > 10000000000) { // å¤§äº10000å¹³æ–¹åƒç±³
                                            // åº”ç”¨æ¤­çƒé¢ä¿®æ­£ç³»æ•°
                                            const sphericalCorrection = 1.0003; // æ¤­çƒé¢ä¿®æ­£
                                            polygonArea *= sphericalCorrection;
                                        }
                                        
                                        // åæ ‡ç³»ç²¾åº¦ä¿®æ­£ï¼ˆGCJ-02åæ ‡ç³»ï¼‰
                                        const coordinateCorrection = 0.9996; // GCJ-02åæ ‡ç³»ä¿®æ­£
                                        polygonArea *= coordinateCorrection;
                                        
                                    } catch (error) {
                                        console.warn('é¢ç§¯è®¡ç®—å‡ºé”™ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•:', error);
                                        // å¤‡ç”¨è®¡ç®—æ–¹æ³•
                                        polygonArea = calculatePolygonAreaFallback(boundary);
                                    }
                                    
                                    totalArea += polygonArea;
                                    
                                    // ä¸ºæ¯ä¸ªå¤šè¾¹å½¢æ·»åŠ ç‚¹å‡»äº‹ä»¶
                                    polygon.on('click', function(e) {
                                        // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°åœ°å›¾
                                        if (e && e.stopPropagation) {
                                            e.stopPropagation();
                                        }
                                        
                                        // æ˜¾ç¤ºè¯¥è¡Œæ”¿åŒºåŸŸçš„é¢ç§¯ä¿¡æ¯
                                        showDistrictAreaInfo(areaName, totalArea, type);
                                        
                                        // é«˜äº®è¢«ç‚¹å‡»çš„å¤šè¾¹å½¢
                                        highlightClickedPolygon(polygon, polygons);
                                        
                                        return false;
                                    });
                                    
                                    // æ·»åŠ é¼ æ ‡æ‚¬åœæ•ˆæœ
                                    polygon.on('mouseover', function() {
                                        polygon.setOptions({
                                            fillOpacity: 0.4,
                                            strokeWeight: 3
                                        });
                                    });
                                    
                                    polygon.on('mouseout', function() {
                                        polygon.setOptions({
                                            fillOpacity: 0.2,
                                            strokeWeight: 2
                                        });
                                    });
                                    
                                    polygons.push(polygon);
                                });
                                
                                // æ·»åŠ åˆ°åœ°å›¾
                                map.add(polygons);
                                currentDistrictPolygon = polygons;
                                
                                // æ ¹æ®åŒºåŸŸå¤§å°åŠ¨æ€è°ƒæ•´ç¼©æ”¾çº§åˆ«
                                if (boundaries.length > 0) {
                                    // ä½¿ç”¨ setFitView è‡ªåŠ¨é€‚é…å·²æ·»åŠ çš„å¤šè¾¹å½¢è§†é‡ï¼Œé¿å…æ‰‹åŠ¨æ„é€  Bounds å¯èƒ½å¯¼è‡´çš„å¼‚å¸¸
                                    setTimeout(() => {
                                        // ç«‹å³é€‚é…è§†é‡ï¼Œé¿å…åŠ¨ç”»åˆ†æ­¥æ•ˆæœ
                                        map.setFitView(polygons, false);
                                        
                                        // è®¡ç®—ç›®æ ‡ä¸­å¿ƒï¼šä»¥åŒºåŸŸè¾¹ç•ŒèŒƒå›´ï¼ˆåŒ…ç»œç›’ï¼‰çš„ä¸­å¿ƒä¸ºå‡†
                                        let targetCenter = null;
                                        let minLng = Infinity, minLat = Infinity, maxLng = -Infinity, maxLat = -Infinity;
                                        boundaries.forEach(boundary => {
                                            boundary.forEach(pt => {
                                                const lng = (typeof pt.lng === 'number') ? pt.lng : (pt.getLng ? pt.getLng() : (Array.isArray(pt) ? pt[0] : undefined));
                                                const lat = (typeof pt.lat === 'number') ? pt.lat : (pt.getLat ? pt.getLat() : (Array.isArray(pt) ? pt[1] : undefined));
                                                if (typeof lng === 'number' && typeof lat === 'number') {
                                                    if (lng < minLng) minLng = lng;
                                                    if (lng > maxLng) maxLng = lng;
                                                    if (lat < minLat) minLat = lat;
                                                    if (lat > maxLat) maxLat = lat;
                                                }
                                            });
                                        });
                                        if (isFinite(minLng) && isFinite(maxLng) && isFinite(minLat) && isFinite(maxLat)) {
                                            targetCenter = [(minLng + maxLng) / 2, (minLat + maxLat) / 2];
                                        } else if (district.center && typeof district.center.lng === 'number' && typeof district.center.lat === 'number') {
                                            // è¾¹ç•Œç‚¹å¼‚å¸¸æ—¶å›é€€åˆ°è¡Œæ”¿åŒºä¸­å¿ƒ
                                            targetCenter = [district.center.lng, district.center.lat];
                                        } else {
                                            // å†æ¬¡å›é€€åˆ°å½“å‰åœ°å›¾ä¸­å¿ƒ
                                            targetCenter = map.getCenter();
                                        }
                                        
                                        // ä¸€æ¬¡æ€§è®¾ç½®æœ€ç»ˆç¼©æ”¾ä¸ä¸­å¿ƒï¼šä¿è¯è‡³å°‘è¾¾åˆ°ç›®æ ‡ç¼©æ”¾çº§åˆ«ï¼Œå¹¶å°†åœ°åŒºä¸­å¿ƒç½®äºæµè§ˆå™¨ä¸­å¿ƒ
                                        const fittedZoom = map.getZoom();
                                        const finalZoom = Math.max(fittedZoom, zoomLevel);
                                        map.setZoomAndCenter(finalZoom, targetCenter);
                                    }, 100);
                                } else {
                                    // è°ƒæ•´åœ°å›¾è§†é‡ä»¥é€‚åº”åŒºåŸŸ
                                    if (district.center) {
                                        // ä½¿ç”¨setZoomAndCenteræ–¹æ³•
                                        map.setZoomAndCenter(zoomLevel, [district.center.lng, district.center.lat]);
                                    } else {
                                        // ä½¿ç”¨setZoomAndCenteræ–¹æ³•ï¼Œä¿æŒå½“å‰ä¸­å¿ƒç‚¹
                                        map.setZoomAndCenter(zoomLevel, map.getCenter());
                                    }
                                }
                                
                                showStatus(`å·²æ˜¾ç¤º${areaName}è¾¹ç•Œ`, 2000, 'success');
                            } else {
                                // æ²¡æœ‰è¾¹ç•Œæ•°æ®æ—¶ï¼Œå…ˆå®šä½åˆ°åŒºåŸŸä¸­å¿ƒï¼Œå†è®¾ç½®ç¼©æ”¾
                                if (district.center) {
                                    map.setCenter([district.center.lng, district.center.lat]);
                                    map.setZoom(zoomLevel);
                                } else {
                                    // å¦‚æœæ²¡æœ‰ä¸­å¿ƒç‚¹ï¼Œå°è¯•é€šè¿‡åœ°ç†ç¼–ç è·å–ä½ç½®
                                    geocoder.getLocation(areaName, function(status, result) {
                                        if (status === 'complete' && result.geocodes && result.geocodes.length > 0) {
                                            const location = result.geocodes[0].location;
                                            map.setZoomAndCenter(zoomLevel, [location.lng, location.lat]);
                                        } else {
                                            map.setZoomAndCenter(zoomLevel, map.getCenter());
                                        }
                                    });
                                }
                                showStatus(`å·²åˆ‡æ¢åˆ°${areaName}è§†å›¾ï¼ˆæ— è¾¹ç•Œæ•°æ®ï¼‰`, 2000, 'warning');
                            }
                        } else {
                            // æœç´¢å¤±è´¥æ—¶ï¼Œå°è¯•é€šè¿‡åœ°ç†ç¼–ç è·å–ä½ç½®
                            geocoder.getLocation(areaName, function(status, result) {
                                if (status === 'complete' && result.geocodes && result.geocodes.length > 0) {
                                    const location = result.geocodes[0].location;
                                    map.setZoomAndCenter(zoomLevel, [location.lng, location.lat]);
                                    showStatus(`å·²å®šä½åˆ°${areaName}`, 2000, 'success');
                                } else {
                                    map.setZoomAndCenter(zoomLevel, map.getCenter());
                                    showStatus(`æ— æ³•è·å–${areaName}ä½ç½®ä¿¡æ¯`, 2000, 'warning');
                                }
                            });
                        }
                    });
                } else {
                    // å¦‚æœdistrictSearchä¸å¯ç”¨ï¼Œå°è¯•é€šè¿‡åœ°ç†ç¼–ç è·å–ä½ç½®
                    geocoder.getLocation(areaName, function(status, result) {
                        if (status === 'complete' && result.geocodes && result.geocodes.length > 0) {
                            const location = result.geocodes[0].location;
                            map.setZoomAndCenter(zoomLevel, [location.lng, location.lat]);
                            showStatus(`å·²å®šä½åˆ°${areaName}`, 2000, 'success');
                        } else {
                            map.setZoomAndCenter(zoomLevel, map.getCenter());
                            showStatus(`å·²åˆ‡æ¢åˆ°${areaName}è§†å›¾`, 2000, 'success');
                        }
                    });
                }
            }
            
            // å¤‡ç”¨é¢ç§¯è®¡ç®—æ–¹æ³•ï¼ˆä½¿ç”¨Shoelaceå…¬å¼ï¼‰
            function calculatePolygonAreaFallback(boundary) {
                if (!boundary || boundary.length < 3) return 0;
                
                let area = 0;
                const n = boundary.length;
                
                for (let i = 0; i < n; i++) {
                    const j = (i + 1) % n;
                    const xi = boundary[i].lng || boundary[i][0];
                    const yi = boundary[i].lat || boundary[i][1];
                    const xj = boundary[j].lng || boundary[j][0];
                    const yj = boundary[j].lat || boundary[j][1];
                    
                    area += xi * yj;
                    area -= xj * yi;
                }
                
                area = Math.abs(area) / 2;
                
                // å°†åº¦æ•°è½¬æ¢ä¸ºç±³ï¼ˆè¿‘ä¼¼ï¼‰
                // 1åº¦ç»åº¦ â‰ˆ 111320ç±³ * cos(çº¬åº¦)
                // 1åº¦çº¬åº¦ â‰ˆ 110540ç±³
                const avgLat = boundary.reduce((sum, point) => {
                    return sum + (point.lat || point[1]);
                }, 0) / boundary.length;
                
                const latToMeter = 110540;
                const lngToMeter = 111320 * Math.cos(avgLat * Math.PI / 180);
                
                return area * latToMeter * lngToMeter;
            }
            
            // å®˜æ–¹é¢ç§¯æ•°æ®æ˜ å°„è¡¨ï¼ˆå•ä½ï¼šå¹³æ–¹åƒç±³ï¼‰
            const officialAreaData = {
                // å›½å®¶
                'ä¸­åäººæ°‘å…±å’Œå›½': 9600000,
                'ä¸­å›½': 9600000,
                
                // ç›´è¾–å¸‚
                'åŒ—äº¬å¸‚': 16410.54,
                'ä¸Šæµ·å¸‚': 6340.5,
                'å¤©æ´¥å¸‚': 11916.85,
                'é‡åº†å¸‚': 82402.95,
                
                // çœä»½ï¼ˆéƒ¨åˆ†ä¸»è¦çœä»½ï¼‰
                'å¹¿ä¸œçœ': 179800,
                'æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº': 1664897,
                'å†…è’™å¤è‡ªæ²»åŒº': 1183000,
                'è¥¿è—è‡ªæ²»åŒº': 1228400,
                'é’æµ·çœ': 722300,
                'å››å·çœ': 486000,
                'é»‘é¾™æ±Ÿçœ': 473000,
                'ç”˜è‚ƒçœ': 425800,
                'äº‘å—çœ': 394100,
                'å¹¿è¥¿å£®æ—è‡ªæ²»åŒº': 236700,
                'æ¹–å—çœ': 211800,
                'é™•è¥¿çœ': 205600,
                'æ²³åŒ—çœ': 188800,
                'å‰æ—çœ': 187400,
                'æ¹–åŒ—çœ': 185900,
                'å¹¿ä¸œçœ': 179800,
                'è´µå·çœ': 176167,
                'æ±Ÿè¥¿çœ': 166900,
                'æ²³å—çœ': 167000,
                'å±±è¥¿çœ': 156700,
                'å±±ä¸œçœ': 157100,
                'è¾½å®çœ': 148000,
                'å®‰å¾½çœ': 140100,
                'ç¦å»ºçœ': 124000,
                'æ±Ÿè‹çœ': 107200,
                'æµ™æ±Ÿçœ': 105500,
                'å®å¤å›æ—è‡ªæ²»åŒº': 66400,
                'æµ·å—çœ': 35400,
                
                // ä¸»è¦åŸå¸‚
                'æ·±åœ³å¸‚': 1997.47,
                'å¹¿å·å¸‚': 7434.4,
                'æ­å·å¸‚': 16853.57,
                'æˆéƒ½å¸‚': 14335,
                'æ­¦æ±‰å¸‚': 8569.15,
                'è¥¿å®‰å¸‚': 10108,
                'å—äº¬å¸‚': 6587.02,
                'é’å²›å¸‚': 11293,
                'å¤§è¿å¸‚': 12573.85,
                'å®æ³¢å¸‚': 9816,
                'å¦é—¨å¸‚': 1699.39,
                'æµå—å¸‚': 10244.45,
                'æ²ˆé˜³å¸‚': 12860,
                'é•¿æ²™å¸‚': 11819,
                'å“ˆå°”æ»¨å¸‚': 53100,
                'çŸ³å®¶åº„å¸‚': 15722,
                'å‘¼å’Œæµ©ç‰¹å¸‚': 17224,
                'å…°å·å¸‚': 13085.6,
                'é“¶å·å¸‚': 9025.38,
                'è¥¿å®å¸‚': 7660,
                'ä¹Œé²æœ¨é½å¸‚': 14216.3,
                'æ‹‰è¨å¸‚': 31662,
                'æ˜†æ˜å¸‚': 21473,
                'è´µé˜³å¸‚': 8034,
                'å—å®å¸‚': 22112,
                'æµ·å£å¸‚': 3145.93,
                'å—æ˜Œå¸‚': 7402.36,
                'é•¿æ˜¥å¸‚': 24744,
                'ç¦å·å¸‚': 12154,
                'éƒ‘å·å¸‚': 7567.18,
                'å¤ªåŸå¸‚': 6988,
                'åˆè‚¥å¸‚': 11445.1
            };
            
            // æ˜¾ç¤ºè¡Œæ”¿åŒºåŸŸé¢ç§¯ä¿¡æ¯
            function showDistrictAreaInfo(areaName, calculatedArea, type) {
                // æ£€æŸ¥æ˜¯å¦æœ‰å®˜æ–¹æ•°æ®
                const officialArea = officialAreaData[areaName];
                let finalArea, dataSource;
                
                if (officialArea) {
                    // ä½¿ç”¨å®˜æ–¹æ•°æ®ï¼ˆå·²ç»æ˜¯å¹³æ–¹åƒç±³ï¼‰
                    finalArea = officialArea * 1000000; // è½¬æ¢ä¸ºå¹³æ–¹ç±³ç”¨äºç»Ÿä¸€è®¡ç®—
                    dataSource = 'å®˜æ–¹æ•°æ®';
                } else {
                    // ä½¿ç”¨è®¡ç®—æ•°æ®ï¼Œåº”ç”¨ä¿®æ­£ç³»æ•°
                    const correctionFactor = 0.98; // ç»éªŒä¿®æ­£ç³»æ•°ï¼Œå‡å°‘çº¦2%çš„åå·®
                    finalArea = calculatedArea * correctionFactor;
                    dataSource = 'åœ°å›¾è®¡ç®—';
                }
                
                // è½¬æ¢å•ä½
                const hectares = finalArea / 10000; // å…¬é¡·
                const squareKm = finalArea / 1000000; // å¹³æ–¹åƒç±³
                
                // æ ¹æ®è¡Œæ”¿çº§åˆ«è®¾ç½®ä¸åŒçš„å›¾æ ‡
                let icon = 'ğŸ˜ï¸';
                if (type === 'city') icon = 'ğŸ™ï¸';
                else if (type === 'province') icon = 'ğŸ—ºï¸';
                else if (type === 'country') icon = 'ğŸ‡¨ğŸ‡³';
                
                // æ ¼å¼åŒ–æ˜¾ç¤º
                areaValue.textContent = `${icon} ${areaName}`;
                
                areaConversions.innerHTML = `
                    <div class="unit-option" data-unit="squareMeters">çº¦ ${formatArea(finalArea)} å¹³æ–¹ç±³</div>
                    <div class="unit-option" data-unit="hectares">çº¦ ${formatArea(hectares)} å…¬é¡·</div>
                    <div class="unit-option" data-unit="squareKm">çº¦ ${formatArea(squareKm)} å¹³æ–¹åƒç±³</div>
                    <div class="area-data-source" style="font-size: 12px; color: #666; margin-top: 8px; padding: 4px 8px; background: #f5f5f5; border-radius: 4px;">
                        æ•°æ®æ¥æº: ${dataSource} ${officialArea ? 'âœ“' : '(ä¼°ç®—)'}
                    </div>
                `;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
                const unitOptions = areaConversions.querySelectorAll('.unit-option');
                unitOptions.forEach(option => {
                    option.addEventListener('click', function() {
                        // ç§»é™¤æ‰€æœ‰activeç±»
                        unitOptions.forEach(opt => opt.classList.remove('active'));
                        areaValue.classList.remove('active');
                        
                        // æ·»åŠ activeç±»åˆ°è¢«ç‚¹å‡»çš„å…ƒç´ 
                        this.classList.add('active');
                    });
                });
                
                areaInfo.style.display = 'block';
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                const accuracyNote = officialArea ? '' : '(ä¼°ç®—å€¼)';
                showStatus(`${areaName}é¢ç§¯ï¼š${formatArea(squareKm)} å¹³æ–¹åƒç±³ ${accuracyNote}`, 4000, 'success');
            }
            
            // é«˜äº®è¢«ç‚¹å‡»çš„å¤šè¾¹å½¢
            function highlightClickedPolygon(clickedPolygon, allPolygons) {
                // é‡ç½®æ‰€æœ‰å¤šè¾¹å½¢æ ·å¼
                allPolygons.forEach(polygon => {
                    const originalOptions = polygon.getOptions();
                    polygon.setOptions({
                        fillOpacity: 0.2,
                        strokeWeight: 2,
                        strokeOpacity: 0.8
                    });
                });
                
                // é«˜äº®è¢«ç‚¹å‡»çš„å¤šè¾¹å½¢
                clickedPolygon.setOptions({
                    fillOpacity: 0.5,
                    strokeWeight: 4,
                    strokeOpacity: 1
                });
            }
            
            // æ›´æ–°ä½ç½®ä¿¡æ¯æ˜¾ç¤º
            function updateLocationInfo(locationInfo) {
                currentLocationInfo = locationInfo;
                
                if (locationInfo.district) {
                    document.getElementById('district-text').textContent = locationInfo.district;
                }
                if (locationInfo.city) {
                    document.getElementById('city-text').textContent = locationInfo.city;
                }
                if (locationInfo.province) {
                    document.getElementById('province-text').textContent = locationInfo.province;
                }
            }
            
            // è®¡ç®—ä¸¤ç‚¹é—´è·ç¦»ï¼ˆç±³ï¼‰
            function calculateDistance(lat1, lng1, lat2, lng2) {
                const R = 6371000; // åœ°çƒåŠå¾„ï¼ˆç±³ï¼‰
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLng = (lng1 - lng2) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                        Math.sin(dLng/2) * Math.sin(dLng/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }
            
            // æœç´¢ç›®çš„åœ°
            function searchDestination() {
                const keyword = destinationInput.value.trim();
                if (!keyword) {
                    showStatus('è¯·è¾“å…¥ç›®çš„åœ°åç§°æˆ–åœ°å€', 2000, 'warning');
                    return;
                }
                
                showStatus(`æ­£åœ¨æœç´¢"${keyword}"...`, 2000, 'info');
                
                // ä½¿ç”¨åœ°ç†ç¼–ç æœç´¢
                geocoder.getLocation(keyword, function(status, result) {
                    if (status === 'complete' && result.geocodes && result.geocodes.length > 0) {
                        const geocodes = result.geocodes;
                        
                        if (geocodes.length === 1) {
                            // åªæœ‰ä¸€ä¸ªç»“æœï¼Œç›´æ¥å®šä½
                            const location = geocodes[0];
                            navigateToDestination(location, keyword);
                        } else {
                            // å¤šä¸ªç»“æœï¼Œæ˜¾ç¤ºé€‰æ‹©åˆ—è¡¨
                            displayDestinationResults(geocodes, keyword);
                        }
                    } else {
                        // åœ°ç†ç¼–ç å¤±è´¥ï¼Œå°è¯•POIæœç´¢
                        placeSearch.search(keyword, function(status, result) {
                            if (status === 'complete' && result.poiList && result.poiList.pois.length > 0) {
                                const places = result.poiList.pois;
                                
                                if (places.length === 1) {
                                    // åªæœ‰ä¸€ä¸ªç»“æœï¼Œç›´æ¥å®šä½
                                    navigateToPlace(places[0], 'ğŸ“');
                                } else {
                                    // å¤šä¸ªç»“æœï¼Œæ˜¾ç¤ºé€‰æ‹©åˆ—è¡¨
                                    displaySearchResults(places, keyword, 'ğŸ“', 'å…¨å›½', 'country');
                                }
                            } else {
                                showStatus(`æœªæ‰¾åˆ°"${keyword}"ç›¸å…³ä½ç½®`, 3000, 'warning');
                            }
                        });
                    }
                });
                
                // å…³é—­æ›´å¤šé¢æ¿
                morePanel.classList.remove('show');
            }
            
            // å®šä½åˆ°ç›®çš„åœ°
            function navigateToDestination(location, keyword) {
                // æ¸…é™¤åŒºåŸŸè¾¹ç•Œå’Œè‰²å—
                if (currentDistrictPolygon) {
                    map.remove(currentDistrictPolygon);
                    currentDistrictPolygon = null;
                }
                
                // æ¸…é™¤ä¹‹å‰çš„æ ‡è®°
                if (window.nearbyMarkers) {
                    window.nearbyMarkers.forEach(marker => map.remove(marker));
                }
                window.nearbyMarkers = [];
                
                // å®šä½åˆ°è¯¥ä½ç½®
                map.setCenter([location.location.lng, location.location.lat]);
                map.setZoom(16);
                
                // æ·»åŠ æ ‡è®°
                const marker = new AMap.Marker({
                    position: [location.location.lng, location.location.lat],
                    icon: new AMap.Icon({
                        size: new AMap.Size(30, 40),
                        image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png'
                    }),
                    title: location.formattedAddress || keyword
                });
                
                const infoWindow = new AMap.InfoWindow({
                    content: `
                        <div style="padding: 10px;">
                            <h4 style="margin: 0 0 5px 0; color: #333;">ğŸ“ ${location.formattedAddress || keyword}</h4>
                            <p style="margin: 0; color: #666; font-size: 12px;">${location.addressComponent ? 
                                `${location.addressComponent.province || ''} ${location.addressComponent.city || ''} ${location.addressComponent.district || ''}` : 
                                'è¯¦ç»†åœ°å€ä¿¡æ¯'}</p>
                        </div>
                    `,
                    offset: new AMap.Pixel(0, -30)
                });
                
                map.add(marker);
                window.nearbyMarkers = [marker];
                
                // è‡ªåŠ¨æ‰“å¼€ä¿¡æ¯çª—å£
                setTimeout(() => {
                    infoWindow.open(map, marker.getPosition());
                }, 500);
                
                showStatus(`å·²å®šä½åˆ°${location.formattedAddress || keyword}`, 3000, 'success');
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                destinationInput.value = '';
            }
            
            // æ˜¾ç¤ºç›®çš„åœ°æœç´¢ç»“æœåˆ—è¡¨
            function displayDestinationResults(geocodes, keyword) {
                // åˆ›å»ºé®ç½©å±‚
                const overlay = document.createElement('div');
                overlay.className = 'places-overlay';
                
                // åˆ›å»ºåˆ—è¡¨å®¹å™¨
                const listContainer = document.createElement('div');
                listContainer.className = 'places-list';
                
                // åˆ›å»ºæ ‡é¢˜
                const header = document.createElement('div');
                header.className = 'places-list-header';
                header.innerHTML = `
                    <div class="places-list-header-content">
                        <h3 class="places-list-title">ğŸ“ ${keyword} (${geocodes.length}ä¸ª)</h3>
                        <button id="close-destination-list" class="places-list-close">Ã—</button>
                    </div>
                    <p class="places-list-subtitle">æœç´¢ç»“æœ</p>
                `;
                
                // åˆ›å»ºåˆ—è¡¨å†…å®¹
                const listContent = document.createElement('div');
                listContent.className = 'places-list-content';
                
                // å…³é—­åˆ—è¡¨å’Œé®ç½©å±‚çš„å‡½æ•°
                const closeList = () => {
                    listContainer.remove();
                    overlay.remove();
                };
                
                geocodes.slice(0, 10).forEach((location, index) => {
                    const item = document.createElement('div');
                    item.className = 'places-list-item';
                    
                    item.innerHTML = `
                        <div class="places-list-item-name">${location.formattedAddress}</div>
                        <div class="places-list-item-address">${location.addressComponent ? 
                            `${location.addressComponent.province || ''} ${location.addressComponent.city || ''} ${location.addressComponent.district || ''}` : 
                            'è¯¦ç»†åœ°å€ä¿¡æ¯'}</div>
                    `;
                    
                    item.addEventListener('click', () => {
                        navigateToDestination(location, keyword);
                        closeList();
                    });
                    
                    listContent.appendChild(item);
                });
                
                listContainer.appendChild(header);
                listContainer.appendChild(listContent);
                
                // æ·»åŠ åˆ°é¡µé¢
                document.body.appendChild(overlay);
                document.body.appendChild(listContainer);
                
                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                overlay.addEventListener('click', closeList);
                
                // å…³é—­æŒ‰é’®äº‹ä»¶
                const closeButton = document.getElementById('close-destination-list');
                if (closeButton) {
                    closeButton.addEventListener('click', closeList);
                }
                
                showStatus(`æ‰¾åˆ°${geocodes.length}ä¸ª"${keyword}"ç›¸å…³ä½ç½®ï¼Œè¯·é€‰æ‹©`, 3000, 'info');
             }
             
             // åˆå§‹åŒ–
             initMap();
         });
     </script>
 </body>
 </html>