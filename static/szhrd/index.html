<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•°å­—åå®¹é“ï¼ˆAIåŠ©æ•™ç‰ˆï¼‰</title>
    <style>
        :root {
            /* --- é»˜è®¤é£æ ¼ (Default) --- */
            --bg-page: #eef9ff; 
            --board-base: #ffb74d; 
            
            --layer-1: #ff8a80; 
            --layer-2: #4fc3f7; 
            --layer-3: #aed581; 
            --layer-4: #ce93d8; 
            
            --text-dark: #5d4037;
            --accent: #ff6f00;
            --tile-text: #ffffff;
            --btn-bg: #ff6f00;
            --btn-text: #ffffff;
            --tile-shadow: 0 5px 0 rgba(0,0,0,0.15), inset 0 -3px 0 rgba(0,0,0,0.1);
            --board-shadow: #e6a13c;
            
            --font-main: "Rounded Mplus 1c", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            --radius-main: 12px;
            --tile-border: none;
            --text-effect: none; /* æ–‡å­—ç‰¹æ•ˆå˜é‡ */
        }

        /* --- è“å¢¨æ°´é£æ ¼ (Blue Ink) --- */
        body.theme-blue {
            --bg-page: #e3f2fd;
            --board-base: #1565c0;
            
            --layer-1: #90caf9;
            --layer-2: #64b5f6;
            --layer-3: #42a5f5;
            --layer-4: #2196f3;
            
            --text-dark: #0d47a1;
            --accent: #1565c0;
            --tile-text: #ffffff;
            --btn-bg: #1565c0;
            --btn-text: #ffffff;
            --tile-shadow: 0 5px 0 rgba(0,0,0,0.2), inset 0 -3px 0 rgba(0,0,0,0.1);
            --board-shadow: #0d47a1;
        }

        /* --- å¤å¤æ‰‹ç»˜é£æ ¼ (Retro/Sketch) --- */
        body.theme-retro {
            --bg-page: #fff9c4;
            --board-base: #5d4037;
            
            --layer-1: #ffccbc;
            --layer-2: #ffe082;
            --layer-3: #c8e6c9;
            --layer-4: #d1c4e9;
            
            --text-dark: #3e2723;
            --accent: #bf360c;
            --tile-text: #3e2723;
            --btn-bg: #bf360c;
            --btn-text: #fff;
            --tile-shadow: 0 4px 0 rgba(62, 39, 35, 0.3);
            --board-shadow: #3e2723;
            
            --font-main: "Comic Sans MS", "Chalkboard SE", sans-serif;
            --radius-main: 4px;
        }

        /* --- æš—å¤œéœ“è™¹ (Dark Mode - Flowing Neon) --- */
        body.theme-dark {
            --bg-page: #050505;
            --board-base: #1a1a1a;
            
            /* éœ“è™¹è‰²å®šä¹‰ */
            --layer-1: #ff0055; /* éœ“è™¹çº¢ */
            --layer-2: #00e5ff; /* éœ“è™¹è“ */
            --layer-3: #76ff03; /* éœ“è™¹ç»¿ */
            --layer-4: #d500f9; /* éœ“è™¹ç´« */
            
            --text-dark: #e0e0e0;
            --accent: #00e676;
            --tile-text: #ffffff; /* ä¸‹é¢ä¼šé’ˆå¯¹ä¸åŒå±‚è¦†ç›–é¢œè‰² */
            --btn-bg: #1a1a1a;
            --btn-text: #00e676;
            
            /* ç§»é™¤é»˜è®¤é˜´å½±ï¼Œæ”¹ä¸ºå‘å…‰æ•ˆæœåœ¨å…·ä½“ç±»ä¸­å®ç° */
            --tile-shadow: none; 
            --board-shadow: #000000;
        }

        /* --- åŸæœ¨ç»å…¸ (Wood - Carved 3D) --- */
        body.theme-wood {
            --bg-page: #f4e1c1;
            --board-base: #5d4037; /* æ·±æœ¨è‰²åº•åº§ */
            
            /* æ¨¡æ‹Ÿä¸åŒæœ¨æçš„é¢œè‰² */
            --layer-1: #d7ccc8; /* æ¡¦æœ¨ */
            --layer-2: #d7ccc8; 
            --layer-3: #d7ccc8; 
            --layer-4: #d7ccc8; 
            
            --text-dark: #3e2723;
            --accent: #5d4037;
            --tile-text: #5d4037; /* æ·±æ£•è‰²æ–‡å­— */
            --btn-bg: #5d4037;
            --btn-text: #f4e1c1;
            
            /* æœ¨å—åšåº¦é˜´å½± */
            --tile-shadow: 
                inset 0 0 10px rgba(93, 64, 55, 0.1), /* è¡¨é¢çº¹ç†æ„Ÿ */
                0 4px 0 #8d6e63, /* ä¾§è¾¹ */
                0 6px 4px rgba(0,0,0,0.3); /* æŠ•å½± */
                
            --board-shadow: #3e2723;
            --radius-main: 4px; /* ç¨å¾®ç¡¬ä¸€ç‚¹çš„å€’è§’ */
            
            /* é›•åˆ»å†…å‡¹æ•ˆæœ: ä¸Šé˜´å½± + ä¸‹é«˜å…‰ */
            --text-effect: 1px 1px 0 rgba(255,255,255,0.6), -1px -1px 1px rgba(0,0,0,0.8);
        }

        /* --- æç®€é»‘ç™½ (Minimal) --- */
        body.theme-minimal {
            --bg-page: #ffffff;
            --board-base: #000000;
            
            --layer-1: #ffffff;
            --layer-2: #ffffff;
            --layer-3: #ffffff;
            --layer-4: #ffffff;
            
            --text-dark: #000000;
            --accent: #000000;
            --tile-text: #000000;
            --btn-bg: #000000;
            --btn-text: #ffffff;
            --tile-shadow: 4px 4px 0 #000000;
            --board-shadow: #666;
            --radius-main: 0px;
            --tile-border: 2px solid #000;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            height: 100vh;
            background: var(--bg-page);
            font-family: var(--font-main);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            color: var(--text-dark);
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container {
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: space-between; 
            width: 100%;
            height: 100%;
            max-width: 600px;
            padding: 10px;
            position: relative;
        }

        .game-main {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex: 1; 
            width: 100%;
            padding-bottom: 80px; 
            margin-top: -10vh; /* è°ƒæ•´åçš„ margin-top */
        }

        .controls { 
            width: 95%;
            max-width: 500px;
            margin-bottom: 25px;
            display: grid; 
            grid-template-columns: 1fr auto 1fr;
            align-items: center; 
            gap: 10px;
        }
        
        .style-select-wrapper {
            justify-self: start;
        }

        .style-selector {
            appearance: none;
            -webkit-appearance: none;
            padding: 8px 30px 8px 20px; 
            background-color: var(--btn-bg); 
            color: var(--btn-text);
            border: 1px solid transparent; 
            border-radius: 50px; 
            cursor: pointer; 
            font-weight: bold;
            box-shadow: 0 4px 0 var(--board-shadow);
            transition: 0.1s;
            font-size: 0.95rem;
            outline: none;
            font-family: inherit;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 14px;
        }

        .style-selector:active {
            transform: translateY(3px); 
            box-shadow: 0 2px 0 var(--board-shadow); 
        }

        body.theme-minimal .style-selector {
            border: 2px solid #000;
            box-shadow: 2px 2px 0 #000;
            border-radius: 0;
        }
        body.theme-minimal .style-selector:active {
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        body.theme-dark .style-selector {
            border: 1px solid var(--accent);
            box-shadow: 0 0 10px rgba(0, 230, 118, 0.3);
            text-shadow: 0 0 5px rgba(0, 230, 118, 0.8);
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2300e676' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        }

        #status {
            justify-self: center;
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--accent);
            background: rgba(255,255,255,0.8);
            padding: 6px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
            transition: transform 0.1s;
        }
        
        #status:active {
            transform: scale(0.95);
        }

        .btn-wrapper {
            justify-self: end;
            display: flex;
            gap: 6px;
        }
        .btn {
            padding: 8px 20px; 
            background: var(--btn-bg); 
            color: var(--btn-text);
            border: 1px solid transparent; 
            border-radius: 50px; 
            cursor: pointer; 
            font-weight: bold;
            box-shadow: 0 4px 0 var(--board-shadow);
            transition: 0.1s;
            font-size: 0.95rem;
            z-index: 20; 
            white-space: nowrap;
        }
        .btn:active { 
            transform: translateY(3px); 
            box-shadow: 0 2px 0 var(--board-shadow); 
        }
        
        /* å³ä¸Šè§’é€Ÿé€šæŒ‰é’®æ ·å¼ */
        .btn-top-right {
            position: absolute;
            top: 15px;
            right: 20px;
            padding: 8px 14px;
            z-index: 50;
        }
        
        body.theme-minimal .btn {
            border: 2px solid #000;
            box-shadow: 2px 2px 0 #000;
            border-radius: 0;
        }
        body.theme-minimal .btn:active {
             transform: translate(2px, 2px);
             box-shadow: none;
        }

        body.theme-dark .btn {
            border: 1px solid var(--accent);
            box-shadow: 0 0 10px rgba(0, 230, 118, 0.3);
            text-shadow: 0 0 5px rgba(0, 230, 118, 0.8);
        }

        .board-outer {
            background: var(--board-base);
            padding: 12px;
            border-radius: 20px;
            box-shadow: 0 8px 0 var(--board-shadow), 0 10px 20px rgba(0,0,0,0.15);
            width: 90%; 
            aspect-ratio: 1 / 1; 
            display: flex;
            align-items: center;
            justify-content: center;
            max-height: 500px;
            max-width: 500px;
            z-index: 10;
            position: relative; 
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }
        
        body.theme-dark .board-outer {
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            border: 1px solid #333;
        }

        body.theme-minimal .board-outer {
            border: 4px solid #000;
            box-shadow: 8px 8px 0 #666;
            border-radius: 0;
        }

        .board-inner {
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1); 
            border-radius: 12px;
            position: relative;
            box-shadow: inset 6px 6px 10px rgba(0,0,0,0.1);
            padding: 6px;
        }
        
        body.theme-minimal .board-inner {
            background: transparent;
            box-shadow: none;
            border-radius: 0;
        }
        
        body.theme-dark .board-inner {
            background: #000;
            box-shadow: inset 0 0 20px #000;
        }

        .loading-mask {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(3px); 
            border-radius: 20px; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }
        
        body.theme-dark .loading-mask {
            background: rgba(0, 0, 0, 0.85);
        }

        .loading-mask.active {
            opacity: 1;
            pointer-events: all;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0,0,0,0.1);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        .loading-text {
            color: var(--accent);
            font-weight: bold;
            font-size: 1.1rem;
            letter-spacing: 1px;
            animation: breathe 1.5s infinite ease-in-out;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .tile {
            position: absolute;
            width: calc(25% - 8px);
            height: calc(25% - 8px);
            border-radius: var(--radius-main);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(2.5rem, 8vw, 3.5rem); 
            font-weight: 900;
            color: var(--tile-text);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: var(--tile-shadow);
            border: var(--tile-border);
            text-shadow: var(--text-effect); 
            z-index: 1;
        }
        
        body.theme-minimal .tile:active {
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        body:not(.theme-dark) .tile.layer-1, body:not(.theme-dark) .step-item.layer-1 { background-color: var(--layer-1); }
        body:not(.theme-dark) .tile.layer-2, body:not(.theme-dark) .step-item.layer-2 { background-color: var(--layer-2); }
        body:not(.theme-dark) .tile.layer-3, body:not(.theme-dark) .step-item.layer-3 { background-color: var(--layer-3); }
        body:not(.theme-dark) .tile.layer-4, body:not(.theme-dark) .step-item.layer-4 { background-color: var(--layer-4); }

        body.theme-dark .tile {
            background-color: rgba(10, 10, 10, 0.9); 
            border-width: 2px;
            border-style: solid;
            animation: neon-flow 3s infinite alternate; 
        }

        body.theme-dark .tile.layer-1 { border-color: var(--layer-1); color: var(--layer-1); box-shadow: 0 0 5px var(--layer-1), inset 0 0 10px rgba(255,0,85,0.2); text-shadow: 0 0 5px var(--layer-1); }
        body.theme-dark .tile.layer-2 { border-color: var(--layer-2); color: var(--layer-2); box-shadow: 0 0 5px var(--layer-2), inset 0 0 10px rgba(0,229,255,0.2); text-shadow: 0 0 5px var(--layer-2); }
        body.theme-dark .tile.layer-3 { border-color: var(--layer-3); color: var(--layer-3); box-shadow: 0 0 5px var(--layer-3), inset 0 0 10px rgba(118,255,3,0.2); text-shadow: 0 0 5px var(--layer-3); }
        body.theme-dark .tile.layer-4 { border-color: var(--layer-4); color: var(--layer-4); box-shadow: 0 0 5px var(--layer-4), inset 0 0 10px rgba(213,0,249,0.2); text-shadow: 0 0 5px var(--layer-4); }

        @keyframes neon-flow {
            0% { box-shadow: 0 0 4px currentColor, inset 0 0 5px currentColor; }
            50% { box-shadow: 0 0 12px currentColor, inset 0 0 15px currentColor; }
            100% { box-shadow: 0 0 4px currentColor, inset 0 0 5px currentColor; }
        }
        
        body.theme-dark .step-item { background: transparent; border-width: 2px; border-style: solid; font-weight: bold; }
        body.theme-dark .step-item.layer-1 { border-color: var(--layer-1); color: var(--layer-1); text-shadow: 0 0 3px var(--layer-1); }
        body.theme-dark .step-item.layer-2 { border-color: var(--layer-2); color: var(--layer-2); text-shadow: 0 0 3px var(--layer-2); }
        body.theme-dark .step-item.layer-3 { border-color: var(--layer-3); color: var(--layer-3); text-shadow: 0 0 3px var(--layer-3); }
        body.theme-dark .step-item.layer-4 { border-color: var(--layer-4); color: var(--layer-4); text-shadow: 0 0 3px var(--layer-4); }


        .tile.locked {
            filter: brightness(0.95);
        }
        body.theme-dark .tile.locked {
            filter: brightness(0.6);
            opacity: 0.7;
        }

        .tile.locked::after {
            content: 'ğŸ”’';
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 0.9rem;
            opacity: 0.6;
            color: var(--tile-text);
        }
        body.theme-dark .tile.locked::after {
            color: inherit; 
        }

        .tile.hint {
            border: 4px solid #fff; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.2); 
            animation: breathe 2s infinite ease-in-out; 
            z-index: 10;
        }
        
        body.theme-minimal .tile.hint {
            background-color: #000 !important;
            color: #fff !important;
            box-shadow: none;
        }
        
        body.theme-dark .tile.hint {
            border: 2px solid #fff;
            box-shadow: 0 0 20px #fff;
            animation: breathe 1s infinite ease-in-out; 
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); } 
        }

        .sidebar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: auto;
            max-height: 25vh; 
            background: white;
            border-radius: 25px 25px 0 0; 
            border-top: 6px solid var(--board-base);
            display: flex;
            flex-direction: column;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            z-index: 100;
            padding-bottom: 1rem; 
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            /* é»˜è®¤éšè—åœ¨åº•éƒ¨ */
            transform: translateY(110%);
        }

        .sidebar.active {
            transform: translateY(0);
        }
        
        body.theme-dark .sidebar {
            background: #0a0a0a;
            border-top: 2px solid #333;
        }

        .sidebar-header {
            background: transparent;
            color: var(--text-dark);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
        }
        
        body.theme-dark .sidebar-header {
            border-bottom: 1px solid #333;
        }

        .header-left { display: flex; align-items: center; gap: 10px; flex: 1; }
        
        .header-title {
            font-size: 1rem;
            font-weight: bold;
            white-space: nowrap;
        }

        .current-goal {
            background: rgba(255, 243, 224, 0.5);
            color: var(--accent);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border: 1px solid var(--accent);
        }
        
        body.theme-dark .current-goal {
            background: rgba(0, 230, 118, 0.1);
            color: #00e676;
            border: 1px solid #00e676;
        }

        .algo-selector {
            appearance: none;
            -webkit-appearance: none; 
            padding: 6px 30px 6px 12px;
            border-radius: 20px;
            border: 2px solid var(--board-base);
            background: white url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ff6f00' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") no-repeat right 8px center;
            background-size: 14px;
            color: var(--accent);
            font-weight: bold;
            font-family: inherit;
            font-size: 0.85rem;
            outline: none;
            cursor: pointer;
            width: auto;
            box-shadow: 0 3px 0 rgba(0,0,0,0.1);
            transition: all 0.2s;
        }

        .algo-selector:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0 rgba(0,0,0,0.1);
        }
        
        body.theme-dark .algo-selector {
            background-color: #222;
            border-color: #00e676;
            color: #00e676;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2300e676' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        }

        #step-list {
            flex: 1;
            display: flex;
            flex-direction: row; 
            overflow-x: auto; 
            overflow-y: hidden;
            padding: 30px 15px;
            gap: 12px;
            align-items: center;
            scrollbar-width: none; 
        }
        #step-list::-webkit-scrollbar { display: none; }

        .step-item {
            width: 50px;
            height: 50px;
            flex-shrink: 0;
            border-radius: var(--radius-main);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1.2rem;
            color: var(--tile-text);
            box-shadow: 0 3px 0 rgba(0,0,0,0.15);
            position: relative;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        body.theme-minimal .step-item {
             border: 2px solid #000;
             box-shadow: 2px 2px 0 #000;
        }

        .step-item:not(:last-child)::after {
            content: 'â†’';
            position: absolute;
            right: -14px;
            color: #ccc;
            font-size: 1rem;
            font-weight: normal;
        }

        .step-item.active {
            transform: scale(1.1);
            border: 2px solid var(--accent);
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
            z-index: 2;
        }
        
        body.theme-minimal .step-item.active {
            border: 4px solid #000;
            box-shadow: 4px 4px 0 #000;
        }
        
        body.theme-dark .step-item.active {
            border: 2px solid #fff;
            box-shadow: 0 0 15px currentColor;
        }

        .empty-tip {
            width: 100%;
            text-align: center;
            color: #999;
            font-size: 0.9rem;
            padding: 10px;
        }

        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }

        /* å¬å”¤ AI æŒ‰é’®æ ·å¼ */
        .summon-btn {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--btn-bg);
            color: var(--btn-text);
            padding: 12px 30px;
            border-radius: 50px;
            border: none;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 200;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
        }

        .summon-btn:active {
            transform: translateX(-50%) scale(0.95);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* æŒ‰é’®éšè—æ—¶çš„çŠ¶æ€ */
        .summon-btn.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateX(-50%) translateY(50px);
        }
        
        body.theme-minimal .summon-btn {
            border: 2px solid #000;
            box-shadow: 4px 4px 0 #000;
            border-radius: 0;
        }
        
        body.theme-dark .summon-btn {
            border: 1px solid var(--accent);
            box-shadow: 0 0 15px rgba(0, 230, 118, 0.4);
            color: #00e676;
        }

    </style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>

<div class="container">
    <!-- é€Ÿé€šæŒ‰é’®ï¼ˆå³ä¸Šè§’ï¼‰ -->
    <button class="btn btn-top-right" onclick="initEasyGame()" title="é€Ÿé€šæ¨¡å¼ï¼šç›´æ¥è¿›å…¥åä¸¤è¡Œ">= </button>

    <div class="game-main">
        <div class="controls">
            <!-- å·¦ä¾§ï¼šé£æ ¼åˆ‡æ¢ -->
            <div class="style-select-wrapper">
                <select class="style-selector" onchange="changeTheme(this.value)">
                    <option value="default">å¤šå½©</option>
                    <option value="blue">è“å¢¨</option>
                    <option value="retro">å¤å¤</option>
                    <option value="dark">éœ“è™¹</option>
                    <option value="wood">åŸæœ¨</option>
                    <option value="minimal">é»‘ç™½</option>
                </select>
            </div>

            <!-- ä¸­é—´ï¼šæ­¥æ•°æ˜¾ç¤º -->
            <div id="status" onclick="toggleFullScreen()">0</div>

            <!-- å³ä¾§ï¼šæ–°æŒ‘æˆ˜æŒ‰é’® -->
            <div class="btn-wrapper">
                <button class="btn" onclick="initGame()">æ–°æŒ‘æˆ˜</button>
            </div>
        </div>

        <div class="board-outer">
            <div class="board-inner" id="board"></div>
            <!-- åŠ è½½é®ç½©å±‚ -->
            <div id="loading-mask" class="loading-mask">
                <div class="spinner"></div>
                <div class="loading-text">AI æ­£åœ¨å…¨é€Ÿæ€è€ƒä¸­â€¦â€¦</div>
            </div>
        </div>

        <!-- å¬å”¤ AI æŒ‰é’® -->
        <button id="summon-btn" class="summon-btn" onclick="summonAI()">ğŸ¤– å¬å”¤ AI</button>
    </div>

    <!-- åº•éƒ¨æµ®åŠ¨æ•™å­¦åŠ©æ‰‹ -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="header-left">
                <div class="header-title">AI åŠ©æ‰‹</div>
                <div id="goal-display" class="current-goal">
                    <span>å‡†å¤‡å°±ç»ª</span>
                </div>
            </div>
            <select id="algo-select" class="algo-selector" onchange="triggerAI(true)">
                <option value="regular" selected>å¸¸è§„ (é€ä¸ª)</option>
                <option value="intermediate">ğŸš€ ä¸­é˜¶ (é€å±‚)</option>
                <option value="advanced">é«˜é˜¶ (IDA*)</option>
            </select>
        </div>
        <div id="step-list">
            <div class="empty-tip">ç‚¹å‡»â€œæ–°æŒ‘æˆ˜â€å¼€å§‹</div>
        </div>
    </div>
</div>

<script>
    const GOAL = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 0];
    const TARGET_POS = {}; 
    GOAL.forEach((v, i) => TARGET_POS[v] = i);

    // é¢„è®¡ç®—æ‰€æœ‰ä½ç½®çš„é‚»å±…ç´¢å¼•
    const NEIGHBOR_MAP = [];
    for(let i=0; i<16; i++) {
        const r = Math.floor(i/4), c = i%4;
        const neighbors = [];
        if (r > 0) neighbors.push(i - 4);
        if (r < 3) neighbors.push(i + 4);
        if (c > 0) neighbors.push(i - 1);
        if (c < 3) neighbors.push(i + 1);
        NEIGHBOR_MAP[i] = neighbors;
    }

    class MinHeap {
        constructor() { this.data = []; }
        push(val) {
            this.data.push(val);
            this.bubbleUp(this.data.length - 1);
        }
        pop() {
            if (this.data.length === 0) return null;
            const top = this.data[0];
            const bottom = this.data.pop();
            if (this.data.length > 0) {
                this.data[0] = bottom;
                this.sinkDown(0);
            }
            return top;
        }
        size() { return this.data.length; }
        bubbleUp(i) {
            while (i > 0) {
                const p = Math.floor((i - 1) / 2);
                if (this.data[p].f <= this.data[i].f) break;
                [this.data[p], this.data[i]] = [this.data[i], this.data[p]];
                i = p;
            }
        }
        sinkDown(i) {
            const length = this.data.length;
            while (true) {
                let left = 2 * i + 1, right = 2 * i + 2, swap = null;
                if (left < length && this.data[left].f < this.data[i].f) swap = left;
                if (right < length && this.data[right].f < (swap === null ? this.data[i].f : this.data[left].f)) swap = right;
                if (swap === null) break;
                [this.data[i], this.data[swap]] = [this.data[swap], this.data[i]];
                i = swap;
            }
        }
    }

    let state = [];
    let moves = 0;
    let currentPath = []; 
    let isComputing = false;
    let lockedIndices = []; 
    let isAIActive = false; // æ§åˆ¶ AI æ˜¯å¦æ¿€æ´»

    function initGame() {
        moves = 0;
        currentPath = [];
        
        // é‡ç½® AI çŠ¶æ€ï¼šéšè—é¢æ¿ï¼Œæ˜¾ç¤ºå¬å”¤æŒ‰é’®
        isAIActive = false;
        document.querySelector('.sidebar').classList.remove('active');
        document.getElementById('summon-btn').classList.remove('hidden');
        
        // ç§»é™¤æ‰€æœ‰çš„é«˜äº®æç¤º
        document.querySelectorAll('.tile').forEach(t => t.classList.remove('hint'));

        state = generateSolvableState();
        stopConfetti(); 
        renderBoard();
        updateUI();
        
        // åˆå§‹åŒ–æ—¶ä¸å†è‡ªåŠ¨è®¡ç®—ï¼Œå› ä¸º isAIActive ä¸º false
        triggerAI(true);
    }
    
    // --- æ–°å¢ï¼šåˆå§‹åŒ–ç®€å•æ¨¡å¼ï¼ˆå‰ä¸¤è¡Œå·²è§£ï¼‰ ---
    function initEasyGame() {
        moves = 0;
        currentPath = [];
        
        isAIActive = false;
        document.querySelector('.sidebar').classList.remove('active');
        document.getElementById('summon-btn').classList.remove('hidden');
        document.querySelectorAll('.tile').forEach(t => t.classList.remove('hint'));

        state = generateEasyState();
        stopConfetti();
        renderBoard();
        updateUI();

        triggerAI(true);
    }

    function generateEasyState() {
        // å‰ä¸¤è¡Œå›ºå®š
        const top = [1, 2, 3, 4, 5, 6, 7, 8];
        // åä¸¤è¡Œéšæœº
        const bottomItems = [9, 10, 11, 12, 13, 14, 15, 0];
        let fullState;

        do {
            const shuffledBottom = [...bottomItems].sort(() => Math.random() - 0.5);
            fullState = top.concat(shuffledBottom);
        } while (!isSolvable(fullState));

        return fullState;
    }

    function summonAI() {
        isAIActive = true;
        // æ˜¾ç¤º AI é¢æ¿
        document.querySelector('.sidebar').classList.add('active');
        // éšè—å¬å”¤æŒ‰é’®
        document.getElementById('summon-btn').classList.add('hidden');
        // ç«‹å³è§¦å‘ AI è®¡ç®—
        triggerAI(true);
    }

    function generateSolvableState() {
        let arr;
        do { arr = [...GOAL].sort(() => Math.random() - 0.5); } while (!isSolvable(arr));
        return arr;
    }

    function isSolvable(arr) {
        let inv = 0;
        for (let i = 0; i < 16; i++) {
            if (arr[i] === 0) continue;
            for (let j = i + 1; j < 16; j++) { if (arr[j] !== 0 && arr[i] > arr[j]) inv++; }
        }
        const row = 4 - Math.floor(arr.indexOf(0) / 4);
        return (inv + row) % 2 !== 0;
    }

    function changeTheme(themeName) {
        document.body.className = ''; 
        if (themeName !== 'default') {
            document.body.classList.add('theme-' + themeName);
        }
    }

    function handleMove(idx) {
        if (isComputing) return;

        const emptyIdx = state.indexOf(0);
        const r1 = Math.floor(idx / 4), c1 = idx % 4;
        const r2 = Math.floor(emptyIdx / 4), c2 = emptyIdx % 4;

        if (Math.abs(r1 - r2) + Math.abs(c1 - c2) === 1) {
            const movedValue = state[idx];
            // åªæœ‰å½“ AI æ¿€æ´»æ—¶æ‰åˆ¤æ–­æ˜¯å¦è·Ÿéš
            const followedAI = (isAIActive && currentPath.length > 0 && movedValue === currentPath[0]);

            state[emptyIdx] = state[idx];
            state[idx] = 0;
            moves++;

            if (followedAI) {
                currentPath.shift();
                if (currentPath.length === 0 && !isGameComplete()) {
                    renderBoard();
                    updateUI();
                    triggerAI(false); 
                } else {
                    displayPath(currentPath);
                    renderBoard();
                    updateUI();
                }
            } else {
                renderBoard();
                updateUI();
                // å¦‚æœ AI æ¿€æ´»çŠ¶æ€ä¸‹èµ°é”™äº†æˆ–æ²¡è·Ÿéšï¼Œé‡æ–°è®¡ç®—ï¼›å¦‚æœæ²¡æ¿€æ´»ï¼Œè¿™é‡Œä»€ä¹ˆä¹Ÿä¸ä¼šåš
                triggerAI(false);
            }

            if (isGameComplete()) {
                startConfetti();
                document.getElementById('goal-display').innerHTML = "ğŸ‰ å…¨éƒ¨å®Œæˆ";
            }
        }
    }

    function isGameComplete() {
        return state.every((v, i) => v === GOAL[i]);
    }

    function triggerAI(isReset) {
        // å¦‚æœ AI æœªæ¿€æ´»ï¼Œç›´æ¥æ¸…ç©ºè·¯å¾„å¹¶è¿”å›
        if (!isAIActive) {
            currentPath = [];
            displayPath([]);
            return;
        }

        if (isGameComplete()) {
            displayPath([]);
            updateLockedUI(state, document.getElementById('algo-select').value);
            return;
        }

        const algo = document.getElementById('algo-select').value;
        const listEl = document.getElementById('step-list');
        const goalEl = document.getElementById('goal-display');
        const mask = document.getElementById('loading-mask'); 
        
        mask.classList.add('active');

        if (currentPath.length === 0) {
            listEl.innerHTML = '<div class="empty-tip">AI æ€è€ƒä¸­...</div>';
        }

        isComputing = true;
        
        setTimeout(() => {
            let result = null;
            const startTime = Date.now();

            try {
                if (algo === 'regular') {
                    result = solveRegularSmart([...state]);
                } else if (algo === 'intermediate') {
                    result = solveIntermediate([...state]);
                } else {
                    const advancedPath = solveAdvanced([...state], startTime);
                    if (advancedPath) {
                        result = { path: advancedPath, goalName: "å…¨å±€æœ€ä¼˜" };
                    } else {
                        console.warn("IDA* timed out or failed, falling back to Intermediate.");
                        result = solveIntermediate([...state]);
                        result.goalName = "å¿«é€Ÿè§£æ³• (è¶…æ—¶é™çº§)";
                    }
                }
            } catch (e) {
                console.error("AI Error:", e);
                result = { path: [], goalName: "è®¡ç®—å‡ºé”™" };
            }

            if (result && result.goalName) {
                goalEl.innerHTML = `<span>ğŸ¯ ${result.goalName}</span>`;
            }

            if (result && result.path) {
                currentPath = result.path;
                displayPath(currentPath);
            } else {
                currentPath = [];
                listEl.innerHTML = '<div class="empty-tip">è¯·æ‰‹åŠ¨ç§»åŠ¨å‡ æ­¥</div>';
            }
            
            updateLockedUI(state, algo);
            renderBoard();
            
            mask.classList.remove('active');
            isComputing = false;
        }, 50);
    }
    
    function getLayerClass(val) {
        if (val >= 1 && val <= 4) return 'layer-1';
        if (val >= 5 && val <= 8) return 'layer-2';
        if (val >= 9 && val <= 12) return 'layer-3';
        if (val >= 13 && val <= 15) return 'layer-4';
        return '';
    }

    // --- ç®—æ³•éƒ¨åˆ†ä¿æŒä¸å˜ ---
    function solveRegularSmart(currState) {
        const isCorrect = (val, idx) => currState[idx] === val;
        
        if (!isCorrect(1, 0)) return { goalName: "ç›®æ ‡: 1", path: solveStage(currState, {1:0}, [])?.path };
        if (!isCorrect(2, 1)) return { goalName: "ç›®æ ‡: 2", path: solveStage(currState, {2:1}, [0])?.path };
        if (!isCorrect(3, 2)) return { goalName: "ç›®æ ‡: 3", path: solveStage(currState, {3:2}, [0, 1])?.path };
        if (!isCorrect(4, 3)) return { goalName: "ç›®æ ‡: 4", path: solveStage(currState, {3:2, 4:3}, [0, 1])?.path };

        const L1_Locks = [0, 1, 2, 3];
        if (!isCorrect(5, 4)) return { goalName: "ç›®æ ‡: 5", path: solveStage(currState, {5:4}, L1_Locks)?.path };
        if (!isCorrect(6, 5)) return { goalName: "ç›®æ ‡: 6", path: solveStage(currState, {6:5}, [...L1_Locks, 4])?.path };
        if (!isCorrect(7, 6)) return { goalName: "ç›®æ ‡: 7", path: solveStage(currState, {7:6}, [...L1_Locks, 4, 5])?.path };
        if (!isCorrect(8, 7)) return { goalName: "ç›®æ ‡: 8", path: solveStage(currState, {7:6, 8:7}, [...L1_Locks, 4, 5])?.path };

        const Bottom_Locks = [0, 1, 2, 3, 4, 5, 6, 7];
        const finalTargets = {};
        for(let v=9; v<=15; v++) finalTargets[v] = v-1;
        return { goalName: "æœ€åé˜¶æ®µ", path: solveStage(currState, finalTargets, Bottom_Locks)?.path };
    }

    function solveIntermediate(currState) {
        const isL1Done = [1,2,3,4].every(v => currState[v-1] === v);
        if (!isL1Done) {
             return { 
                 goalName: "ç›®æ ‡: ç¬¬ä¸€å±‚ (1-4)", 
                 path: solveStage(currState, {1:0, 2:1, 3:2, 4:3}, [])?.path 
             };
        }

        const isL2Done = [5,6,7,8].every(v => currState[v-1] === v);
        const L1_Locks = [0, 1, 2, 3];
        if (!isL2Done) {
             return { 
                 goalName: "ç›®æ ‡: ç¬¬äºŒå±‚ (5-8)", 
                 path: solveStage(currState, {5:4, 6:5, 7:6, 8:7}, L1_Locks)?.path 
             };
        }

        const Bottom_Locks = [0, 1, 2, 3, 4, 5, 6, 7];
        const finalTargets = {};
        for(let v=9; v<=15; v++) finalTargets[v] = v-1;
        
        return { 
            goalName: "ç›®æ ‡: å‰©ä½™å…¨éƒ¨", 
            path: solveStage(currState, finalTargets, Bottom_Locks)?.path 
        };
    }

    function solveAdvanced(startState, startTime) {
        lockedIndices = []; 
        let limit = getGlobalHeuristicEnhanced(startState);
        const path = [];
        const MAX_TIME = 15000; 

        while(true) {
            if (Date.now() - startTime > MAX_TIME) return null;

            const res = dfs(startState, 0, limit, -1, path, startTime, MAX_TIME);
            if (res === "FOUND") return path;
            if (res === Infinity) return null;
            limit = res;
            
            if (limit > 70) return null;
        }
    }

    function dfs(curr, g, limit, lastMove, path, startTime, maxTime) {
        const h = getGlobalHeuristicEnhanced(curr);
        const f = g + h;
        if (f > limit) return f;
        if (h === 0) return "FOUND";

        if (g < 5 && (Date.now() - startTime > maxTime)) return Infinity;

        let min = Infinity;
        const emptyIdx = curr.indexOf(0);
        
        const neighbors = NEIGHBOR_MAP[emptyIdx]; 
        
        for (let i = 0; i < neighbors.length; i++) {
            const nIdx = neighbors[i];
            const val = curr[nIdx];
            
            if (val === lastMove) continue; 

            curr[emptyIdx] = val;
            curr[nIdx] = 0;
            path.push(val);

            const t = dfs(curr, g + 1, limit, val, path, startTime, maxTime);
            
            if (t === "FOUND") return "FOUND";
            if (t < min) min = t;

            path.pop();
            curr[nIdx] = val;
            curr[emptyIdx] = 0;
            
            if (min === Infinity && (Date.now() - startTime > maxTime)) return Infinity;
        }
        return min;
    }

    function getGlobalHeuristicEnhanced(arr) {
        let h = 0;
        let conflict = 0;
        const size = 4;

        for (let i = 0; i < 16; i++) {
            let val = arr[i];
            if (val === 0) continue;
            let targetIdx = val - 1;
            
            let rCurr = (i >> 2); 
            let cCurr = (i & 3); 
            let rTarg = (targetIdx >> 2);
            let cTarg = (targetIdx & 3);
            
            h += Math.abs(rCurr - rTarg) + Math.abs(cCurr - cTarg);

            if (rCurr === rTarg) {
                for (let k = cCurr + 1; k < 4; k++) {
                    let otherVal = arr[rCurr * 4 + k];
                    if (otherVal === 0) continue;
                    let otherTarget = otherVal - 1;
                    let rOtherTarg = (otherTarget >> 2);
                    
                    if (rOtherTarg === rCurr && (otherTarget & 3) < cTarg) {
                        conflict += 2;
                    }
                }
            }
        }
        return h + conflict;
    }

    function solveStage(startState, targetGoals, fixedIndices) {
        let heap = new MinHeap();
        let startH = getStageHeuristic(startState, targetGoals);
        
        heap.push({
            state: [...startState],
            g: 0,
            h: startH,
            f: 0 + startH,
            path: [],
            emptyIdx: startState.indexOf(0)
        });
        
        let closedSet = new Set();
        let fixedSet = new Set(fixedIndices);
        
        let maxIter = 200000; 

        while (heap.size() > 0 && maxIter-- > 0) {
            let current = heap.pop(); 

            let stateStr = current.state.join(',');
            if (closedSet.has(stateStr)) continue;
            closedSet.add(stateStr);

            if (current.h === 0) {
                return { path: current.path, state: current.state };
            }

            const neighbors = NEIGHBOR_MAP[current.emptyIdx];
            
            for (let i = 0; i < neighbors.length; i++) {
                let nIdx = neighbors[i];
                if (fixedSet.has(nIdx)) continue; 

                let newState = [...current.state];
                let moveVal = newState[nIdx];
                
                newState[current.emptyIdx] = moveVal;
                newState[nIdx] = 0;

                if (!closedSet.has(newState.join(','))) {
                    let h = getStageHeuristic(newState, targetGoals);
                    let newG = current.g + 1;
                    heap.push({
                        state: newState,
                        g: newG,
                        h: h,
                        f: newG + h,
                        path: [...current.path, moveVal],
                        emptyIdx: nIdx
                    });
                }
            }
        }
        return null; 
    }

    function getStageHeuristic(arr, targets) {
        let h = 0;
        let conflict = 0;
        
        for (let tileStr in targets) {
            let tile = parseInt(tileStr);
            let currIdx = arr.indexOf(tile);
            if (currIdx === -1) continue;
            let targetIdx = targets[tile];
            
            let r1 = (currIdx >> 2), c1 = (currIdx & 3);
            let r2 = (targetIdx >> 2), c2 = (targetIdx & 3);
            
            h += Math.abs(r1 - r2) + Math.abs(c1 - c2);
        }

        const rowGroups = {};
        for (let tileStr in targets) {
            let tile = parseInt(tileStr);
            let targetIdx = targets[tile];
            let tRow = Math.floor(targetIdx / 4);
            if (!rowGroups[tRow]) rowGroups[tRow] = [];
            rowGroups[tRow].push({tile: tile, tCol: targetIdx % 4});
        }

        for (let r in rowGroups) {
            let tRow = parseInt(r);
            let group = rowGroups[tRow];
            let inRowTiles = [];
            for (let c = 0; c < 4; c++) {
                let val = arr[tRow * 4 + c];
                let targetInfo = group.find(g => g.tile === val);
                if (targetInfo) inRowTiles.push({ val: val, currCol: c, tCol: targetInfo.tCol });
            }
            for (let i = 0; i < inRowTiles.length; i++) {
                for (let j = i + 1; j < inRowTiles.length; j++) {
                    let t1 = inRowTiles[i];
                    let t2 = inRowTiles[j];
                    if (t1.tCol > t2.tCol) conflict += 2;
                }
            }
        }
        
        return (h + conflict) * 3;
    }

    function displayPath(path) {
        const listEl = document.getElementById('step-list');
        listEl.innerHTML = '';
        
        document.querySelectorAll('.tile').forEach(t => t.classList.remove('hint'));

        if (!path || path.length === 0) {
            if (isGameComplete()) listEl.innerHTML = '<div class="empty-tip" style="color:green;">ğŸ‰ æ­å–œï¼å·²å®Œæˆï¼</div>';
            return;
        }

        path.forEach((val, i) => {
            const item = document.createElement('div');
            item.className = `step-item ${getLayerClass(val)} ${i === 0 ? 'active' : ''}`;
            item.innerText = val;
            listEl.appendChild(item);
            
            if (i === 0) {
                const tile = document.getElementById(`tile-${val}`);
                if (tile) tile.classList.add('hint');
            }
        });
        
        listEl.scrollLeft = 0;
    }

    function renderBoard() {
        const board = document.getElementById('board');
        board.innerHTML = '';
        state.forEach((val, idx) => {
            if (val === 0) return;
            const tile = document.createElement('div');
            
            tile.className = `tile ${getLayerClass(val)}`;
            if (lockedIndices.includes(idx)) tile.classList.add('locked');
            
            tile.id = `tile-${val}`;
            tile.innerText = val;
            tile.style.top = `calc(${Math.floor(idx / 4) * 25}% + 5px)`;
            tile.style.left = `calc(${(idx % 4) * 25}% + 5px)`;
            tile.onclick = () => handleMove(idx);
            board.appendChild(tile);
        });
        
        // åªæœ‰å½“ AI æ¿€æ´»æ—¶ï¼Œæ‰åœ¨æ¸²æŸ“æ—¶æ˜¾ç¤ºæç¤º
        if (isAIActive && currentPath.length > 0) {
             const nextVal = currentPath[0];
             const tile = document.getElementById(`tile-${nextVal}`);
             if (tile) tile.classList.add('hint');
        }
    }

    function updateLockedUI(currentState, algoType) {
        lockedIndices = [];
        if (typeof currentState === 'string') { algoType = currentState; currentState = state; }
        if (algoType === 'advanced') return;

        const isCorrect = (v) => currentState[v-1] === v;
        
        if (algoType === 'intermediate') {
            const L1 = [1,2,3,4].every(v => isCorrect(v));
            if (L1) lockedIndices.push(0,1,2,3);
            
            if (L1) {
                const L2 = [5,6,7,8].every(v => isCorrect(v));
                if (L2) lockedIndices.push(4,5,6,7);
            }
            return;
        }

        if (isCorrect(1)) lockedIndices.push(0);
        if (isCorrect(1) && isCorrect(2)) lockedIndices.push(1);
        if (isCorrect(1) && isCorrect(2) && isCorrect(3) && isCorrect(4)) lockedIndices.push(2, 3);
        
        if (isCorrect(1) && isCorrect(2) && isCorrect(3) && isCorrect(4)) {
            if (isCorrect(5)) lockedIndices.push(4);
            if (isCorrect(5) && isCorrect(6)) lockedIndices.push(5);
            if (isCorrect(5) && isCorrect(6) && isCorrect(7) && isCorrect(8)) lockedIndices.push(6, 7);
        }
    }

    function updateUI() {
        document.getElementById('status').innerText = `${moves}`;
        const algo = document.getElementById('algo-select').value;
        updateLockedUI(state, algo);
    }

    const canvas = document.getElementById("confetti-canvas");
    const ctx = canvas.getContext("2d");
    let particles = [];
    let animationId = null;

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    const colors = ['#ff8a80', '#4fc3f7', '#aed581', '#ce93d8', '#ffb74d'];

    class Particle {
        constructor() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height - canvas.height;
            this.size = Math.random() * 15 + 10;
            this.speedX = Math.random() * 4 - 2;
            this.speedY = Math.random() * 5 + 3;
            this.color = colors[Math.floor(Math.random() * colors.length)];
            this.rotation = Math.random() * 360;
            this.rotationSpeed = Math.random() * 10 - 5;
            this.opacity = Math.random() * 0.5 + 0.5;
        }

        update() {
            this.y += this.speedY;
            this.x += this.speedX + Math.sin(this.y * 0.01); 
            this.rotation += this.rotationSpeed;
            if (this.y > canvas.height) {
                this.y = -50;
                this.x = Math.random() * canvas.width;
            }
        }

        draw() {
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(this.rotation * Math.PI / 180);
            ctx.fillStyle = this.color;
            ctx.globalAlpha = this.opacity;
            ctx.fillRect(-this.size / 2, -this.size / 2, this.size, this.size * 0.6);
            ctx.restore();
        }
    }

    function startConfetti() {
        if (animationId) return; 
        particles = [];
        for (let i = 0; i < 150; i++) {
            particles.push(new Particle());
        }
        animateConfetti();
    }

    function stopConfetti() {
        if (animationId) {
            cancelAnimationFrame(animationId);
            animationId = null;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
    }

    // --- éšè—åŠŸèƒ½ï¼šå…¨å±åˆ‡æ¢ ---
    function toggleFullScreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                console.warn(`å…¨å±æ¨¡å¼å¯åŠ¨å¤±è´¥: ${err.message}`);
            });
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    }

    function animateConfetti() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach(p => {
            p.update();
            p.draw();
        });
        animationId = requestAnimationFrame(animateConfetti);
    }

    window.onload = initGame;
</script>

</body>
</html>