<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>剪长方形</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f5f5f5;
        }
        
        .container {
            height: 100vh;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .control-area {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem 2rem 0.5rem;
            border-radius: 1rem 1rem 0 0;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 10;
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        
        .reset-btn-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 10;
        }
        
        .cut-btn-container {
            border-radius: 15px;
            background: #fff;
            position: absolute;
            z-index: 15;
            display: none;
            pointer-events: auto;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            font-size: 1.1rem;
            font-weight: 500;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        #cut-btn{background: transparent;}
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-secondary {
            background: #e5e7eb;
            color: #1f2937;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            gap: 0px;
            width: min(70vh, 70vw);
            height: min(70vh, 70vw);
            background: #e5e7eb;
            position: relative;
            border: 1px solid #999;
        }
        
        .grid-container {
            position: relative;
        }
        
        .grid-cell {
            background: white;
            border: 1px solid #999;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            user-select: none;
        }

        .grid-cell.selected {
            background: #3b82f6;
            border-color: #1d4ed8;
        }
        
        .grid-cell.preview {
            background: rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
        }
        
        .grid-cell.cut {
            background: #fff;
            border-color: #fff;
        }
        
        /* 裁剪区域的外边框样式 */
        .cut-group {
            position: relative;
        }
        
        .cut-group::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: 0px;
            bottom: 0px;
            border: 2px solid #000;
            pointer-events: none;
            z-index: 10;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .status-text {
            position: fixed;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(59, 130, 246, 0.9);
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            font-size: 1.25rem;
            font-weight: 500;
            z-index: 20;
            transition: all 0.3s;
        }
        
        .status-text.success {
            background: rgba(34, 197, 94, 0.9);
        }
        
        .status-text.warning {
            background: rgba(245, 158, 11, 0.9);
        }
        
        .status-text.error {
            background: rgba(239, 68, 68, 0.9);
        }
        
        .instruction {
            text-align: center;
            color: #6b7280;
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }
        
        @media (max-width: 768px) {
            .grid {
                width: 90vw;
                height: 90vw;
            }
            
            .grid-container {
                padding: 1rem;
                margin: 1rem;
            }
            
            .control-area {
                padding: 0.5rem 1rem;
                gap: 1rem;
            }
            
            .btn {
                padding: 0.5rem 1rem;
                font-size: 1rem;
            }
            
            .status-text {
                font-size: 1rem;
                padding: 0.75rem 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        
        <div class="grid-container">
            <div class="grid" id="grid">
                <!-- 9x9网格将通过JavaScript生成 -->
            </div>
            <div class="cut-btn-container" id="cut-btn-container">
                <button id="cut-btn" class="btn">剪下</button>
            </div>
        </div>
        
        <div class="reset-btn-container">
            <button id="reset-btn" class="btn btn-danger">重来</button>
        </div>
        
        <div id="status-text" class="status-text" style="display: none;">
            请在网格上拖拽选择区域
        </div>
    </div>
    
    <script>
    class GridDrawingBoard {
        constructor() {
            this.gridSize = 9;
            this.grid = document.getElementById('grid');
            this.cells = [];
            this.selectedCells = [];
            this.cutCells = [];
            this.isSelecting = false;
            this.startCell = null;
            this.currentSelection = [];
            
            // 按钮元素
            this.cutBtn = document.getElementById('cut-btn');
            this.cutBtnContainer = document.getElementById('cut-btn-container');
            this.resetBtn = document.getElementById('reset-btn');
            this.statusText = document.getElementById('status-text');
            
            this.init();
        }
        
        init() {
            this.createGrid();
            this.bindEvents();
            this.showStatus('剪长5厘米、宽2厘米的长方形', 'info');
        }
        
        createGrid() {
            this.grid.innerHTML = '';
            this.cells = [];
            
            for (let i = 0; i < this.gridSize * this.gridSize; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.dataset.index = i;
                cell.dataset.row = Math.floor(i / this.gridSize);
                cell.dataset.col = i % this.gridSize;
                
                this.grid.appendChild(cell);
                this.cells.push(cell);
            }
        }
        
        bindEvents() {
            // 鼠标事件
            this.grid.addEventListener('mousedown', (e) => this.startSelection(e));
            this.grid.addEventListener('mousemove', (e) => this.updateSelection(e));
            this.grid.addEventListener('mouseup', () => this.endSelection());
            this.grid.addEventListener('mouseleave', () => this.endSelection());
            
            // 触摸事件
            this.grid.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const element = document.elementFromPoint(touch.clientX, touch.clientY);
                if (element && element.classList.contains('grid-cell')) {
                    this.startSelection({target: element});
                }
            });
            
            this.grid.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const element = document.elementFromPoint(touch.clientX, touch.clientY);
                if (element && element.classList.contains('grid-cell')) {
                    this.updateSelection({target: element});
                }
            });
            
            this.grid.addEventListener('touchend', (e) => {
                e.preventDefault();
                this.endSelection();
            });
            
            // 按钮事件
            this.cutBtn.addEventListener('click', () => this.cutSelection());
            this.resetBtn.addEventListener('click', () => this.resetGrid());
            
            // 防止右键菜单
            this.grid.addEventListener('contextmenu', (e) => e.preventDefault());
        }
        
        startSelection(e) {
            if (!e.target.classList.contains('grid-cell')) return;
            
            this.isSelecting = true;
            this.startCell = e.target;
            this.clearSelection();
            this.clearPreview();
            
            // 添加选中样式
            e.target.classList.add('selected');
            this.currentSelection = [e.target];
        }
        
        updateSelection(e) {
            if (!this.isSelecting || !this.startCell || !e.target.classList.contains('grid-cell')) return;
            
            const startRow = parseInt(this.startCell.dataset.row);
            const startCol = parseInt(this.startCell.dataset.col);
            const endRow = parseInt(e.target.dataset.row);
            const endCol = parseInt(e.target.dataset.col);
            
            // 计算选择区域
            const minRow = Math.min(startRow, endRow);
            const maxRow = Math.max(startRow, endRow);
            const minCol = Math.min(startCol, endCol);
            const maxCol = Math.max(startCol, endCol);
            
            const width = maxCol - minCol + 1;
            const height = maxRow - minRow + 1;
            
            // 清除之前的选择
            this.clearSelection();
            this.clearPreview();
            
            // 检查是否为有效的5x2或2x5区域
            const isValid = (width === 5 && height === 2) || (width === 2 && height === 5);
            
            // 选择区域内的所有单元格
            this.currentSelection = [];
            for (let row = minRow; row <= maxRow; row++) {
                for (let col = minCol; col <= maxCol; col++) {
                    const index = row * this.gridSize + col;
                    if (index < this.cells.length) {
                        const cell = this.cells[index];
                        if (isValid) {
                            cell.classList.add('selected');
                        } else {
                            cell.classList.add('preview');
                        }
                        this.currentSelection.push(cell);
                    }
                }
            }
            
            // 更新状态文本
            if (isValid) {
                this.showStatus(`已选择${width}x${height}区域，可以裁剪`, 'success');
            } else {
                this.showStatus(`当前选择${width}x${height}，请选择5x2或2x5区域`, 'warning');
            }
        }
        
        endSelection() {
            if (!this.isSelecting) return;
            
            this.isSelecting = false;
            
            // 检查选择是否有效
            const validSelection = this.currentSelection.every(cell => 
                cell.classList.contains('selected')
            );
            
            if (validSelection && this.currentSelection.length > 0) {
                this.selectedCells = [...this.currentSelection];
                this.showCutButton();
                this.showStatus('选择完成，点击裁剪按钮进行裁剪', 'success');
            } else {
                this.clearSelection();
                this.clearPreview();
                this.hideCutButton();
                this.showStatus('请选择5x2或2x5区域', 'warning');
            }
            
            this.startCell = null;
            this.currentSelection = [];
        }
        
        cutSelection() {
            if (this.selectedCells.length === 0) return;
            
            // 将选中的单元格标记为已裁剪
            this.cutCells = [...this.selectedCells];
            
            // 计算裁剪区域的边界
            const rows = this.cutCells.map(cell => parseInt(cell.dataset.row));
            const cols = this.cutCells.map(cell => parseInt(cell.dataset.col));
            const minRow = Math.min(...rows);
            const maxRow = Math.max(...rows);
            const minCol = Math.min(...cols);
            const maxCol = Math.max(...cols);
            
            // 创建包装元素来显示统一边框
            const wrapper = document.createElement('div');
            wrapper.className = 'cut-group';
            wrapper.style.position = 'absolute';
            wrapper.style.pointerEvents = 'none';
            
            // 计算包装元素的位置和大小
            const firstCell = this.cells[minRow * this.gridSize + minCol];
            const lastCell = this.cells[maxRow * this.gridSize + maxCol];
            const firstRect = firstCell.getBoundingClientRect();
            const lastRect = lastCell.getBoundingClientRect();
            const gridRect = this.grid.getBoundingClientRect();
            
            wrapper.style.left = (firstRect.left - gridRect.left) + 'px';
            wrapper.style.top = (firstRect.top - gridRect.top) + 'px';
            wrapper.style.width = (lastRect.right - firstRect.left) + 'px';
            wrapper.style.height = (lastRect.bottom - firstRect.top) + 'px';
            
            this.grid.appendChild(wrapper);
            this.cutWrapper = wrapper;
            
            this.cutCells.forEach(cell => {
                cell.classList.remove('selected');
                cell.classList.add('cut');
            });
            
            this.selectedCells = [];
            this.hideCutButton();
            
            this.showStatus('裁剪完成！', 'success');
        }
        
        pasteCells(targetRow, targetCol, width, height) {
            // 清除裁剪标记和包装元素
            this.cutCells.forEach(cell => {
                cell.classList.remove('cut');
            });
            
            if (this.cutWrapper) {
                this.cutWrapper.remove();
                this.cutWrapper = null;
            }
            
            // 在新位置添加选中标记
            for (let row = 0; row < height; row++) {
                for (let col = 0; col < width; col++) {
                    const newRow = targetRow + row;
                    const newCol = targetCol + col;
                    const index = newRow * this.gridSize + newCol;
                    
                    if (index < this.cells.length) {
                        this.cells[index].classList.add('selected');
                    }
                }
            }
            
            // 重置状态
            this.cutCells = [];
            
            // 3秒后清除选中状态
            setTimeout(() => {
                this.clearSelection();
                this.showStatus('剪长5厘米、宽2厘米的长方形', 'info');
            }, 3000);
        }
        
        resetGrid() {
            // 完全重新创建网格，确保恢复到最原始状态
            this.createGrid();
            
            // 清除所有状态变量
            this.selectedCells = [];
            this.cutCells = [];
            this.currentSelection = [];
            this.isSelecting = false;
            this.startCell = null;
            
            // 清除包装元素
            if (this.cutWrapper) {
                this.cutWrapper.remove();
                this.cutWrapper = null;
            }
            
            // 清除所有可能存在的cut-group元素
            const cutGroups = this.grid.querySelectorAll('.cut-group');
            cutGroups.forEach(group => group.remove());
            
            // 重置按钮状态
            this.hideCutButton();
            
            // 显示初始状态消息
            this.showStatus('剪长5厘米、宽2厘米的长方形', 'info');
        }
        
        clearSelection() {
            this.cells.forEach(cell => cell.classList.remove('selected'));
        }
        
        clearPreview() {
            this.cells.forEach(cell => cell.classList.remove('preview'));
        }
        
        showCutButton() {
            if (this.selectedCells.length === 0) return;
            
            // 计算选中区域的边界
            const rows = this.selectedCells.map(cell => parseInt(cell.dataset.row));
            const cols = this.selectedCells.map(cell => parseInt(cell.dataset.col));
            const minRow = Math.min(...rows);
            const maxRow = Math.max(...rows);
            const minCol = Math.min(...cols);
            const maxCol = Math.max(...cols);
            
            // 计算选中区域的中心位置
            const centerRow = (minRow + maxRow) / 2;
            const centerCol = (minCol + maxCol) / 2;
            
            // 获取选中区域的实际像素位置
            const firstCell = this.cells[minRow * this.gridSize + minCol];
            const lastCell = this.cells[maxRow * this.gridSize + maxCol];
            
            // 获取网格容器的位置信息
            const gridContainer = document.querySelector('.grid-container');
            const containerRect = gridContainer.getBoundingClientRect();
            const firstCellRect = firstCell.getBoundingClientRect();
            const lastCellRect = lastCell.getBoundingClientRect();
            
            // 计算选中区域的中心点（像素位置）
            const centerX = (firstCellRect.left + lastCellRect.right) / 2;
            const centerY = (firstCellRect.top + lastCellRect.bottom) / 2;
            
            // 计算按钮位置（相对于grid-container，显示在选中区域中心）
            const left = centerX - containerRect.left - 40; // 40是按钮宽度的一半
            const top = centerY - containerRect.top - 20; // 20是按钮高度的一半
            
            // 确保按钮不会超出容器边界
            const adjustedLeft = Math.max(10, Math.min(left, containerRect.width - 90));
            const adjustedTop = Math.max(10, Math.min(top, containerRect.height - 50));
            
            this.cutBtnContainer.style.left = adjustedLeft + 'px';
            this.cutBtnContainer.style.top = adjustedTop + 'px';
            this.cutBtnContainer.style.display = 'block';
        }
        
        hideCutButton() {
            this.cutBtnContainer.style.display = 'none';
        }
        
        showStatus(message, type = 'info') {
            this.statusText.textContent = message;
            this.statusText.className = `status-text ${type}`;
            this.statusText.style.display = 'block';
            
            // 5秒后自动隐藏（除非是持续性消息）
            if (type !== 'info') {
                setTimeout(() => {
                    if (this.statusText.textContent === message) {
                        this.statusText.style.display = 'none';
                    }
                }, 5000);
            }
        }
    }
    
    // 初始化应用
    document.addEventListener('DOMContentLoaded', () => {
        new GridDrawingBoard();
    });
    </script>
</body>
</html>