<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¹å®«æ ¼æ•°å­¦æ¢é™©</title>
    <style>
        /* --- åŸºç¡€è®¾ç½® --- */
        :root {
            /* é¢œè‰²å˜é‡ (æå–è‡ª Tailwind) */
            --emerald-50: #ecfdf5;
            --emerald-100: #d1fae5;
            --emerald-200: #a7f3d0;
            --emerald-500: #10b981;
            --emerald-600: #059669;
            --emerald-700: #047857;
            --emerald-800: #065f46;

            --blue-50: #eff6ff;
            --blue-100: #dbeafe;
            --blue-200: #bfdbfe;
            --blue-700: #1d4ed8;
            --blue-800: #1e40af;

            --orange-50: #fff7ed;
            --orange-200: #fed7aa;
            --orange-800: #9a3412;

            --purple-100: #f3e8ff;
            --purple-200: #e9d5ff;
            --purple-700: #7e22ce;

            --red-200: #fecaca;
            --red-500: #ef4444;
            --red-600: #dc2626;

            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-600: #4b5563;

            --yellow-200: #fde047;
            /* è¿‘ä¼¼ */
            --yellow-800: #854d0e;

            --white: #ffffff;
            --black: #000000;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #EEF2FF;
            margin: 0;
            padding: 0;
            user-select: none;
            touch-action: manipulation;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* å®‰å…¨åŒºåŸŸ */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* --- é€šç”¨å·¥å…·ç±» (æ›¿ä»£ Tailwind) --- */
        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-center {
            justify-content: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-3 {
            gap: 0.75rem;
        }

        .w-full {
            width: 100%;
        }

        .h-full {
            height: 100%;
        }

        .relative {
            position: relative;
        }

        .absolute {
            position: absolute;
        }

        .inset-0 {
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }

        .hidden {
            display: none !important;
        }

        .shadow-sm {
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .shadow-inner {
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }

        .rounded-full {
            border-radius: 9999px;
        }

        .rounded-xl {
            border-radius: 0.75rem;
        }

        .rounded-2xl {
            border-radius: 1rem;
        }

        .rounded-3xl {
            border-radius: 1.5rem;
        }

        .border {
            border-width: 1px;
            border-style: solid;
        }

        .border-2 {
            border-width: 2px;
            border-style: solid;
        }

        .border-4 {
            border-width: 4px;
            border-style: solid;
        }

        .transition {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }

        .active-scale:active {
            transform: scale(0.95);
        }

        .cursor-pointer {
            cursor: pointer;
        }

        .select-none {
            user-select: none;
        }

        .pointer-events-none {
            pointer-events: none;
        }

        /* --- å…·ä½“ç»„ä»¶æ ·å¼ --- */

        /* é¡¶éƒ¨ Header */
        header {
            background-color: var(--white);
            z-index: 20;
            padding-top: 0.75rem;
            padding-bottom: 1rem;
            padding-left: 1rem;
            padding-right: 1rem;
            flex-shrink: 0;
        }

        .header-top-row {
            max-width: 56rem;
            /* max-w-4xl */
            padding: 0 0.25rem;
            margin-bottom: 0.75rem;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--emerald-800);
            letter-spacing: 0.025em;
            margin: 0;
        }

        @media (min-width: 640px) {
            h1 {
                font-size: 1.875rem;
            }
        }

        h1:hover {
            opacity: 0.7;
        }

        /* é­”æ³•æŒ‰é’® */
        #toggle-mode-btn {
            width: 2.5rem;
            height: 2.5rem;
            background-color: var(--purple-100);
            color: var(--purple-700);
            border: 1px solid var(--purple-200);
            font-size: 1.25rem;
            padding: 0;
            cursor: pointer;
        }

        #toggle-mode-btn:hover {
            background-color: var(--purple-200);
        }

        /* æç¤ºæ–‡å­— */
        #instruction-text {
            color: var(--emerald-700);
            font-size: 0.75rem;
            font-weight: 700;
            text-align: right;
            max-width: 120px;
            line-height: 1.25;
            transition: opacity 300ms;
            margin: 0;
        }

        @media (min-width: 640px) {
            #instruction-text {
                font-size: 0.875rem;
                max-width: none;
            }
        }

        .opacity-0 {
            opacity: 0;
        }

        /* æç¤ºæŒ‰é’® */
        .hint-btn {
            font-size: 1rem;
            font-weight: 700;
            background-color: var(--blue-100);
            color: var(--blue-700);
            padding: 0.5rem 1rem;
            border: 1px solid var(--blue-200);
            white-space: nowrap;
            cursor: pointer;
        }

        .hint-btn:active {
            background-color: var(--blue-200);
        }

        /* æ•°å­—ä»“åº“ */
        .number-bank-container {
            width: 100%;
            max-width: 56rem;
            background-color: var(--gray-50);
            padding: 0.75rem;
            border: 1px solid var(--gray-100);
            min-height: 6rem;
        }

        #number-bank {
            flex-wrap: wrap;
        }

        /* æ•°å­—å¡ç‰‡ */
        .number-card {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border-bottom-width: 4px;
            border-style: solid;
            width: 3.5rem;
            height: 3rem;
            font-size: 1.5rem;
            border-radius: 0.75rem;
            transition: all 0.2s;
        }

        @media (min-width: 640px) {
            .number-card {
                width: 5rem;
                height: 4rem;
                font-size: 1.875rem;
            }
        }

        /* å¶æ•°å¡ç‰‡æ ·å¼ */
        .card-even {
            background-color: var(--blue-50);
            color: var(--blue-800);
            border-color: var(--blue-200);
        }

        /* å¥‡æ•°å¡ç‰‡æ ·å¼ */
        .card-odd {
            background-color: var(--orange-50);
            color: var(--orange-800);
            border-color: var(--orange-200);
        }

        .number-card.selected {
            transform: scale(1.1) translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border: 3px solid #F59E0B;
            /* Amber-500 */
            background-color: #FFFBEB;
            /* Amber-50 */
            z-index: 50;
        }

        .number-card:active {
            transform: scale(0.95);
        }


        /* ä¸»æ¸¸æˆåŒº */
        main {
            background-color: rgba(236, 253, 245, 0.5);
            /* emerald-50/50 */
            /* ç¡®ä¿ main å æ®å‰©ä½™é«˜åº¦ */
            flex: 1;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem 5rem;
            position: relative;
            overflow: hidden;
        }

        .game-container {
            position: relative;
            aspect-ratio: 1 / 1;
            /* é»˜è®¤é…ç½®ï¼šå®½åº¦ä¼˜å…ˆï¼ˆç«–å±æ¨¡å¼é€»è¾‘ï¼‰ï¼Œä½†é™åˆ¶æœ€å¤§é«˜åº¦ä¸è¶…è¿‡çˆ¶å®¹å™¨ */
            width: 100%;
            height: auto;
            max-height: 100%;
        }

        /* æ¨ªå±æ¨¡å¼ä¼˜åŒ–ï¼šé«˜åº¦ä¼˜å…ˆ */
        @media (orientation: landscape) {
            .game-container {
                height: 100%;
                width: auto;
                max-width: 100%;
            }
        }

        /* ä¿æŒæ­£æ–¹å½¢ (å†—ä½™ç±»ä¿ç•™ä»¥é˜²ä¸‡ä¸€) */
        .aspect-square {
            aspect-ratio: 1 / 1;
        }

        .bg-deco-1 {
            background-color: var(--emerald-200);
            transform: rotate(1deg);
        }

        .bg-deco-2 {
            background-color: var(--emerald-100);
            transform: rotate(-1deg);
        }

        /* ç½‘æ ¼ */
        .grid-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 0.75rem;
            padding: 1rem;
            z-index: 10;
        }

        /* æ ¼å­ Cell */
        .cell {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 1rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            /* å“åº”å¼å­—ä½“ */
            font-size: clamp(2rem, 7vw, 4rem);
        }

        /* ç©ºæ ¼å­æ ·å¼ */
        .cell-empty {
            background-color: rgba(236, 253, 245, 0.6);
            color: var(--gray-300);
            border: 4px dashed rgba(167, 243, 208, 0.7);
        }

        .cell-empty:hover {
            border-color: var(--emerald-500);
            /* ç¨å¾®æ·±ä¸€ç‚¹çš„ç»¿ */
            background-color: var(--white);
        }

        /* å·²å¡«å…¥æ ¼å­æ ·å¼ */
        .cell-filled {
            background-color: var(--white);
            border: 2px solid transparent;
        }

        .cell-filled:hover {
            border-color: var(--red-200);
        }

        /* å¾…å¡«å…¥é«˜äº®æ ·å¼ */
        .cell-waiting {
            background-color: var(--blue-100);
            border: 4px solid var(--blue-800);
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* æ–‡æœ¬é¢œè‰² */
        .text-blue-800 {
            color: var(--blue-800);
        }

        .text-orange-800 {
            color: var(--orange-800);
        }

        /* æ°”æ³¡è¦†ç›–å±‚ */
        .bubble-overlay {
            display: grid;
            gap: 0.75rem;
            padding: 1rem;
            z-index: 20;
            pointer-events: none;
        }

        .grid-cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .grid-rows-3 {
            grid-template-rows: repeat(3, 1fr);
        }

        .bubble {
            position: absolute;
            min-width: 2.5rem;
            height: 2.5rem;
            padding: 0 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 700;
            border-width: 2px;
            border-style: solid;
            z-index: 30;
        }

        @media (min-width: 640px) {
            .bubble {
                font-size: 1rem;
            }
        }

        /* æ°”æ³¡å®šä½ */
        .pos-col {
            left: 50%;
            transform: translateX(-50%);
            bottom: -1.25rem;
        }

        @media (min-width: 640px) {
            .pos-col {
                bottom: -4rem;
            }
        }

        .pos-row {
            top: 50%;
            transform: translateY(-50%);
            right: -1.25rem;
        }

        @media (min-width: 640px) {
            .pos-row {
                right: -5rem;
            }
        }

        /* æ°”æ³¡çŠ¶æ€ */
        .bubble-correct {
            background-color: var(--emerald-500);
            color: var(--white);
            border-color: var(--emerald-600);
        }

        .bubble-wrong {
            background-color: var(--red-500);
            color: var(--white);
            border-color: var(--red-600);
            animation: bounce 1s infinite;
        }

        /* å¼¹çª— */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: var(--white);
            border-radius: 2rem;
            padding: 2rem;
            max-width: 24rem;
            width: 100%;
            text-align: center;
            border: 4px solid var(--emerald-100);
        }

        .btn-primary {
            background-color: var(--emerald-500);
            color: var(--white);
            padding: 1rem 2rem;
            border-radius: 1rem;
            font-weight: 700;
            font-size: 1.25rem;
            border: none;
            width: 100%;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.1s;
        }

        .btn-primary:active {
            transform: scale(0.95);
        }

        .btn-primary:hover {
            background-color: var(--emerald-600);
        }

        /* åŠ¨ç”»å…³é”®å¸§ */
        @keyframes bubblePop {
            0% {
                transform: scale(0);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes popIn {
            0% {
                transform: scale(0);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes celebrate {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2) rotate(5deg);
            }

            100% {
                transform: scale(1) rotate(0);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: .5;
            }
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(-25%);
                animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
            }

            50% {
                transform: none;
                animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
            }
        }

        /* ç‰¹æ®Šä¿®æ­£ï¼šæ°”æ³¡ Bounce æ—¶éœ€è¦ç»“åˆè‡ªèº«çš„å®šä½ translateï¼Œæ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œç®€åŒ– bounce ä»…ä¸Šä¸‹æµ®åŠ¨ */
        /* ç”±äº bubble å·²ç»æœ‰ transformï¼ŒåŠ¨ç”»ä¼šè¦†ç›–å®ƒã€‚
           ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬é‡æ–°å®šä¹‰ä¸€ä¸ªä¸“é—¨ç»™æ°”æ³¡ç”¨çš„ bounce-col å’Œ bounce-row åŠ¨ç”» */
        @keyframes bounce-col {

            0%,
            100% {
                transform: translateX(-50%) translateY(0);
            }

            50% {
                transform: translateX(-50%) translateY(-25%);
            }
        }

        @keyframes bounce-row {

            0%,
            100% {
                transform: translateY(-50%) translateX(0);
            }

            50% {
                transform: translateY(-50%) translateX(-25%);
            }
        }

        /* é‡æ–°åº”ç”¨ bounce åŠ¨ç”» */
        .pos-col.bubble-wrong {
            animation: bounce-col 1s infinite;
        }

        .pos-row.bubble-wrong {
            animation: bounce-row 1s infinite;
        }


        .pop-in {
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .bubble-pop {
            animation: bubblePop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .celebration {
            animation: celebrate 0.5s ease-in-out infinite;
        }

        .animate-bounce {
            animation: bounce 1s infinite;
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>

<body>

    <!-- é¡¶éƒ¨åŒºåŸŸ -->
    <header class="flex flex-col items-center w-full shadow-sm">

        <!-- æ ‡é¢˜è¡Œ -->
        <div class="header-top-row flex justify-between items-center w-full">
            <div class="flex items-center gap-3">
                <!-- æ ‡é¢˜ -->
                <h1 onclick="resetGame()" class="cursor-pointer select-none" title="ç‚¹å‡»é‡ç½®">
                    ä¹å®«æ ¼æ•°å­¦æ¢é™©
                </h1>
                <!-- æ˜Ÿæ˜Ÿå¼€å…³ -->
                <button id="toggle-star-btn" onclick="toggleStarMode()"
                    class="rounded-full flex items-center justify-center transition active-scale shadow-sm"
                    style="width: 2rem; height: 2rem; background-color: var(--yellow-200); border: none; color: var(--yellow-800); font-size: 1rem;">
                    â­ï¸
                </button>
            </div>
            <div class="flex items-center gap-3">
                <!-- æç¤ºè¯­ -->
                <p id="instruction-text" class="opacity-0"></p>
            </div>



            <!-- é­”æ³•å¼€å…³ -->
            <button id="toggle-mode-btn" onclick="toggleMode()"
                class="rounded-full flex items-center justify-center transition active-scale shadow-sm">
                <span style="font-size: 1.25rem;">ğŸª„</span>
            </button>
        </div>

        <!-- æ•°å­—ä»“åº“åŒºåŸŸ -->
        <div class="number-bank-container rounded-xl shadow-inner relative flex flex-wrap justify-center gap-3">
            <div id="number-bank" class="flex flex-wrap justify-center gap-3 w-full">
                <!-- JSç”Ÿæˆ -->
            </div>
        </div>
    </header>

    <!-- ä¸»æ¸¸æˆåŒº -->
    <main>

        <!-- ç½‘æ ¼å®¹å™¨ -->
        <div class="game-container">

            <!-- èƒŒæ™¯è£…é¥° -->
            <div class="absolute inset-0 bg-deco-1 rounded-3xl shadow-lg"></div>
            <div class="absolute inset-0 bg-deco-2 rounded-3xl shadow-inner"></div>

            <!-- 3x3 å®é™…ç½‘æ ¼ (z-10) -->
            <div class="grid-board absolute inset-0">
                <!-- æ ¼å­ 0-8 -->
                <div class="cell cursor-pointer" onclick="handleCellClick(0)"></div>
                <div class="cell cursor-pointer" onclick="handleCellClick(1)"></div>
                <div class="cell cursor-pointer" onclick="handleCellClick(2)"></div>

                <div class="cell cursor-pointer" onclick="handleCellClick(3)"></div>
                <div class="cell cursor-pointer" onclick="handleCellClick(4)"></div>
                <div class="cell cursor-pointer" onclick="handleCellClick(5)"></div>

                <div class="cell cursor-pointer" onclick="handleCellClick(6)"></div>
                <div class="cell cursor-pointer" onclick="handleCellClick(7)"></div>
                <div class="cell cursor-pointer" onclick="handleCellClick(8)"></div>
            </div>

            <!-- ç»“æœæ°”æ³¡è¦†ç›–å±‚ (z-20) -->
            <!-- 1. åˆ—æ°”æ³¡è¦†ç›–å±‚ -->
            <div class="bubble-overlay absolute inset-0 grid-cols-3">
                <div class="relative h-full">
                    <div id="sum-c0" class="hidden bubble pos-col"></div>
                </div>
                <div class="relative h-full">
                    <div id="sum-c1" class="hidden bubble pos-col"></div>
                </div>
                <div class="relative h-full">
                    <div id="sum-c2" class="hidden bubble pos-col"></div>
                </div>
            </div>

            <!-- 2. è¡Œæ°”æ³¡è¦†ç›–å±‚ -->
            <div class="bubble-overlay absolute inset-0 grid-rows-3">
                <div class="relative w-full">
                    <div id="sum-r0" class="hidden bubble pos-row"></div>
                </div>
                <div class="relative w-full">
                    <div id="sum-r1" class="hidden bubble pos-row"></div>
                </div>
                <div class="relative w-full">
                    <div id="sum-r2" class="hidden bubble pos-row"></div>
                </div>
            </div>

        </div>
    </main>

    <!-- èƒœåˆ©å¼¹çª— -->
    <div id="win-modal" class="modal-overlay hidden">
        <div class="modal-content shadow-lg pop-in">
            <div class="celebration" style="font-size: 4.5rem; margin-bottom: 1rem;">ğŸ†</div>
            <h2 style="font-size: 2.25rem; font-weight: 700; color: var(--emerald-600); margin: 0 0 0.5rem 0;">æŒ‘æˆ˜æˆåŠŸï¼
            </h2>
            <p style="color: var(--gray-600); margin-bottom: 2rem; font-size: 1.25rem;">ä½ çœŸæ˜¯ä¸ªæ•°å­¦å°å¤©æ‰ï¼</p>
            <div class="flex justify-center">
                <button onclick="closeWinModal()" class="btn-primary">
                    å†ç©ä¸€æ¬¡
                </button>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        let isSimpleMode = false; // é»˜è®¤å¤§æ•°å­—
        let isStarMode = false; // 1-9 æ¨¡å¼
        let selectedNumber = null; // å½“å‰æ‰‹æŒçš„æ•°å­— (æ¨¡å¼1: å…ˆé€‰æ•°å­—)
        let selectedCellIndex = null; // å½“å‰é€‰ä¸­çš„ç©ºç™½æ ¼å­ (æ¨¡å¼2: å…ˆé€‰æ ¼å­)
        let boardState = Array(9).fill(null);
        let hintTimer = null;

        const baseNumbers = [0, 1, 2, 3, 4, 5, 6, 7, 8];

        // DOM Elements
        const numberBankEl = document.getElementById('number-bank');
        const cells = document.querySelectorAll('.cell');
        const instructionText = document.getElementById('instruction-text');

        function init() {
            renderBank();
            updateModeUI();
            renderBoard();
        }

        function renderBank() {
            numberBankEl.innerHTML = '';
            baseNumbers.forEach(num => {
                if (boardState.includes(num)) return;

                let val;
                if (isStarMode) {
                    val = num + 1;
                } else {
                    val = isSimpleMode ? num : num + 150;
                }
                const btn = document.createElement('div');

                // åŸºç¡€æ ·å¼
                btn.className = "number-card cursor-pointer select-none";

                // é¢œè‰²æ ·å¼
                if (num % 2 === 0) {
                    btn.classList.add('card-even');
                } else {
                    btn.classList.add('card-odd');
                }

                if (selectedNumber === num) {
                    btn.classList.add('selected');
                }

                btn.textContent = val;
                btn.onclick = () => selectNumber(num);
                numberBankEl.appendChild(btn);
            });
        }

        function renderBoard() {
            cells.forEach((cell, index) => {
                const val = boardState[index];

                // æ¸…é™¤æ‰€æœ‰åŠ¨æ€ç±»
                cell.className = 'cell cursor-pointer';
                cell.textContent = '';

                if (val !== null) {
                    let displayVal;
                    if (isStarMode) {
                        displayVal = val + 1;
                    } else {
                        displayVal = isSimpleMode ? val : val + 150;
                    }
                    cell.textContent = displayVal;

                    cell.classList.add('cell-filled', 'shadow-md');

                    if (val % 2 === 0) {
                        cell.classList.add('text-blue-800');
                    } else {
                        cell.classList.add('text-orange-800');
                    }

                } else if (index === selectedCellIndex) {
                    cell.classList.add('cell-waiting');

                } else {
                    cell.classList.add('cell-empty');
                }
            });
            calculateSums();
            renderBank();
            updateControlVisibility();
        }

        function updateControlVisibility() {
            const wandBtn = document.getElementById('toggle-mode-btn');
            const starBtn = document.getElementById('toggle-star-btn');

            if (isStarMode) {
                wandBtn.classList.add('hidden');
                // Active state for star button
                starBtn.style.transform = "scale(1.1)";
                starBtn.style.boxShadow = "0 0 10px var(--yellow-800)";
            } else {
                wandBtn.classList.remove('hidden');
                starBtn.style.transform = "";
                starBtn.style.boxShadow = "";
            }
        }

        function selectNumber(num) {
            if (selectedCellIndex !== null) {
                fillCell(selectedCellIndex, num);
                selectedCellIndex = null;
                return;
            }

            if (selectedNumber === num) {
                selectedNumber = null;
            } else {
                selectedNumber = num;
                if (navigator.vibrate) navigator.vibrate(10);
            }
            renderBoard();
        }

        function handleCellClick(index) {
            if (boardState[index] !== null) {
                boardState[index] = null;
                selectedCellIndex = null;
                renderBoard();
                if (navigator.vibrate) navigator.vibrate(20);
                return;
            }

            if (selectedNumber !== null) {
                fillCell(index, selectedNumber);
                selectedNumber = null;
                return;
            }

            if (selectedCellIndex === index) {
                selectedCellIndex = null;
            } else {
                selectedCellIndex = index;
                if (navigator.vibrate) navigator.vibrate(10);
            }
            renderBoard();
        }

        function fillCell(index, num) {
            boardState[index] = num;
            const cell = cells[index];
            cell.classList.remove('pop-in');
            void cell.offsetWidth;
            cell.classList.add('pop-in');
            renderBoard();
            checkWin();
            if (navigator.vibrate) navigator.vibrate(30);
        }

        function toggleMode() {
            isSimpleMode = !isSimpleMode;
            updateModeUI();
            renderBoard();
        }

        function toggleStarMode() {
            isStarMode = !isStarMode;
            resetGame(); // åˆ‡æ¢æ¨¡å¼æ—¶é‡ç½®
        }

        function updateModeUI() {
            if (isSimpleMode) {
                document.body.style.backgroundColor = '#ECFDF5';
            } else {
                document.body.style.backgroundColor = '#EEF2FF';
            }
        }

        function showHint() {
            const centerCell = cells[4];
            centerCell.style.backgroundColor = '#FDE68A';

            if (boardState[4] === null) {
                // ç§»é™¤è¾¹æ¡†æ ·å¼ä»¥æ˜¾ç¤ºçº¯è‰²èƒŒæ™¯ (é€šè¿‡å†…è”æ ·å¼è¦†ç›–æˆ–CSS)
                centerCell.style.border = "4px solid #FDE68A";
            }

            const targetNum = 4;
            let displayNum;
            if (isStarMode) {
                displayNum = 5;
            } else {
                displayNum = isSimpleMode ? 4 : 154;
            }

            let hintMsg = "";
            if (!boardState.includes(4)) {
                hintMsg = `æç¤ºï¼šæŠŠ ${displayNum} æ”¾ä¸­é—´`;
                const bankItems = numberBankEl.children;
                for (let item of bankItems) {
                    if (parseInt(item.textContent) === displayNum) {
                        item.classList.add('celebration');
                        setTimeout(() => item.classList.remove('celebration'), 1000);
                    }
                }
            } else if (boardState[4] !== 4) {
                hintMsg = `ä¸­é—´å¥½åƒä¸å¯¹å“¦`;
            } else {
                hintMsg = `ä¸­é—´æ­£ç¡®ï¼`;
            }

            instructionText.textContent = hintMsg;
            instructionText.classList.remove('opacity-0');

            if (hintTimer) clearTimeout(hintTimer);
            hintTimer = setTimeout(() => {
                instructionText.classList.add('opacity-0');
            }, 3000);

            setTimeout(() => {
                if (boardState[4] === null) {
                    centerCell.style.backgroundColor = '';
                    centerCell.style.border = '';
                } else {
                    centerCell.style.backgroundColor = '';
                }
                renderBoard();
            }, 2000);
        }

        function calculateSums() {
            let target;
            if (isStarMode) {
                target = 15;
            } else {
                target = isSimpleMode ? 12 : 462;
            }
            const grid = boardState;

            const lines = [
                { id: 'sum-r0', idx: [0, 1, 2] },
                { id: 'sum-r1', idx: [3, 4, 5] },
                { id: 'sum-r2', idx: [6, 7, 8] },
                { id: 'sum-c0', idx: [0, 3, 6] },
                { id: 'sum-c1', idx: [1, 4, 7] },
                { id: 'sum-c2', idx: [2, 5, 8] }
            ];

            lines.forEach(line => {
                const el = document.getElementById(line.id);
                const values = line.idx.map(i => grid[i]);

                if (values.every(v => v !== null)) {
                    let sum = values.reduce((a, b) => a + b, 0);
                    if (isStarMode) {
                        sum += 3; // æ¯ä¸ªæ•°+1ï¼Œ3ä¸ªæ•°+3
                    } else if (!isSimpleMode) {
                        sum += (150 * 3);
                    }

                    el.textContent = sum;
                    el.classList.remove('hidden');

                    // æ¸…é™¤ä¹‹å‰çš„çŠ¶æ€ç±»
                    el.classList.remove('bubble-correct', 'bubble-wrong');

                    if (sum === target) {
                        el.classList.add('bubble-correct', 'bubble-pop');
                    } else {
                        el.classList.add('bubble-wrong', 'bubble-pop');
                    }

                } else {
                    el.classList.add('hidden');
                }
            });
        }

        function checkWin() {
            if (boardState.includes(null)) return;

            const target = 12;
            const lines = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8],
                [0, 3, 6], [1, 4, 7], [2, 5, 8],
                [0, 4, 8], [2, 4, 6]
            ];

            const isWin = lines.every(line => {
                const sum = boardState[line[0]] + boardState[line[1]] + boardState[line[2]];
                return sum === target;
            });

            if (isWin) {
                setTimeout(() => {
                    document.getElementById('win-modal').classList.remove('hidden');
                    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                }, 500);
            }
        }

        function closeWinModal() {
            document.getElementById('win-modal').classList.add('hidden');
        }

        function resetGame() {
            boardState = Array(9).fill(null);
            selectedNumber = null;
            selectedCellIndex = null;
            renderBoard();
            document.getElementById('win-modal').classList.add('hidden');
            if (navigator.vibrate) navigator.vibrate(10);
        }

        init();
    </script>
</body>

</html>