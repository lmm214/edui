{{ define "home-menu" }}
        {{ range .Site.Data.links.list }}
                    {{if .sub}}
                    <li class="has-sub">
                        <a>
                            <i class="{{.css}}"></i>
                            <span class="title">{{.tag}}</span>
                        </a>
                        <ul>
                            {{range .sub}}
                            <li>
                                <a href="javascript:" class="smooth" data-tag="#{{.tag}}">
                                    <i class="{{.css}}"></i>
                                    <span class="title">{{.tag}}</span>
                                </a>
                            </li>
                            {{ end }}
                        </ul>
                    </li>
                    {{ else }}
                    <li>
                        <a href="javascript:" class="smooth" data-tag="#{{.tag}}">
                            <i class="{{.css}}"></i>
                            <span class="title">{{.tag}}</span>
                        </a>
                    </li>
                    {{ end }}
                    {{ end }}
{{ end }}

{{ define "navbar" }}
<nav class="navbar user-info-navbar" role="navigation">
    <ul class="user-info-menu left-links list-inline list-unstyled">
        <li class="hidden-sm hidden-xs">
            <a href="javascript:void 0;" data-toggle="sidebar">
                <i class="icon-bar"></i>
            </a>
        </li>
    </ul>
</nav>
{{ end }}

{{ define "main" }}
            <!-- 搜索框 start -->
            <div class="search-container">
                <input type="text" id="searchInput" class="form-control" placeholder="搜索名称、描述...">
            </div>
            <!-- 搜索结果 start -->
            <div id="searchResults" style="display: none;">
                <h4 class="text-gray"><i class="icon-search"></i> 搜索结果</h4>
                <div class="row" id="searchResultsContainer"></div>
                <br/>
            </div>
            <!-- 搜索结果 end -->
            
            <!-- 原始内容容器 -->
            <div id="originalContent">
                <!-- 最近使用 start -->
                <div id="recordALL">
                    <h4 class="text-gray"><i class="icon-fire" style="margin-right: 7px;" id="最近使用"></i>最近使用
                    </h4>
                    <div class="row">
                        <div id="recordItems"></div>
                    </div>
                </div>
                <br/>
            <!-- 最近使用 end -->
            {{ range .Site.Data.links.list }}
            {{if .sub}}
            {{range .sub}}
            {{ $sub := .tag }}
            <h4 class="text-gray"><i class="{{.css}}" style="margin-right: 7px;" id="{{.tag}}"></i>{{.tag}}
            {{ if eq .tag "课中互动" }}
            <span id="cate-filter-bar" style="margin-top:10px;display:block;line-height:4rem;"></span>
            {{ end }}
            </h4>
            <div class="sub-content" data-subid="{{.tag}}">
            <div class="row">
                {{range .item}}
                {{if .siteSnip}}
                <div class="col-sm-3">
                    <div class="xe-widget xe-conversations card-style label-info box2" onclick="window.open('{{.siteLink}}', '_blank')" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="{{.siteLink}}" {{ if eq $sub "课中互动" }}data-cate='{{ .siteCate | jsonify }}'{{ end }}>
                        <div class="card-image">
                            <img data-src="{{.siteSnip}}" class="lozad card-preview" alt="{{.siteName}}">
                            {{ if eq $sub "课中互动" }}
                            {{ $labels := dict "syds" "数与代数" "txjh" "图形与几何" "tjgl" "统计与概率" "zhsj" "综合与实践" "other" "其它" "1a" "一上" "1b" "一下" "2a" "二上" "2b" "二下" "3a" "三上" "3b" "三下" "4a" "四上" "4b" "四下" "5a" "五上" "5b" "五下" "6a" "六上" "6b" "六下" }}
                            {{ $isSubject := dict "syds" true "txjh" true "tjgl" true "zhsj" true "other" true }}
                            {{ $isGrade := dict "1a" true "1b" true "2a" true "2b" true "3a" true "3b" true "4a" true "4b" true "5a" true "5b" true "6a" true "6b" true }}
                            {{ $c := .siteCate }}
                            {{ $t := printf "%T" $c }}
                            <div class="cate-badges cate-badges-left">
                                {{ if or (eq $t "[]string") (eq $t "[]interface {}") }}
                                    {{ range $c }}
                                        {{ $keyStr := printf "%v" . }}
                                        {{ if (index $isSubject $keyStr) }}
                                            {{ with (index $labels $keyStr) }}<span class="cate-chip">{{ . }}</span>{{ else }}<span class="cate-chip">{{ $keyStr }}</span>{{ end }}
                                        {{ end }}
                                    {{ end }}
                                {{ else }}
                                    {{ $key := printf "%v" $c }}
                                    {{ if (index $isSubject $key) }}
                                        {{ with (index $labels $key) }}<span class="cate-chip">{{ . }}</span>{{ else }}<span class="cate-chip">{{ $key }}</span>{{ end }}
                                    {{ end }}
                                {{ end }}
                            </div>
                            <div class="cate-badges cate-badges-right">
                                {{ if or (eq $t "[]string") (eq $t "[]interface {}") }}
                                    {{ range $c }}
                                        {{ $keyStr := printf "%v" . }}
                                        {{ if (index $isGrade $keyStr) }}
                                            {{ with (index $labels $keyStr) }}<span class="cate-chip">{{ . }}</span>{{ else }}<span class="cate-chip">{{ $keyStr }}</span>{{ end }}
                                        {{ end }}
                                    {{ end }}
                                {{ else }}
                                    {{ $key := printf "%v" $c }}
                                    {{ if (index $isGrade $key) }}
                                        {{ with (index $labels $key) }}<span class="cate-chip">{{ . }}</span>{{ else }}<span class="cate-chip">{{ $key }}</span>{{ end }}
                                    {{ end }}
                                {{ end }}
                            </div>
                            {{ end }}
                        </div>
                        <div class="card-content">
                            <div class="card-header">
                                <div class="card-title">
                                    <strong class="overflowClip_1">{{.siteName}}</strong>
                                </div>
                            </div>
                            <p class="card-description overflowClip_1">{{.description}}</p>
                        </div>
                    </div>
                </div>
                {{ end }}
                {{ end }}
            </div>
            <!-- 普通样式项目 -->
            <div class="row">
                {{range .item}}
                {{if not .siteSnip}}
                <div class="col-sm-3">
                    {{if .siteImage}}
                    <div class="xe-widget xe-conversations box2 label-info" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="<img src='{{.siteImage}}' width='148'>" {{ if eq $sub "课中互动" }}data-cate='{{ .siteCate | jsonify }}'{{ end }}>
                    {{ else }}
                    <div class="xe-widget xe-conversations box2 label-info" onclick="window.open('{{.siteLink}}', '_blank')" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="{{.siteLink}}" {{ if eq $sub "课中互动" }}data-cate='{{ .siteCate | jsonify }}'{{ end }}>
                    {{ end }}
                        <div class="xe-comment-entry">
                            <a class="xe-user-img">
                                {{if .siteLogo}}
                                    <img data-src="{{.siteLogo}}"  class="lozad img-circle" width="40" height="40">
                                {{ else }}
                                    <img avatar="{{.siteName}}"  class="lozad img-circle" width="40" height="40">
                                {{ end }}    
                            </a>
                            <div class="xe-comment">
                                <a href="javascript:void 0;" class="xe-user-name overflowClip_1">
                                    <strong>{{.siteName}}</strong>
                                </a>
                                <p class="overflowClip_2">{{.description}}</p>
                            </div>
                        </div>
                    </div>
                </div>
                {{ end }}
                {{ end }}
            </div>
            </div>
            <br />
            {{end}}
            {{ else }}
            <h4 class="text-gray"><i class="{{.css}}" style="margin-right: 7px;" id="{{.tag}}"></i>{{.tag}}
            </h4>
            <!-- 卡片样式项目 -->
            <div class="row">
                {{range .item }}
                {{if .siteSnip}}
                <div class="col-sm-3">
                    <div class="xe-widget xe-conversations card-style label-info box2" onclick="window.open('{{.siteLink}}', '_blank')" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="{{.siteLink}}">
                        <div class="card-image">
                            <img data-src="{{.siteSnip}}" class="lozad card-preview" alt="{{.siteName}}">
                        </div>
                        <div class="card-content">
                            <div class="card-header">
                                <div class="card-title">
                                    <strong class="overflowClip_1">{{.siteName}}</strong>
                                </div>
                            </div>
                            <p class="card-description overflowClip_1">{{.description}}</p>
                        </div>
                    </div>
                </div>
                {{ end }}
                {{ end }}
            </div>
            <!-- 普通样式项目 -->
            <div class="row">
                {{range .item }}
                {{if not .siteSnip}}
                <div class="col-sm-3">
                    {{if .siteImage}}
                    <div class="xe-widget xe-conversations box2 label-info" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="<img src='{{.siteImage}}' width='148'>">
                    {{ else }}
                    <div class="xe-widget xe-conversations box2 label-info" onclick="window.open('{{.siteLink}}', '_blank')" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="{{.siteLink}}">
                    {{ end }}
                        <div class="xe-comment-entry">
                            <a class="xe-user-img">
                                {{if .siteLogo}}
                                <img data-src="{{.siteLogo}}"  class="lozad img-circle" width="40" height="40">
                                {{ else }}
                                <img avatar="{{.siteName}}"  class="lozad img-circle" width="40" height="40">
                                {{ end }}
                            </a>
                            <div class="xe-comment">
                                <a href="javascript:void 0;" class="xe-user-name overflowClip_1">
                                    <strong>{{.siteName}}</strong>
                                </a>
                                <p class="overflowClip_2">{{.description}}</p>
                            </div>
                        </div>
                    </div>
                </div>
                {{ end }}
                {{ end }}
            </div>
            {{ end }}
            <br />
            {{ end }}
            </div>
            <!-- 原始内容容器结束 -->
{{ end }}


{{ define "footer" }}
<script src="js/jquery-1.11.1.min.js"></script>
<!-- 搜索功能 -->
<script type="text/javascript">
// 准备搜索数据
var searchData = [];
var linksData = null;

// 从 JSON 文件加载数据
function loadLinksData(callback) {
    $.getJSON('/data/links.json')
        .done(function(data) {
            linksData = data;
            // 构建搜索数据
            searchData = [];
            if (data.list) {
                data.list.forEach(function(category) {
                    if (category.sub) {
                        // 有子分类的情况
                        category.sub.forEach(function(subCategory) {
                            if (subCategory.item) {
                                subCategory.item.forEach(function(item) {
                                    searchData.push({
                                        siteName: item.siteName || '',
                                        description: item.description || '',
                                        siteLink: item.siteLink || '',
                                        siteLogo: item.siteLogo || '',
                                        siteImage: item.siteImage || '',
                                        siteSnip: item.siteSnip || ''
                                    });
                                });
                            }
                        });
                    } else if (category.item) {
                        // 没有子分类的情况
                        category.item.forEach(function(item) {
                            searchData.push({
                                siteName: item.siteName || '',
                                description: item.description || '',
                                siteLink: item.siteLink || '',
                                siteLogo: item.siteLogo || '',
                                siteImage: item.siteImage || '',
                                siteSnip: item.siteSnip || ''
                            });
                        });
                    }
                });
            }
            if (callback) callback();
        })
        .fail(function() {
            console.error('无法加载链接数据');
        });
}

// 搜索功能
function performSearch(query) {
    if (!query || query.trim() === '') {
        $('#searchResults').hide();
        $('#originalContent').show();
        return;
    }
    
    query = query.toLowerCase();
    var results = searchData.filter(function(item) {
        return item.siteName.toLowerCase().includes(query) ||
               item.description.toLowerCase().includes(query);
    });
    
    displaySearchResults(results);
}

function displaySearchResults(results) {
    var container = $('#searchResultsContainer');
    container.empty();
    
    if (results.length === 0) {
        container.html('<div class="col-sm-12"><p class="text-muted">未找到匹配的结果</p></div>');
    } else {
        // 分离卡片样式和普通样式的项目
        var cardItems = results.filter(function(item) { return item.siteSnip; });
        var normalItems = results.filter(function(item) { return !item.siteSnip; });
        
        // 先显示卡片样式项目
        if (cardItems.length > 0) {
            var cardRow = $('<div class="row"></div>');
            cardItems.forEach(function(item) {
                var cardHtml = '<div class="col-sm-3">';
                cardHtml += '<div class="xe-widget xe-conversations card-style label-info box2" onclick="window.open(\'' + item.siteLink + '\', \'_blank\')" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="' + item.siteLink + '">';
                cardHtml += '<div class="card-image">';
                cardHtml += '<img data-src="' + item.siteSnip + '" class="lozad card-preview" alt="' + item.siteName + '">';
                cardHtml += '</div>';
                cardHtml += '<div class="card-content">';
                cardHtml += '<div class="card-header">';
                cardHtml += '<div class="card-title">';
                cardHtml += '<strong class="overflowClip_1">' + item.siteName + '</strong>';
                cardHtml += '</div>';
                cardHtml += '</div>';
                cardHtml += '<p class="card-description overflowClip_1">' + item.description + '</p>';
                cardHtml += '</div>';
                cardHtml += '</div>';
                cardHtml += '</div>';
                cardRow.append(cardHtml);
            });
            container.append(cardRow);
        }
        
        // 再显示普通样式项目
        if (normalItems.length > 0) {
            if (cardItems.length > 0) {
                container.append('<div class="col-sm-12"><h5 class="text-muted">其他项目</h5></div>');
            }
            var normalRow = $('<div class="row"></div>');
            normalItems.forEach(function(item) {
                var cardHtml = '<div class="col-sm-3">';
                if (item.siteImage) {
                    cardHtml += '<div class="xe-widget xe-conversations box2 label-info" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="<img src=\'' + item.siteImage + '\' width=\'148\'>">';
                } else {
                    cardHtml += '<div class="xe-widget xe-conversations box2 label-info" onclick="window.open(\'' + item.siteLink + '\', \'_blank\')" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="' + item.siteLink + '">';
                }
                
                cardHtml += '<div class="xe-comment-entry">';
                cardHtml += '<a class="xe-user-img">';
                
                if (item.siteLogo) {
                    cardHtml += '<img data-src="' + item.siteLogo + '" class="lozad img-circle" width="40" height="40">';
                } else {
                    cardHtml += '<img avatar="' + item.siteName + '" class="img-circle" width="40" height="40">';
                }
                
                cardHtml += '</a>';
                cardHtml += '<div class="xe-comment">';
                cardHtml += '<a href="javascript:void 0;" class="xe-user-name overflowClip_1">';
                cardHtml += '<strong>' + item.siteName + '</strong>';
                cardHtml += '</a>';
                cardHtml += '<p class="overflowClip_2">' + item.description + '</p>';
                cardHtml += '</div>';
                cardHtml += '</div>';
                cardHtml += '</div>';
                cardHtml += '</div>';
                
                normalRow.append(cardHtml);
            });
            container.append(normalRow);
        }
    }
    
    $('#originalContent').hide();
    $('#searchResults').show();
    
    // 重新初始化图片懒加载
    const observer = lozad();
    observer.observe();
    
    // 初始化LetterAvatar为没有logo的网站生成字母头像
    if (typeof LetterAvatar !== 'undefined') {
        LetterAvatar.transform();
    }
    
    // 重新绑定点击事件
    $('#searchResultsContainer .xe-widget').off('click').on('click', function(){
        var itemclick = $(this).attr('data-original-title');
        if (itemclick && !itemclick.startsWith('<img')) {
            var dataClick = JSON.parse(localStorage.getItem(myStorage)) || [];
            var indexNum = dataClick.indexOf(itemclick);
            if(indexNum >= 0 ){
                dataClick.splice(indexNum,1);
            }
            if(dataClick.length == 8 ){
                dataClick.shift();
            }
            dataClick.push(itemclick);
            localStorage.setItem(myStorage, JSON.stringify(dataClick));
        }
    });
}

function clearSearch() {
    $('#searchInput').val('');
    $('#searchResults').hide();
    $('#originalContent').show();
}

// 绑定搜索事件
$(document).ready(function() {
    // 先加载链接数据，然后绑定搜索事件
    loadLinksData(function() {
        $('#searchInput').on('input', function() {
            var query = $(this).val();
            performSearch(query);
        });
        
        $('#searchInput').on('keypress', function(e) {
            if (e.which === 13) { // Enter键
                e.preventDefault();
                var query = $(this).val();
                performSearch(query);
            }
        });
    });
});
</script>
<!-- 锚点平滑移动 -->
<script type="text/javascript">
$(document).ready(function() {
     //img lazy loaded
     const observer = lozad();observer.observe();
    $(document).on('click', '.has-sub', function(){
        var _this = $(this)
        if(!$(this).hasClass('expanded')) {
           setTimeout(function(){
                _this.find('ul').attr("style","")
           }, 300);
          
        } else {
            $('.has-sub ul').each(function(id,ele){
                var _that = $(this)
                if(_this.find('ul')[0] != ele) {
                    setTimeout(function(){
                        _that.attr("style","")
                    }, 300);
                }
            })
        }
    })
    $('.user-info-menu .hidden-sm').click(function(){
        if($('.sidebar-menu').hasClass('collapsed')) {
            $('.has-sub.expanded > ul').attr("style","")
        } else {
            $('.has-sub.expanded > ul').show()
        }
    })
    $("#main-menu li ul li").click(function() {
        $(this).siblings('li').removeClass('active'); // 删除其他兄弟元素的样式
        $(this).addClass('active'); // 添加当前元素的样式
    });
    $("a.smooth").click(function(ev) {
        ev.preventDefault();
        public_vars.$mainMenu.add(public_vars.$sidebarProfile).toggleClass('mobile-is-visible');
        ps_destroy();
        $("html, body").animate({
            scrollTop: $($(this).attr("data-tag")).offset().top - 30
        }, {
            duration: 500,
            easing: "swing"
        });
    });
    return false;
});

var href = "";
var pos = 0;
$("a.smooth").click(function(e) {
    $("#main-menu li").each(function() {
        $(this).removeClass("active");
    });
    $(this).parent("li").addClass("active");
    e.preventDefault();
    href = $(this).attr("data-tag");
    pos = $(href).position().top - 30;
});

//浏览记录
var myStorage = 'webstack-'+window.location.hostname.replace(/\./g,'-');//'edui123'
var myStorageData = JSON.parse(localStorage.getItem(myStorage)) || [];
if(myStorageData.length == 0 ){
    localStorage.setItem(myStorage, '[]');
}else if(myStorageData.length > 0){
    $('#recordALL').attr("style","display:block")
    $.each(myStorageData, function(index, value) {
        $('[data-original-title="'+value+'"]').clone(true).prependTo('#recordItems').wrap('<div class="col-sm-3"></div>');
    });
}
$(".xe-widget").on("click", function(){
    var itemclick = $(this).attr("data-original-title")
    var dataClick = JSON.parse(localStorage.getItem(myStorage))
    var indexNum = dataClick.indexOf(itemclick)
    if(indexNum >= 0 ){
        dataClick.splice(indexNum,1)
    }
    if(dataClick.length == 8 ){
        dataClick.shift()
    }
    dataClick.push(itemclick);
    localStorage.setItem(myStorage, JSON.stringify(dataClick));
})
</script>	
<!-- Bottom Scripts -->

<script src="/js/bootstrap.min.js"></script>
<script src="/js/TweenMax.min.js"></script>
<script src="/js/resizeable.js"></script>
<script src="/js/xenon-toggle.js"></script>
<script src="/js/xenon-custom.js"></script>
<script src="/js/lozad.js"></script>
<script src="/js/LetterAvatar.js"></script>
<script type="text/javascript">
$(function(){
    function parseCats(str){
        var out = [];
        try {
            var parsed = JSON.parse(str);
            if (Array.isArray(parsed)) {
                for (var i=0;i<parsed.length;i++){ out.push(String(parsed[i])); }
                return out;
            } else if (typeof parsed === 'string') {
                return [parsed];
            }
        } catch(e) {}
        var arr = (str || '').split(',');
        for(var i=0;i<arr.length;i++){ var s = arr[i].replace(/^\s+|\s+$/g,''); if(s){ out.push(s); } }
        return out;
    }
    function buildFilters(){
        var container = $('.sub-content[data-subid="课中互动"]');
        var cards = container.find('.col-sm-3');
        var total = cards.length;
        var counts = {};
        cards.each(function(){
            var c = $(this).find('.xe-widget').attr('data-cate');
            var categories = parseCats(c);
            for(var i=0;i<categories.length;i++){
                var k = String(categories[i]);
                counts[k] = (counts[k] || 0) + 1;
            }
        });
        var labels = {
            all:'全部', syds:'数与代数', txjh:'图形与几何', tjgl:'统计与概率', zhsj:'综合与实践', houke:'候课', xiti:'习题', other:'其它',
            '1a':'一上','1b':'一下','2a':'二上','2b':'二下','3a':'三上','3b':'三下','4a':'四上','4b':'四下','5a':'五上','5b':'五下','6a':'六上','6b':'六下'
        };
        var group1 = ['all','syds','txjh','tjgl','zhsj','houke','xiti','other'];
        var group2 = ['1a','1b','2a','2b','3a','3b','4a','4b','5a','5b','6a','6b'];
        var html = '';
        for(var i=0;i<group1.length;i++){
            var k = group1[i];
            var n = (k === 'all' ? total : (counts[k] || 0));
            var text = labels[k] || k;
            html += '<a href="javascript:" class="cate-filter' + (k==='all' ? ' active' : '') + '" data-cate="' + k + '">' + text + '（' + n + '）</a>';
        }
        html += '<br/>';
        for(var j=0;j<group2.length;j++){
            var g = group2[j];
            var gn = counts[g] || 0;
            var gt = labels[g] || g;
            html += '<a href="javascript:" class="cate-filter" data-cate="' + g + '">' + gt + '（' + gn + '）</a>';
        }
        $('#cate-filter-bar').html(html);
    }
    function applyFilter(){
        var container = $('.sub-content[data-subid="课中互动"]');
        var activeCate = $('.cate-filter.active').attr('data-cate');
        if (!activeCate || activeCate === 'all') {
            container.find('.col-sm-3').show();
            return;
        }
        container.find('.col-sm-3').each(function(){
            var c = $(this).find('.xe-widget').attr('data-cate');
            var categories = parseCats(c);
            var ok = categories.indexOf(String(activeCate)) !== -1;
            $(this).toggle(ok);
        });
    }
    buildFilters();
    $(document).on('click', '.cate-filter', function(ev){
        ev.preventDefault();
        $('.cate-filter').removeClass('active');
        $(this).addClass('active');
        applyFilter();
    });
    applyFilter();
});
</script>
{{ end }}
